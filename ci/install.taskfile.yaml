# https://taskfile.dev

#Called by the vnbuild system to produce builds for my website
#https://www.vaughnnugent.com/resources/software

version: "3"

vars:
  _DELAY: '
    {{ if eq OS "windows" }}powershell "sleep -Milliseconds (Get-Random -Maximum 1000)"
    {{ else }}sleep 0.$((RANDOM % 1000))
    {{ end }}'
  
  _WGET: '{{ if eq OS "windows" }}powershell wget{{ else }}wget{{ end }}'

tasks:

  install:
    internal: true
    cmds:
    #make the plugin directory
    - cmd: '{{ ._MKDIR }} "{{ .DIR }}"'
    
    #random delay to prevent server overload
    - cmd: '{{ ._DELAY }}'

    - cmd: echo "Installing {{ .MODULE_NAME }} {{ .VERSION }}"
      silent: true

    - task: download
      vars:
        BASE_URL: '{{ .BUILDS_URL }}'
        MODULE_NAME: '{{ .MODULE_NAME }}'
        VERSION: '{{ .VERSION }}'
        PROJECT_NAME: '{{ .PROJECT_NAME }}'
        FILE_NAME: '{{ .FILE_NAME }}'
        DIR: '{{ .DIR }}'

    - cmd: cd {{ .DIR }} && tar -xzf {{ .FILE_NAME }}

    #remove the archive file
    - cmd: 'cd {{ .DIR }} && {{ ._RMF }} "{{ .FILE_NAME }}"'
    
    #remove all pckage.json files that could cause build issues
    - cmd: cd {{ .DIR }} && powershell 'Get-ChildItem -Path . -Recurse -File -Filter "package.json" | Remove-Item -Force'
      platforms: [ windows ]
      ignore_error: true

  download:
    internal: true
    vars:
      _URL: '{{ .BASE_URL }}/{{ .MODULE_NAME }}/{{ .VERSION }}/{{ .PROJECT_NAME }}/{{ .FILE_NAME }}'
      _HASH: 
        sh: 'curl{{ exeExt }} -sSL {{ ._URL }}.sha256'
    cmds:
     #invoke wget to download the file and write it to the file name
     - cmd: cd {{ .DIR }} && {{ ._WGET }} -O {{ .FILE_NAME }} {{ lower ._URL }}

     #check the hash of the file
     - cmd: cd {{ .DIR }} && powershell 'if ((Get-FileHash "{{ .FILE_NAME }}" -Algorithm SHA256).Hash -ne "{{ ._HASH }}") { exit 1 }'
       platforms: [ windows ]
     
    # - cmd: '[[ $(sha256sum "{{ .DIR }}/{{ .FILE_NAME }}" | awk "{print $1}") == "{{ ._HASH }}" ]]'
    #   platforms: [ linux, darwin ]

     - cmd: echo "Downloaded {{ .FILE_NAME }} with checksum {{ ._HASH }}"
       silent: true