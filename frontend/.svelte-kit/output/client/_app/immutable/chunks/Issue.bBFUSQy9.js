var ye=Object.defineProperty;var be=(e,t,n)=>t in e?ye(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var m=(e,t,n)=>be(e,typeof t!="symbol"?t+"":t,n);import{w as writable}from"./entry.vAbeKpqR.js";import{H as get_store_value}from"./scheduler.DrQRk8ea.js";const defaults={loading:!0,hexpubkey:"",npub:""};function getName(e,t=25){return truncate(e.profile?e.profile.name?e.profile.name:e.profile.displayName?e.profile.displayName:truncateNpub(e.npub):truncateNpub(e.npub),t)}function truncateNpub(e){return`${e.substring(0,9)}...`}function truncate(e,t=20){return e.length<t||t<5?e:`${e.substring(0,t-3)}...`}function number$3(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function bytes$3(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function hash$2(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$3(e.outputLen),number$3(e.blockLen)}function exists$2(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function output$2(e,t){bytes$3(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const crypto$3=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u8a$2=e=>e instanceof Uint8Array,createView$2=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),rotr$2=(e,t)=>e<<32-t|e>>>t,isLE$2=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE$2)throw new Error("Non little-endian hardware is not supported");function utf8ToBytes$4(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function toBytes$2(e){if(typeof e=="string"&&(e=utf8ToBytes$4(e)),!u8a$2(e))throw new Error(`expected Uint8Array, got ${typeof e}`);return e}function concatBytes$4(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!u8a$2(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}let Hash$2=class{clone(){return this._cloneInto()}};function wrapConstructor$2(e){const t=r=>e().update(toBytes$2(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function randomBytes$2(e=32){if(crypto$3&&typeof crypto$3.getRandomValues=="function")return crypto$3.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}function setBigUint64$2(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),o=BigInt(4294967295),a=Number(n>>s&o),c=Number(n&o),l=r?4:0,u=r?0:4;e.setUint32(t+l,a,r),e.setUint32(t+u,c,r)}let SHA2$1=class extends Hash$2{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=createView$2(this.buffer)}update(t){exists$2(this);const{view:n,buffer:r,blockLen:s}=this;t=toBytes$2(t);const o=t.length;for(let a=0;a<o;){const c=Math.min(s-this.pos,o-a);if(c===s){const l=createView$2(t);for(;s<=o-a;a+=s)this.process(l,a);continue}r.set(t.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){exists$2(this),output$2(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:o}=this;let{pos:a}=this;n[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>s-a&&(this.process(r,0),a=0);for(let h=a;h<s;h++)n[h]=0;setBigUint64$2(r,s-8,BigInt(this.length*8),o),this.process(r,0);const c=createView$2(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:o,destroyed:a,pos:c}=this;return t.length=s,t.pos=c,t.finished=o,t.destroyed=a,s%n&&t.buffer.set(r),t}};const Chi$2=(e,t,n)=>e&t^~e&n,Maj$2=(e,t,n)=>e&t^e&n^t&n,SHA256_K$2=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV$1=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$2=new Uint32Array(64);let SHA256$2=class extends SHA2$1{constructor(){super(64,32,8,!1),this.A=IV$1[0]|0,this.B=IV$1[1]|0,this.C=IV$1[2]|0,this.D=IV$1[3]|0,this.E=IV$1[4]|0,this.F=IV$1[5]|0,this.G=IV$1[6]|0,this.H=IV$1[7]|0}get(){const{A:t,B:n,C:r,D:s,E:o,F:a,G:c,H:l}=this;return[t,n,r,s,o,a,c,l]}set(t,n,r,s,o,a,c,l){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(t,n){for(let h=0;h<16;h++,n+=4)SHA256_W$2[h]=t.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W$2[h-15],b=SHA256_W$2[h-2],_=rotr$2(p,7)^rotr$2(p,18)^p>>>3,g=rotr$2(b,17)^rotr$2(b,19)^b>>>10;SHA256_W$2[h]=g+SHA256_W$2[h-7]+_+SHA256_W$2[h-16]|0}let{A:r,B:s,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr$2(c,6)^rotr$2(c,11)^rotr$2(c,25),b=f+p+Chi$2(c,l,u)+SHA256_K$2[h]+SHA256_W$2[h]|0,g=(rotr$2(r,2)^rotr$2(r,13)^rotr$2(r,22))+Maj$2(r,s,o)|0;f=u,u=l,l=c,c=a+b|0,a=o,o=s,s=r,r=b+g|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(r,s,o,a,c,l,u,f)}roundClean(){SHA256_W$2.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const sha256$2=wrapConstructor$2(()=>new SHA256$2);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$9=BigInt(0),_1n$9=BigInt(1),_2n$5=BigInt(2),u8a$1=e=>e instanceof Uint8Array,hexes$3=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function bytesToHex$3(e){if(!u8a$1(e))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=hexes$3[e[n]];return t}function numberToHexUnpadded$1(e){const t=e.toString(16);return t.length&1?`0${t}`:t}function hexToNumber$1(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return BigInt(e===""?"0":`0x${e}`)}function hexToBytes$3(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let r=0;r<n.length;r++){const s=r*2,o=e.slice(s,s+2),a=Number.parseInt(o,16);if(Number.isNaN(a)||a<0)throw new Error("Invalid byte sequence");n[r]=a}return n}function bytesToNumberBE$1(e){return hexToNumber$1(bytesToHex$3(e))}function bytesToNumberLE$1(e){if(!u8a$1(e))throw new Error("Uint8Array expected");return hexToNumber$1(bytesToHex$3(Uint8Array.from(e).reverse()))}function numberToBytesBE$1(e,t){return hexToBytes$3(e.toString(16).padStart(t*2,"0"))}function numberToBytesLE$1(e,t){return numberToBytesBE$1(e,t).reverse()}function numberToVarBytesBE$1(e){return hexToBytes$3(numberToHexUnpadded$1(e))}function ensureBytes$1(e,t,n){let r;if(typeof t=="string")try{r=hexToBytes$3(t)}catch(o){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${o}`)}else if(u8a$1(t))r=Uint8Array.from(t);else throw new Error(`${e} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function concatBytes$3(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!u8a$1(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}function equalBytes$2(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}function utf8ToBytes$3(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function bitLen$1(e){let t;for(t=0;e>_0n$9;e>>=_1n$9,t+=1);return t}function bitGet$1(e,t){return e>>BigInt(t)&_1n$9}const bitSet$1=(e,t,n)=>e|(n?_1n$9:_0n$9)<<BigInt(t),bitMask$1=e=>(_2n$5<<BigInt(e-1))-_1n$9,u8n$1=e=>new Uint8Array(e),u8fr$1=e=>Uint8Array.from(e);function createHmacDrbg$1(e,t,n){if(typeof e!="number"||e<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n$1(e),s=u8n$1(e),o=0;const a=()=>{r.fill(1),s.fill(0),o=0},c=(...h)=>n(s,r,...h),l=(h=u8n$1())=>{s=c(u8fr$1([0]),h),r=c(),h.length!==0&&(s=c(u8fr$1([1]),h),r=c())},u=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<t;){r=c();const b=r.slice();p.push(b),h+=r.length}return concatBytes$3(...p)};return(h,p)=>{a(),l(h);let b;for(;!(b=p(u()));)l();return a(),b}}const validatorFns$1={bigint:e=>typeof e=="bigint",function:e=>typeof e=="function",boolean:e=>typeof e=="boolean",string:e=>typeof e=="string",stringOrUint8Array:e=>typeof e=="string"||e instanceof Uint8Array,isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>typeof e=="function"&&Number.isSafeInteger(e.outputLen)};function validateObject$1(e,t,n={}){const r=(s,o,a)=>{const c=validatorFns$1[o];if(typeof c!="function")throw new Error(`Invalid validator "${o}", expected function`);const l=e[s];if(!(a&&l===void 0)&&!c(l,e))throw new Error(`Invalid param ${String(s)}=${l} (${typeof l}), expected ${o}`)};for(const[s,o]of Object.entries(t))r(s,o,!1);for(const[s,o]of Object.entries(n))r(s,o,!0);return e}const ut$1=Object.freeze(Object.defineProperty({__proto__:null,bitGet:bitGet$1,bitLen:bitLen$1,bitMask:bitMask$1,bitSet:bitSet$1,bytesToHex:bytesToHex$3,bytesToNumberBE:bytesToNumberBE$1,bytesToNumberLE:bytesToNumberLE$1,concatBytes:concatBytes$3,createHmacDrbg:createHmacDrbg$1,ensureBytes:ensureBytes$1,equalBytes:equalBytes$2,hexToBytes:hexToBytes$3,hexToNumber:hexToNumber$1,numberToBytesBE:numberToBytesBE$1,numberToBytesLE:numberToBytesLE$1,numberToHexUnpadded:numberToHexUnpadded$1,numberToVarBytesBE:numberToVarBytesBE$1,utf8ToBytes:utf8ToBytes$3,validateObject:validateObject$1},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$8=BigInt(0),_1n$8=BigInt(1),_2n$4=BigInt(2),_3n$3=BigInt(3),_4n$1=BigInt(4),_5n$1=BigInt(5),_8n$1=BigInt(8);BigInt(9);BigInt(16);function mod$1(e,t){const n=e%t;return n>=_0n$8?n:t+n}function pow$1(e,t,n){if(n<=_0n$8||t<_0n$8)throw new Error("Expected power/modulo > 0");if(n===_1n$8)return _0n$8;let r=_1n$8;for(;t>_0n$8;)t&_1n$8&&(r=r*e%n),e=e*e%n,t>>=_1n$8;return r}function pow2$1(e,t,n){let r=e;for(;t-- >_0n$8;)r*=r,r%=n;return r}function invert$1(e,t){if(e===_0n$8||t<=_0n$8)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=mod$1(e,t),r=t,s=_0n$8,o=_1n$8;for(;n!==_0n$8;){const c=r/n,l=r%n,u=s-o*c;r=n,n=l,s=o,o=u}if(r!==_1n$8)throw new Error("invert: does not exist");return mod$1(s,t)}function tonelliShanks$1(e){const t=(e-_1n$8)/_2n$4;let n,r,s;for(n=e-_1n$8,r=0;n%_2n$4===_0n$8;n/=_2n$4,r++);for(s=_2n$4;s<e&&pow$1(s,t,e)!==e-_1n$8;s++);if(r===1){const a=(e+_1n$8)/_4n$1;return function(l,u){const f=l.pow(u,a);if(!l.eql(l.sqr(f),u))throw new Error("Cannot find square root");return f}}const o=(n+_1n$8)/_2n$4;return function(c,l){if(c.pow(l,t)===c.neg(c.ONE))throw new Error("Cannot find square root");let u=r,f=c.pow(c.mul(c.ONE,s),n),h=c.pow(l,o),p=c.pow(l,n);for(;!c.eql(p,c.ONE);){if(c.eql(p,c.ZERO))return c.ZERO;let b=1;for(let g=c.sqr(p);b<u&&!c.eql(g,c.ONE);b++)g=c.sqr(g);const _=c.pow(f,_1n$8<<BigInt(u-b-1));f=c.sqr(_),h=c.mul(h,_),p=c.mul(p,f),u=b}return h}}function FpSqrt$1(e){if(e%_4n$1===_3n$3){const t=(e+_1n$8)/_4n$1;return function(r,s){const o=r.pow(s,t);if(!r.eql(r.sqr(o),s))throw new Error("Cannot find square root");return o}}if(e%_8n$1===_5n$1){const t=(e-_5n$1)/_8n$1;return function(r,s){const o=r.mul(s,_2n$4),a=r.pow(o,t),c=r.mul(s,a),l=r.mul(r.mul(c,_2n$4),a),u=r.mul(c,r.sub(l,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return tonelliShanks$1(e)}const FIELD_FIELDS$1=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField$1(e){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS$1.reduce((r,s)=>(r[s]="function",r),t);return validateObject$1(e,n)}function FpPow$1(e,t,n){if(n<_0n$8)throw new Error("Expected power > 0");if(n===_0n$8)return e.ONE;if(n===_1n$8)return t;let r=e.ONE,s=t;for(;n>_0n$8;)n&_1n$8&&(r=e.mul(r,s)),s=e.sqr(s),n>>=_1n$8;return r}function FpInvertBatch$1(e,t){const n=new Array(t.length),r=t.reduce((o,a,c)=>e.is0(a)?o:(n[c]=o,e.mul(o,a)),e.ONE),s=e.inv(r);return t.reduceRight((o,a,c)=>e.is0(a)?o:(n[c]=e.mul(o,n[c]),e.mul(o,a)),s),n}function nLength$1(e,t){const n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field$1(e,t,n=!1,r={}){if(e<=_0n$8)throw new Error(`Expected Field ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:o}=nLength$1(e,t);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const a=FpSqrt$1(e),c=Object.freeze({ORDER:e,BITS:s,BYTES:o,MASK:bitMask$1(s),ZERO:_0n$8,ONE:_1n$8,create:l=>mod$1(l,e),isValid:l=>{if(typeof l!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof l}`);return _0n$8<=l&&l<e},is0:l=>l===_0n$8,isOdd:l=>(l&_1n$8)===_1n$8,neg:l=>mod$1(-l,e),eql:(l,u)=>l===u,sqr:l=>mod$1(l*l,e),add:(l,u)=>mod$1(l+u,e),sub:(l,u)=>mod$1(l-u,e),mul:(l,u)=>mod$1(l*u,e),pow:(l,u)=>FpPow$1(c,l,u),div:(l,u)=>mod$1(l*invert$1(u,e),e),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>invert$1(l,e),sqrt:r.sqrt||(l=>a(c,l)),invertBatch:l=>FpInvertBatch$1(c,l),cmov:(l,u,f)=>f?u:l,toBytes:l=>n?numberToBytesLE$1(l,o):numberToBytesBE$1(l,o),fromBytes:l=>{if(l.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${l.length}`);return n?bytesToNumberLE$1(l):bytesToNumberBE$1(l)}});return Object.freeze(c)}function getFieldBytesLength$1(e){if(typeof e!="bigint")throw new Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function getMinHashLength$1(e){const t=getFieldBytesLength$1(e);return t+Math.ceil(t/2)}function mapHashToField$1(e,t,n=!1){const r=e.length,s=getFieldBytesLength$1(t),o=getMinHashLength$1(t);if(r<16||r<o||r>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${r}`);const a=n?bytesToNumberBE$1(e):bytesToNumberLE$1(e),c=mod$1(a,t-_1n$8)+_1n$8;return n?numberToBytesLE$1(c,s):numberToBytesBE$1(c,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$7=BigInt(0),_1n$7=BigInt(1);function wNAF$1(e,t){const n=(s,o)=>{const a=o.negate();return s?a:o},r=s=>{const o=Math.ceil(t/s)+1,a=2**(s-1);return{windows:o,windowSize:a}};return{constTimeNegate:n,unsafeLadder(s,o){let a=e.ZERO,c=s;for(;o>_0n$7;)o&_1n$7&&(a=a.add(c)),c=c.double(),o>>=_1n$7;return a},precomputeWindow(s,o){const{windows:a,windowSize:c}=r(o),l=[];let u=s,f=u;for(let h=0;h<a;h++){f=u,l.push(f);for(let p=1;p<c;p++)f=f.add(u),l.push(f);u=f.double()}return l},wNAF(s,o,a){const{windows:c,windowSize:l}=r(s);let u=e.ZERO,f=e.BASE;const h=BigInt(2**s-1),p=2**s,b=BigInt(s);for(let _=0;_<c;_++){const g=_*l;let y=Number(a&h);a>>=b,y>l&&(y-=p,a+=_1n$7);const w=g,R=g+Math.abs(y)-1,S=_%2!==0,I=y<0;y===0?f=f.add(n(S,o[w])):u=u.add(n(I,o[R]))}return{p:u,f}},wNAFCached(s,o,a,c){const l=s._WINDOW_SIZE||1;let u=o.get(s);return u||(u=this.precomputeWindow(s,l),l!==1&&o.set(s,c(u))),this.wNAF(l,u,a)}}}function validateBasic$1(e){return validateField$1(e.Fp),validateObject$1(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength$1(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validatePointOpts$1(e){const t=validateBasic$1(e);validateObject$1(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:b2n$1,hexToBytes:h2b$1}=ut$1,DER$1={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(e){const{Err:t}=DER$1;if(e.length<2||e[0]!==2)throw new t("Invalid signature integer tag");const n=e[1],r=e.subarray(2,n+2);if(!n||r.length!==n)throw new t("Invalid signature integer: wrong length");if(r[0]&128)throw new t("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return{d:b2n$1(r),l:e.subarray(n+2)}},toSig(e){const{Err:t}=DER$1,n=typeof e=="string"?h2b$1(e):e;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new t("Invalid signature tag");if(n[1]!==r-2)throw new t("Invalid signature: incorrect length");const{d:s,l:o}=DER$1._parseInt(n.subarray(2)),{d:a,l:c}=DER$1._parseInt(o);if(c.length)throw new t("Invalid signature: left bytes after parsing");return{r:s,s:a}},hexFromSig(e){const t=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const f=u.toString(16);return f.length&1?`0${f}`:f},r=t(n(e.s)),s=t(n(e.r)),o=r.length/2,a=s.length/2,c=n(o),l=n(a);return`30${n(a+o+4)}02${l}${s}02${c}${r}`}},_0n$6=BigInt(0),_1n$6=BigInt(1);BigInt(2);const _3n$2=BigInt(3);BigInt(4);function weierstrassPoints$1(e){const t=validatePointOpts$1(e),{Fp:n}=t,r=t.toBytes||((_,g,y)=>{const w=g.toAffine();return concatBytes$3(Uint8Array.from([4]),n.toBytes(w.x),n.toBytes(w.y))}),s=t.fromBytes||(_=>{const g=_.subarray(1),y=n.fromBytes(g.subarray(0,n.BYTES)),w=n.fromBytes(g.subarray(n.BYTES,2*n.BYTES));return{x:y,y:w}});function o(_){const{a:g,b:y}=t,w=n.sqr(_),R=n.mul(w,_);return n.add(n.add(R,n.mul(_,g)),y)}if(!n.eql(n.sqr(t.Gy),o(t.Gx)))throw new Error("bad generator point: equation left != right");function a(_){return typeof _=="bigint"&&_0n$6<_&&_<t.n}function c(_){if(!a(_))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function l(_){const{allowedPrivateKeyLengths:g,nByteLength:y,wrapPrivateKey:w,n:R}=t;if(g&&typeof _!="bigint"){if(_ instanceof Uint8Array&&(_=bytesToHex$3(_)),typeof _!="string"||!g.includes(_.length))throw new Error("Invalid key");_=_.padStart(y*2,"0")}let S;try{S=typeof _=="bigint"?_:bytesToNumberBE$1(ensureBytes$1("private key",_,y))}catch{throw new Error(`private key must be ${y} bytes, hex or bigint, not ${typeof _}`)}return w&&(S=mod$1(S,R)),c(S),S}const u=new Map;function f(_){if(!(_ instanceof h))throw new Error("ProjectivePoint expected")}class h{constructor(g,y,w){if(this.px=g,this.py=y,this.pz=w,g==null||!n.isValid(g))throw new Error("x required");if(y==null||!n.isValid(y))throw new Error("y required");if(w==null||!n.isValid(w))throw new Error("z required")}static fromAffine(g){const{x:y,y:w}=g||{};if(!g||!n.isValid(y)||!n.isValid(w))throw new Error("invalid affine point");if(g instanceof h)throw new Error("projective point not allowed");const R=S=>n.eql(S,n.ZERO);return R(y)&&R(w)?h.ZERO:new h(y,w,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(g){const y=n.invertBatch(g.map(w=>w.pz));return g.map((w,R)=>w.toAffine(y[R])).map(h.fromAffine)}static fromHex(g){const y=h.fromAffine(s(ensureBytes$1("pointHex",g)));return y.assertValidity(),y}static fromPrivateKey(g){return h.BASE.multiply(l(g))}_setWindowSize(g){this._WINDOW_SIZE=g,u.delete(this)}assertValidity(){if(this.is0()){if(t.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:g,y}=this.toAffine();if(!n.isValid(g)||!n.isValid(y))throw new Error("bad point: x or y not FE");const w=n.sqr(y),R=o(g);if(!n.eql(w,R))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:g}=this.toAffine();if(n.isOdd)return!n.isOdd(g);throw new Error("Field doesn't support isOdd")}equals(g){f(g);const{px:y,py:w,pz:R}=this,{px:S,py:I,pz:O}=g,B=n.eql(n.mul(y,O),n.mul(S,R)),C=n.eql(n.mul(w,O),n.mul(I,R));return B&&C}negate(){return new h(this.px,n.neg(this.py),this.pz)}double(){const{a:g,b:y}=t,w=n.mul(y,_3n$2),{px:R,py:S,pz:I}=this;let O=n.ZERO,B=n.ZERO,C=n.ZERO,L=n.mul(R,R),F=n.mul(S,S),M=n.mul(I,I),$=n.mul(R,S);return $=n.add($,$),C=n.mul(R,I),C=n.add(C,C),O=n.mul(g,C),B=n.mul(w,M),B=n.add(O,B),O=n.sub(F,B),B=n.add(F,B),B=n.mul(O,B),O=n.mul($,O),C=n.mul(w,C),M=n.mul(g,M),$=n.sub(L,M),$=n.mul(g,$),$=n.add($,C),C=n.add(L,L),L=n.add(C,L),L=n.add(L,M),L=n.mul(L,$),B=n.add(B,L),M=n.mul(S,I),M=n.add(M,M),L=n.mul(M,$),O=n.sub(O,L),C=n.mul(M,F),C=n.add(C,C),C=n.add(C,C),new h(O,B,C)}add(g){f(g);const{px:y,py:w,pz:R}=this,{px:S,py:I,pz:O}=g;let B=n.ZERO,C=n.ZERO,L=n.ZERO;const F=t.a,M=n.mul(t.b,_3n$2);let $=n.mul(y,S),x=n.mul(w,I),A=n.mul(R,O),k=n.add(y,w),E=n.add(S,I);k=n.mul(k,E),E=n.add($,x),k=n.sub(k,E),E=n.add(y,R);let v=n.add(S,O);return E=n.mul(E,v),v=n.add($,A),E=n.sub(E,v),v=n.add(w,R),B=n.add(I,O),v=n.mul(v,B),B=n.add(x,A),v=n.sub(v,B),L=n.mul(F,E),B=n.mul(M,A),L=n.add(B,L),B=n.sub(x,L),L=n.add(x,L),C=n.mul(B,L),x=n.add($,$),x=n.add(x,$),A=n.mul(F,A),E=n.mul(M,E),x=n.add(x,A),A=n.sub($,A),A=n.mul(F,A),E=n.add(E,A),$=n.mul(x,E),C=n.add(C,$),$=n.mul(v,E),B=n.mul(k,B),B=n.sub(B,$),$=n.mul(k,x),L=n.mul(v,L),L=n.add(L,$),new h(B,C,L)}subtract(g){return this.add(g.negate())}is0(){return this.equals(h.ZERO)}wNAF(g){return b.wNAFCached(this,u,g,y=>{const w=n.invertBatch(y.map(R=>R.pz));return y.map((R,S)=>R.toAffine(w[S])).map(h.fromAffine)})}multiplyUnsafe(g){const y=h.ZERO;if(g===_0n$6)return y;if(c(g),g===_1n$6)return this;const{endo:w}=t;if(!w)return b.unsafeLadder(this,g);let{k1neg:R,k1:S,k2neg:I,k2:O}=w.splitScalar(g),B=y,C=y,L=this;for(;S>_0n$6||O>_0n$6;)S&_1n$6&&(B=B.add(L)),O&_1n$6&&(C=C.add(L)),L=L.double(),S>>=_1n$6,O>>=_1n$6;return R&&(B=B.negate()),I&&(C=C.negate()),C=new h(n.mul(C.px,w.beta),C.py,C.pz),B.add(C)}multiply(g){c(g);let y=g,w,R;const{endo:S}=t;if(S){const{k1neg:I,k1:O,k2neg:B,k2:C}=S.splitScalar(y);let{p:L,f:F}=this.wNAF(O),{p:M,f:$}=this.wNAF(C);L=b.constTimeNegate(I,L),M=b.constTimeNegate(B,M),M=new h(n.mul(M.px,S.beta),M.py,M.pz),w=L.add(M),R=F.add($)}else{const{p:I,f:O}=this.wNAF(y);w=I,R=O}return h.normalizeZ([w,R])[0]}multiplyAndAddUnsafe(g,y,w){const R=h.BASE,S=(O,B)=>B===_0n$6||B===_1n$6||!O.equals(R)?O.multiplyUnsafe(B):O.multiply(B),I=S(this,y).add(S(g,w));return I.is0()?void 0:I}toAffine(g){const{px:y,py:w,pz:R}=this,S=this.is0();g==null&&(g=S?n.ONE:n.inv(R));const I=n.mul(y,g),O=n.mul(w,g),B=n.mul(R,g);if(S)return{x:n.ZERO,y:n.ZERO};if(!n.eql(B,n.ONE))throw new Error("invZ was invalid");return{x:I,y:O}}isTorsionFree(){const{h:g,isTorsionFree:y}=t;if(g===_1n$6)return!0;if(y)return y(h,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:g,clearCofactor:y}=t;return g===_1n$6?this:y?y(h,this):this.multiplyUnsafe(t.h)}toRawBytes(g=!0){return this.assertValidity(),r(h,this,g)}toHex(g=!0){return bytesToHex$3(this.toRawBytes(g))}}h.BASE=new h(t.Gx,t.Gy,n.ONE),h.ZERO=new h(n.ZERO,n.ONE,n.ZERO);const p=t.nBitLength,b=wNAF$1(h,t.endo?Math.ceil(p/2):p);return{CURVE:t,ProjectivePoint:h,normPrivateKeyToScalar:l,weierstrassEquation:o,isWithinCurveOrder:a}}function validateOpts$1(e){const t=validateBasic$1(e);return validateObject$1(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function weierstrass$1(e){const t=validateOpts$1(e),{Fp:n,n:r}=t,s=n.BYTES+1,o=2*n.BYTES+1;function a(E){return _0n$6<E&&E<n.ORDER}function c(E){return mod$1(E,r)}function l(E){return invert$1(E,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:f,weierstrassEquation:h,isWithinCurveOrder:p}=weierstrassPoints$1({...t,toBytes(E,v,T){const N=v.toAffine(),U=n.toBytes(N.x),D=concatBytes$3;return T?D(Uint8Array.from([v.hasEvenY()?2:3]),U):D(Uint8Array.from([4]),U,n.toBytes(N.y))},fromBytes(E){const v=E.length,T=E[0],N=E.subarray(1);if(v===s&&(T===2||T===3)){const U=bytesToNumberBE$1(N);if(!a(U))throw new Error("Point is not on curve");const D=h(U);let P=n.sqrt(D);const H=(P&_1n$6)===_1n$6;return(T&1)===1!==H&&(P=n.neg(P)),{x:U,y:P}}else if(v===o&&T===4){const U=n.fromBytes(N.subarray(0,n.BYTES)),D=n.fromBytes(N.subarray(n.BYTES,2*n.BYTES));return{x:U,y:D}}else throw new Error(`Point of length ${v} was invalid. Expected ${s} compressed bytes or ${o} uncompressed bytes`)}}),b=E=>bytesToHex$3(numberToBytesBE$1(E,t.nByteLength));function _(E){const v=r>>_1n$6;return E>v}function g(E){return _(E)?c(-E):E}const y=(E,v,T)=>bytesToNumberBE$1(E.slice(v,T));class w{constructor(v,T,N){this.r=v,this.s=T,this.recovery=N,this.assertValidity()}static fromCompact(v){const T=t.nByteLength;return v=ensureBytes$1("compactSignature",v,T*2),new w(y(v,0,T),y(v,T,2*T))}static fromDER(v){const{r:T,s:N}=DER$1.toSig(ensureBytes$1("DER",v));return new w(T,N)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(v){return new w(this.r,this.s,v)}recoverPublicKey(v){const{r:T,s:N,recovery:U}=this,D=C(ensureBytes$1("msgHash",v));if(U==null||![0,1,2,3].includes(U))throw new Error("recovery id invalid");const P=U===2||U===3?T+t.n:T;if(P>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const H=U&1?"03":"02",z=u.fromHex(H+b(P)),V=l(P),W=c(-D*V),q=c(N*V),Z=u.BASE.multiplyAndAddUnsafe(z,W,q);if(!Z)throw new Error("point at infinify");return Z.assertValidity(),Z}hasHighS(){return _(this.s)}normalizeS(){return this.hasHighS()?new w(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes$3(this.toDERHex())}toDERHex(){return DER$1.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes$3(this.toCompactHex())}toCompactHex(){return b(this.r)+b(this.s)}}const R={isValidPrivateKey(E){try{return f(E),!0}catch{return!1}},normPrivateKeyToScalar:f,randomPrivateKey:()=>{const E=getMinHashLength$1(t.n);return mapHashToField$1(t.randomBytes(E),t.n)},precompute(E=8,v=u.BASE){return v._setWindowSize(E),v.multiply(BigInt(3)),v}};function S(E,v=!0){return u.fromPrivateKey(E).toRawBytes(v)}function I(E){const v=E instanceof Uint8Array,T=typeof E=="string",N=(v||T)&&E.length;return v?N===s||N===o:T?N===2*s||N===2*o:E instanceof u}function O(E,v,T=!0){if(I(E))throw new Error("first arg must be private key");if(!I(v))throw new Error("second arg must be public key");return u.fromHex(v).multiply(f(E)).toRawBytes(T)}const B=t.bits2int||function(E){const v=bytesToNumberBE$1(E),T=E.length*8-t.nBitLength;return T>0?v>>BigInt(T):v},C=t.bits2int_modN||function(E){return c(B(E))},L=bitMask$1(t.nBitLength);function F(E){if(typeof E!="bigint")throw new Error("bigint expected");if(!(_0n$6<=E&&E<L))throw new Error(`bigint expected < 2^${t.nBitLength}`);return numberToBytesBE$1(E,t.nByteLength)}function M(E,v,T=$){if(["recovered","canonical"].some(J=>J in T))throw new Error("sign() legacy options not supported");const{hash:N,randomBytes:U}=t;let{lowS:D,prehash:P,extraEntropy:H}=T;D==null&&(D=!0),E=ensureBytes$1("msgHash",E),P&&(E=ensureBytes$1("prehashed msgHash",N(E)));const z=C(E),V=f(v),W=[F(V),F(z)];if(H!=null){const J=H===!0?U(n.BYTES):H;W.push(ensureBytes$1("extraEntropy",J))}const q=concatBytes$3(...W),Z=z;function Y(J){const X=B(J);if(!p(X))return;const Q=l(X),j=u.BASE.multiply(X).toAffine(),G=c(j.x);if(G===_0n$6)return;const K=c(Q*c(Z+G*V));if(K===_0n$6)return;let ie=(j.x===G?0:2)|Number(j.y&_1n$6),oe=K;return D&&_(K)&&(oe=g(K),ie^=1),new w(G,oe,ie)}return{seed:q,k2sig:Y}}const $={lowS:t.lowS,prehash:!1},x={lowS:t.lowS,prehash:!1};function A(E,v,T=$){const{seed:N,k2sig:U}=M(E,v,T),D=t;return createHmacDrbg$1(D.hash.outputLen,D.nByteLength,D.hmac)(N,U)}u.BASE._setWindowSize(8);function k(E,v,T,N=x){var j;const U=E;if(v=ensureBytes$1("msgHash",v),T=ensureBytes$1("publicKey",T),"strict"in N)throw new Error("options.strict was renamed to lowS");const{lowS:D,prehash:P}=N;let H,z;try{if(typeof U=="string"||U instanceof Uint8Array)try{H=w.fromDER(U)}catch(G){if(!(G instanceof DER$1.Err))throw G;H=w.fromCompact(U)}else if(typeof U=="object"&&typeof U.r=="bigint"&&typeof U.s=="bigint"){const{r:G,s:K}=U;H=new w(G,K)}else throw new Error("PARSE");z=u.fromHex(T)}catch(G){if(G.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(D&&H.hasHighS())return!1;P&&(v=t.hash(v));const{r:V,s:W}=H,q=C(v),Z=l(W),Y=c(q*Z),J=c(V*Z),X=(j=u.BASE.multiplyAndAddUnsafe(z,Y,J))==null?void 0:j.toAffine();return X?c(X.x)===V:!1}return{CURVE:t,getPublicKey:S,getSharedSecret:O,sign:A,verify:k,ProjectivePoint:u,Signature:w,utils:R}}let HMAC$2=class extends Hash$2{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,hash$2(t);const r=toBytes$2(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(r.length>s?t.create().update(r).digest():r);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=t.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),o.fill(0)}update(t){return exists$2(this),this.iHash.update(t),this}digestInto(t){exists$2(this),bytes$3(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:o,blockLen:a,outputLen:c}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=a,t.outputLen=c,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$2=(e,t,n)=>new HMAC$2(e,t).update(n).digest();hmac$2.create=(e,t)=>new HMAC$2(e,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash$1(e){return{hash:e,hmac:(t,...n)=>hmac$2(e,t,concatBytes$4(...n)),randomBytes:randomBytes$2}}function createCurve$1(e,t){const n=r=>weierstrass$1({...e,...getHash$1(r)});return Object.freeze({...n(t),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P$1=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N$1=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n$5=BigInt(1),_2n$3=BigInt(2),divNearest$1=(e,t)=>(e+t/_2n$3)/t;function sqrtMod$1(e){const t=secp256k1P$1,n=BigInt(3),r=BigInt(6),s=BigInt(11),o=BigInt(22),a=BigInt(23),c=BigInt(44),l=BigInt(88),u=e*e*e%t,f=u*u*e%t,h=pow2$1(f,n,t)*f%t,p=pow2$1(h,n,t)*f%t,b=pow2$1(p,_2n$3,t)*u%t,_=pow2$1(b,s,t)*b%t,g=pow2$1(_,o,t)*_%t,y=pow2$1(g,c,t)*g%t,w=pow2$1(y,l,t)*y%t,R=pow2$1(w,c,t)*g%t,S=pow2$1(R,n,t)*f%t,I=pow2$1(S,a,t)*_%t,O=pow2$1(I,r,t)*u%t,B=pow2$1(O,_2n$3,t);if(!Fp$1.eql(Fp$1.sqr(B),e))throw new Error("Cannot find square root");return B}const Fp$1=Field$1(secp256k1P$1,void 0,void 0,{sqrt:sqrtMod$1}),secp256k1$1=createCurve$1({a:BigInt(0),b:BigInt(7),Fp:Fp$1,n:secp256k1N$1,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=secp256k1N$1,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n$5*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,a=BigInt("0x100000000000000000000000000000000"),c=divNearest$1(o*e,t),l=divNearest$1(-r*e,t);let u=mod$1(e-c*n-l*s,t),f=mod$1(-c*r-l*o,t);const h=u>a,p=f>a;if(h&&(u=t-u),p&&(f=t-f),u>a||f>a)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:h,k1:u,k2neg:p,k2:f}}}},sha256$2),_0n$5=BigInt(0),fe=e=>typeof e=="bigint"&&_0n$5<e&&e<secp256k1P$1,ge=e=>typeof e=="bigint"&&_0n$5<e&&e<secp256k1N$1,TAGGED_HASH_PREFIXES$1={};function taggedHash$1(e,...t){let n=TAGGED_HASH_PREFIXES$1[e];if(n===void 0){const r=sha256$2(Uint8Array.from(e,s=>s.charCodeAt(0)));n=concatBytes$3(r,r),TAGGED_HASH_PREFIXES$1[e]=n}return sha256$2(concatBytes$3(n,...t))}const pointToBytes$1=e=>e.toRawBytes(!0).slice(1),numTo32b$1=e=>numberToBytesBE$1(e,32),modP$1=e=>mod$1(e,secp256k1P$1),modN$1=e=>mod$1(e,secp256k1N$1),Point$1=secp256k1$1.ProjectivePoint,GmulAdd$1=(e,t,n)=>Point$1.BASE.multiplyAndAddUnsafe(e,t,n);function schnorrGetExtPubKey$1(e){let t=secp256k1$1.utils.normPrivateKeyToScalar(e),n=Point$1.fromPrivateKey(t);return{scalar:n.hasEvenY()?t:modN$1(-t),bytes:pointToBytes$1(n)}}function lift_x$1(e){if(!fe(e))throw new Error("bad x: need 0 < x < p");const t=modP$1(e*e),n=modP$1(t*e+BigInt(7));let r=sqrtMod$1(n);r%_2n$3!==_0n$5&&(r=modP$1(-r));const s=new Point$1(e,r,_1n$5);return s.assertValidity(),s}function challenge$1(...e){return modN$1(bytesToNumberBE$1(taggedHash$1("BIP0340/challenge",...e)))}function schnorrGetPublicKey$1(e){return schnorrGetExtPubKey$1(e).bytes}function schnorrSign$1(e,t,n=randomBytes$2(32)){const r=ensureBytes$1("message",e),{bytes:s,scalar:o}=schnorrGetExtPubKey$1(t),a=ensureBytes$1("auxRand",n,32),c=numTo32b$1(o^bytesToNumberBE$1(taggedHash$1("BIP0340/aux",a))),l=taggedHash$1("BIP0340/nonce",c,s,r),u=modN$1(bytesToNumberBE$1(l));if(u===_0n$5)throw new Error("sign failed: k is zero");const{bytes:f,scalar:h}=schnorrGetExtPubKey$1(u),p=challenge$1(f,s,r),b=new Uint8Array(64);if(b.set(f,0),b.set(numTo32b$1(modN$1(h+p*o)),32),!schnorrVerify$1(b,r,s))throw new Error("sign: Invalid signature produced");return b}function schnorrVerify$1(e,t,n){const r=ensureBytes$1("signature",e,64),s=ensureBytes$1("message",t),o=ensureBytes$1("publicKey",n,32);try{const a=lift_x$1(bytesToNumberBE$1(o)),c=bytesToNumberBE$1(r.subarray(0,32));if(!fe(c))return!1;const l=bytesToNumberBE$1(r.subarray(32,64));if(!ge(l))return!1;const u=challenge$1(numTo32b$1(c),pointToBytes$1(a),s),f=GmulAdd$1(a,l,modN$1(-u));return!(!f||!f.hasEvenY()||f.toAffine().x!==c)}catch{return!1}}const schnorr$1={getPublicKey:schnorrGetPublicKey$1,sign:schnorrSign$1,verify:schnorrVerify$1,utils:{randomPrivateKey:secp256k1$1.utils.randomPrivateKey,lift_x:lift_x$1,pointToBytes:pointToBytes$1,numberToBytesBE:numberToBytesBE$1,bytesToNumberBE:bytesToNumberBE$1,taggedHash:taggedHash$1,mod:mod$1}},crypto$2=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u8a=e=>e instanceof Uint8Array,createView$1=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),rotr$1=(e,t)=>e<<32-t|e>>>t,isLE$1=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE$1)throw new Error("Non little-endian hardware is not supported");const hexes$2=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function bytesToHex$2(e){if(!u8a(e))throw new Error("Uint8Array expected");let t="";for(let n=0;n<e.length;n++)t+=hexes$2[e[n]];return t}function hexToBytes$2(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(t/2);for(let r=0;r<n.length;r++){const s=r*2,o=e.slice(s,s+2),a=Number.parseInt(o,16);if(Number.isNaN(a)||a<0)throw new Error("Invalid byte sequence");n[r]=a}return n}function utf8ToBytes$2(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function toBytes$1(e){if(typeof e=="string"&&(e=utf8ToBytes$2(e)),!u8a(e))throw new Error(`expected Uint8Array, got ${typeof e}`);return e}function concatBytes$2(...e){const t=new Uint8Array(e.reduce((r,s)=>r+s.length,0));let n=0;return e.forEach(r=>{if(!u8a(r))throw new Error("Uint8Array expected");t.set(r,n),n+=r.length}),t}let Hash$1=class{clone(){return this._cloneInto()}};function wrapConstructor$1(e){const t=r=>e().update(toBytes$1(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function randomBytes$1(e=32){if(crypto$2&&typeof crypto$2.getRandomValues=="function")return crypto$2.getRandomValues(new Uint8Array(e));throw new Error("crypto.getRandomValues must be defined")}function number$2(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`Wrong positive integer: ${e}`)}function bool$1(e){if(typeof e!="boolean")throw new Error(`Expected boolean, not ${e}`)}function bytes$2(e,...t){if(!(e instanceof Uint8Array))throw new Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw new Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function hash$1(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number$2(e.outputLen),number$2(e.blockLen)}function exists$1(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function output$1(e,t){bytes$2(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const assert={number:number$2,bool:bool$1,bytes:bytes$2,hash:hash$1,exists:exists$1,output:output$1};function setBigUint64$1(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),o=BigInt(4294967295),a=Number(n>>s&o),c=Number(n&o),l=r?4:0,u=r?0:4;e.setUint32(t+l,a,r),e.setUint32(t+u,c,r)}class SHA2 extends Hash$1{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=createView$1(this.buffer)}update(t){assert.exists(this);const{view:n,buffer:r,blockLen:s}=this;t=toBytes$1(t);const o=t.length;for(let a=0;a<o;){const c=Math.min(s-this.pos,o-a);if(c===s){const l=createView$1(t);for(;s<=o-a;a+=s)this.process(l,a);continue}r.set(t.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){assert.exists(this),assert.output(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:o}=this;let{pos:a}=this;n[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>s-a&&(this.process(r,0),a=0);for(let h=a;h<s;h++)n[h]=0;setBigUint64$1(r,s-8,BigInt(this.length*8),o),this.process(r,0);const c=createView$1(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:o,destroyed:a,pos:c}=this;return t.length=s,t.pos=c,t.finished=o,t.destroyed=a,s%n&&t.buffer.set(r),t}}const Chi$1=(e,t,n)=>e&t^~e&n,Maj$1=(e,t,n)=>e&t^e&n^t&n,SHA256_K$1=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W$1=new Uint32Array(64);let SHA256$1=class extends SHA2{constructor(){super(64,32,8,!1),this.A=IV[0]|0,this.B=IV[1]|0,this.C=IV[2]|0,this.D=IV[3]|0,this.E=IV[4]|0,this.F=IV[5]|0,this.G=IV[6]|0,this.H=IV[7]|0}get(){const{A:t,B:n,C:r,D:s,E:o,F:a,G:c,H:l}=this;return[t,n,r,s,o,a,c,l]}set(t,n,r,s,o,a,c,l){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(t,n){for(let h=0;h<16;h++,n+=4)SHA256_W$1[h]=t.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W$1[h-15],b=SHA256_W$1[h-2],_=rotr$1(p,7)^rotr$1(p,18)^p>>>3,g=rotr$1(b,17)^rotr$1(b,19)^b>>>10;SHA256_W$1[h]=g+SHA256_W$1[h-7]+_+SHA256_W$1[h-16]|0}let{A:r,B:s,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr$1(c,6)^rotr$1(c,11)^rotr$1(c,25),b=f+p+Chi$1(c,l,u)+SHA256_K$1[h]+SHA256_W$1[h]|0,g=(rotr$1(r,2)^rotr$1(r,13)^rotr$1(r,22))+Maj$1(r,s,o)|0;f=u,u=l,l=c,c=a+b|0,a=o,o=s,s=r,r=b+g|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(r,s,o,a,c,l,u,f)}roundClean(){SHA256_W$1.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};class SHA224 extends SHA256$1{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const sha256$1=wrapConstructor$1(()=>new SHA256$1);wrapConstructor$1(()=>new SHA224);/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function assertNumber(e){if(!Number.isSafeInteger(e))throw new Error(`Wrong integer: ${e}`)}function chain$1(...e){const t=(s,o)=>a=>s(o(a)),n=Array.from(e).reverse().reduce((s,o)=>s?t(s,o.encode):o.encode,void 0),r=e.reduce((s,o)=>s?t(s,o.decode):o.decode,void 0);return{encode:n,decode:r}}function alphabet$1(e){return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return t.map(n=>{if(assertNumber(n),n<0||n>=e.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${e.length})`);return e[n]})},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("alphabet.decode input should be array of strings");return t.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=e.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${e}`);return r})}}}function join$1(e=""){if(typeof e!="string")throw new Error("join separator should be string");return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return t.join(e)},decode:t=>{if(typeof t!="string")throw new Error("join.decode input should be string");return t.split(e)}}}function padding(e,t="="){if(assertNumber(e),typeof t!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let r of n)if(typeof r!="string")throw new Error(`padding.encode: non-string input=${r}`);for(;n.length*e%8;)n.push(t);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of n)if(typeof s!="string")throw new Error(`padding.decode: non-string input=${s}`);let r=n.length;if(r*e%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===t;r--)if(!((r-1)*e%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function normalize$1(e){if(typeof e!="function")throw new Error("normalize fn should be function");return{encode:t=>t,decode:t=>e(t)}}function convertRadix(e,t,n){if(t<2)throw new Error(`convertRadix: wrong from=${t}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(e))throw new Error("convertRadix: data should be array");if(!e.length)return[];let r=0;const s=[],o=Array.from(e);for(o.forEach(a=>{if(assertNumber(a),a<0||a>=t)throw new Error(`Wrong integer: ${a}`)});;){let a=0,c=!0;for(let l=r;l<o.length;l++){const u=o[l],f=t*a+u;if(!Number.isSafeInteger(f)||t*a/t!==a||f-u!==t*a)throw new Error("convertRadix: carry overflow");if(a=f%n,o[l]=Math.floor(f/n),!Number.isSafeInteger(o[l])||o[l]*n+a!==f)throw new Error("convertRadix: carry overflow");if(c)o[l]?c=!1:r=l;else continue}if(s.push(a),c)break}for(let a=0;a<e.length-1&&e[a]===0;a++)s.push(0);return s.reverse()}const gcd$1=(e,t)=>t?gcd$1(t,e%t):e,radix2carry$1=(e,t)=>e+(t-gcd$1(e,t));function convertRadix2$1(e,t,n,r){if(!Array.isArray(e))throw new Error("convertRadix2: data should be array");if(t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(radix2carry$1(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${radix2carry$1(t,n)}`);let s=0,o=0;const a=2**n-1,c=[];for(const l of e){if(assertNumber(l),l>=2**t)throw new Error(`convertRadix2: invalid data word=${l} from=${t}`);if(s=s<<t|l,o+t>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${t}`);for(o+=t;o>=n;o-=n)c.push((s>>o-n&a)>>>0);s&=2**o-1}if(s=s<<n-o&a,!r&&o>=t)throw new Error("Excess padding");if(!r&&s)throw new Error(`Non-zero padding: ${s}`);return r&&o>0&&c.push(s>>>0),c}function radix(e){return assertNumber(e),{encode:t=>{if(!(t instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return convertRadix(Array.from(t),2**8,e)},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(convertRadix(t,e,2**8))}}}function radix2$1(e,t=!1){if(assertNumber(e),e<=0||e>32)throw new Error("radix2: bits should be in (0..32]");if(radix2carry$1(8,e)>32||radix2carry$1(e,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return convertRadix2$1(Array.from(n),8,e,!t)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(convertRadix2$1(n,e,8,t))}}}function unsafeWrapper$1(e){if(typeof e!="function")throw new Error("unsafeWrapper fn should be function");return function(...t){try{return e.apply(null,t)}catch{}}}const base16=chain$1(radix2$1(4),alphabet$1("0123456789ABCDEF"),join$1("")),base32=chain$1(radix2$1(5),alphabet$1("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),padding(5),join$1(""));chain$1(radix2$1(5),alphabet$1("0123456789ABCDEFGHIJKLMNOPQRSTUV"),padding(5),join$1(""));chain$1(radix2$1(5),alphabet$1("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),join$1(""),normalize$1(e=>e.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const base64=chain$1(radix2$1(6),alphabet$1("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),padding(6),join$1("")),base64url=chain$1(radix2$1(6),alphabet$1("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),padding(6),join$1("")),genBase58=e=>chain$1(radix(58),alphabet$1(e),join$1("")),base58=genBase58("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");genBase58("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");genBase58("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const XMR_BLOCK_LEN=[0,2,3,5,6,7,9,10,11],base58xmr={encode(e){let t="";for(let n=0;n<e.length;n+=8){const r=e.subarray(n,n+8);t+=base58.encode(r).padStart(XMR_BLOCK_LEN[r.length],"1")}return t},decode(e){let t=[];for(let n=0;n<e.length;n+=11){const r=e.slice(n,n+11),s=XMR_BLOCK_LEN.indexOf(r.length),o=base58.decode(r);for(let a=0;a<o.length-s;a++)if(o[a]!==0)throw new Error("base58xmr: wrong padding");t=t.concat(Array.from(o.slice(o.length-s)))}return Uint8Array.from(t)}},BECH_ALPHABET$1=chain$1(alphabet$1("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),join$1("")),POLYMOD_GENERATORS$1=[996825010,642813549,513874426,1027748829,705979059];function bech32Polymod$1(e){const t=e>>25;let n=(e&33554431)<<5;for(let r=0;r<POLYMOD_GENERATORS$1.length;r++)(t>>r&1)===1&&(n^=POLYMOD_GENERATORS$1[r]);return n}function bechChecksum$1(e,t,n=1){const r=e.length;let s=1;for(let o=0;o<r;o++){const a=e.charCodeAt(o);if(a<33||a>126)throw new Error(`Invalid prefix (${e})`);s=bech32Polymod$1(s)^a>>5}s=bech32Polymod$1(s);for(let o=0;o<r;o++)s=bech32Polymod$1(s)^e.charCodeAt(o)&31;for(let o of t)s=bech32Polymod$1(s)^o;for(let o=0;o<6;o++)s=bech32Polymod$1(s);return s^=n,BECH_ALPHABET$1.encode(convertRadix2$1([s%2**30],30,5,!1))}function genBech32$1(e){const t=e==="bech32"?1:734539939,n=radix2$1(5),r=n.decode,s=n.encode,o=unsafeWrapper$1(r);function a(f,h,p=90){if(typeof f!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof f}`);if(!Array.isArray(h)||h.length&&typeof h[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof h}`);const b=f.length+7+h.length;if(p!==!1&&b>p)throw new TypeError(`Length ${b} exceeds limit ${p}`);return f=f.toLowerCase(),`${f}1${BECH_ALPHABET$1.encode(h)}${bechChecksum$1(f,h,t)}`}function c(f,h=90){if(typeof f!="string")throw new Error(`bech32.decode input should be string, not ${typeof f}`);if(f.length<8||h!==!1&&f.length>h)throw new TypeError(`Wrong string length: ${f.length} (${f}). Expected (8..${h})`);const p=f.toLowerCase();if(f!==p&&f!==f.toUpperCase())throw new Error("String must be lowercase or uppercase");f=p;const b=f.lastIndexOf("1");if(b===0||b===-1)throw new Error('Letter "1" must be present between prefix and data only');const _=f.slice(0,b),g=f.slice(b+1);if(g.length<6)throw new Error("Data must be at least 6 characters long");const y=BECH_ALPHABET$1.decode(g).slice(0,-6),w=bechChecksum$1(_,y,t);if(!g.endsWith(w))throw new Error(`Invalid checksum in ${f}: expected "${w}"`);return{prefix:_,words:y}}const l=unsafeWrapper$1(c);function u(f){const{prefix:h,words:p}=c(f,!1);return{prefix:h,words:p,bytes:r(p)}}return{encode:a,decode:c,decodeToBytes:u,decodeUnsafe:l,fromWords:r,fromWordsUnsafe:o,toWords:s}}const bech32$1=genBech32$1("bech32");genBech32$1("bech32m");const utf8={encode:e=>new TextDecoder().decode(e),decode:e=>new TextEncoder().encode(e)},hex=chain$1(radix2$1(4),alphabet$1("0123456789abcdef"),join$1(""),normalize$1(e=>{if(typeof e!="string"||e.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof e} with length ${e.length}`);return e.toLowerCase()})),CODERS={utf8,hex,base16,base32,base64,base64url,base58,base58xmr};`${Object.keys(CODERS).join(", ")}`;function number$1(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function bool(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function isBytes$3(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function bytes$1(e,...t){if(!isBytes$3(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const u32=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4)),isLE=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!isLE)throw new Error("Non little-endian hardware is not supported");function checkOpts(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function equalBytes$1(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return n===0}const wrapCipher=(e,t)=>(Object.assign(t,e),t),BLOCK_SIZE=16,POLY=283;function mul2(e){return e<<1^POLY&-(e>>7)}function mul(e,t){let n=0;for(;t>0;t>>=1)n^=e&-(t&1),e=mul2(e);return n}const sbox=(()=>{let e=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=mul2(r))e[n]=r;const t=new Uint8Array(256);t[0]=99;for(let n=0;n<255;n++){let r=e[255-n];r|=r<<8,t[e[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return t})(),invSbox=sbox.map((e,t)=>sbox.indexOf(t)),rotr32_8=e=>e<<24|e>>>8,rotl32_8=e=>e<<8|e>>>24;function genTtable(e,t){if(e.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((u,f)=>t(e[f])),r=n.map(rotl32_8),s=r.map(rotl32_8),o=s.map(rotl32_8),a=new Uint32Array(256*256),c=new Uint32Array(256*256),l=new Uint16Array(256*256);for(let u=0;u<256;u++)for(let f=0;f<256;f++){const h=u*256+f;a[h]=n[u]^r[f],c[h]=s[u]^o[f],l[h]=e[u]<<8|e[f]}return{sbox:e,sbox2:l,T0:n,T1:r,T2:s,T3:o,T01:a,T23:c}}const tableEncoding=genTtable(sbox,e=>mul(e,3)<<24|e<<16|e<<8|mul(e,2)),tableDecoding=genTtable(invSbox,e=>mul(e,11)<<24|mul(e,13)<<16|mul(e,9)<<8|mul(e,14)),xPowers=(()=>{const e=new Uint8Array(16);for(let t=0,n=1;t<16;t++,n=mul2(n))e[t]=n;return e})();function expandKeyLE(e){bytes$1(e);const t=e.length;if(![16,24,32].includes(t))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${t}`);const{sbox2:n}=tableEncoding,r=u32(e),s=r.length,o=c=>applySbox(n,c,c,c,c),a=new Uint32Array(t+28);a.set(r);for(let c=s;c<a.length;c++){let l=a[c-1];c%s===0?l=o(rotr32_8(l))^xPowers[c/s-1]:s>6&&c%s===4&&(l=o(l)),a[c]=a[c-s]^l}return a}function expandKeyDecLE(e){const t=expandKeyLE(e),n=t.slice(),r=t.length,{sbox2:s}=tableEncoding,{T0:o,T1:a,T2:c,T3:l}=tableDecoding;for(let u=0;u<r;u+=4)for(let f=0;f<4;f++)n[u+f]=t[r-u-4+f];t.fill(0);for(let u=4;u<r-4;u++){const f=n[u],h=applySbox(s,f,f,f,f);n[u]=o[h&255]^a[h>>>8&255]^c[h>>>16&255]^l[h>>>24]}return n}function apply0123(e,t,n,r,s,o){return e[n<<8&65280|r>>>8&255]^t[s>>>8&65280|o>>>24&255]}function applySbox(e,t,n,r,s){return e[t&255|n&65280]|e[r>>>16&255|s>>>16&65280]<<16}function encrypt$2(e,t,n,r,s){const{sbox2:o,T01:a,T23:c}=tableEncoding;let l=0;t^=e[l++],n^=e[l++],r^=e[l++],s^=e[l++];const u=e.length/4-2;for(let _=0;_<u;_++){const g=e[l++]^apply0123(a,c,t,n,r,s),y=e[l++]^apply0123(a,c,n,r,s,t),w=e[l++]^apply0123(a,c,r,s,t,n),R=e[l++]^apply0123(a,c,s,t,n,r);t=g,n=y,r=w,s=R}const f=e[l++]^applySbox(o,t,n,r,s),h=e[l++]^applySbox(o,n,r,s,t),p=e[l++]^applySbox(o,r,s,t,n),b=e[l++]^applySbox(o,s,t,n,r);return{s0:f,s1:h,s2:p,s3:b}}function decrypt$2(e,t,n,r,s){const{sbox2:o,T01:a,T23:c}=tableDecoding;let l=0;t^=e[l++],n^=e[l++],r^=e[l++],s^=e[l++];const u=e.length/4-2;for(let _=0;_<u;_++){const g=e[l++]^apply0123(a,c,t,s,r,n),y=e[l++]^apply0123(a,c,n,t,s,r),w=e[l++]^apply0123(a,c,r,n,t,s),R=e[l++]^apply0123(a,c,s,r,n,t);t=g,n=y,r=w,s=R}const f=e[l++]^applySbox(o,t,s,r,n),h=e[l++]^applySbox(o,n,t,s,r),p=e[l++]^applySbox(o,r,n,t,s),b=e[l++]^applySbox(o,s,r,n,t);return{s0:f,s1:h,s2:p,s3:b}}function getDst(e,t){if(!t)return new Uint8Array(e);if(bytes$1(t),t.length<e)throw new Error(`aes: wrong destination length, expected at least ${e}, got: ${t.length}`);return t}function validateBlockDecrypt(e){if(bytes$1(e),e.length%BLOCK_SIZE!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${BLOCK_SIZE}`)}function validateBlockEncrypt(e,t,n){let r=e.length;const s=r%BLOCK_SIZE;if(!t&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=u32(e);if(t){let l=BLOCK_SIZE-s;l||(l=BLOCK_SIZE),r=r+l}const a=getDst(r,n),c=u32(a);return{b:o,o:c,out:a}}function validatePCKS(e,t){if(!t)return e;const n=e.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=e[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const s=e.subarray(0,-r);for(let o=0;o<r;o++)if(e[n-o-1]!==r)throw new Error("aes/pcks5: wrong padding");return s}function padPCKS(e){const t=new Uint8Array(16),n=u32(t);t.set(e);const r=BLOCK_SIZE-e.length;for(let s=BLOCK_SIZE-r;s<BLOCK_SIZE;s++)t[s]=r;return n}const cbc=wrapCipher({blockSize:16,nonceLength:16},function(t,n,r={}){bytes$1(t),bytes$1(n,16);const s=!r.disablePadding;return{encrypt:(o,a)=>{const c=expandKeyLE(t),{b:l,o:u,out:f}=validateBlockEncrypt(o,s,a),h=u32(n);let p=h[0],b=h[1],_=h[2],g=h[3],y=0;for(;y+4<=l.length;)p^=l[y+0],b^=l[y+1],_^=l[y+2],g^=l[y+3],{s0:p,s1:b,s2:_,s3:g}=encrypt$2(c,p,b,_,g),u[y++]=p,u[y++]=b,u[y++]=_,u[y++]=g;if(s){const w=padPCKS(o.subarray(y*4));p^=w[0],b^=w[1],_^=w[2],g^=w[3],{s0:p,s1:b,s2:_,s3:g}=encrypt$2(c,p,b,_,g),u[y++]=p,u[y++]=b,u[y++]=_,u[y++]=g}return c.fill(0),f},decrypt:(o,a)=>{validateBlockDecrypt(o);const c=expandKeyDecLE(t),l=u32(n),u=getDst(o.length,a),f=u32(o),h=u32(u);let p=l[0],b=l[1],_=l[2],g=l[3];for(let y=0;y+4<=f.length;){const w=p,R=b,S=_,I=g;p=f[y+0],b=f[y+1],_=f[y+2],g=f[y+3];const{s0:O,s1:B,s2:C,s3:L}=decrypt$2(c,p,b,_,g);h[y++]=O^w,h[y++]=B^R,h[y++]=C^S,h[y++]=L^I}return c.fill(0),validatePCKS(u,s)}}}),_utf8ToBytes=e=>Uint8Array.from(e.split("").map(t=>t.charCodeAt(0))),sigma16=_utf8ToBytes("expand 16-byte k"),sigma32=_utf8ToBytes("expand 32-byte k"),sigma16_32=u32(sigma16),sigma32_32=u32(sigma32);sigma32_32.slice();function rotl(e,t){return e<<t|e>>>32-t}function isAligned32(e){return e.byteOffset%4===0}const BLOCK_LEN=64,BLOCK_LEN32=16,MAX_COUNTER=2**32-1,U32_EMPTY=new Uint32Array;function runCipher(e,t,n,r,s,o,a,c){const l=s.length,u=new Uint8Array(BLOCK_LEN),f=u32(u),h=isAligned32(s)&&isAligned32(o),p=h?u32(s):U32_EMPTY,b=h?u32(o):U32_EMPTY;for(let _=0;_<l;a++){if(e(t,n,r,f,a,c),a>=MAX_COUNTER)throw new Error("arx: counter overflow");const g=Math.min(BLOCK_LEN,l-_);if(h&&g===BLOCK_LEN){const y=_/4;if(_%4!==0)throw new Error("arx: invalid block position");for(let w=0,R;w<BLOCK_LEN32;w++)R=y+w,b[R]=p[R]^f[w];_+=BLOCK_LEN;continue}for(let y=0,w;y<g;y++)w=_+y,o[w]=s[w]^u[y];_+=g}}function createCipher(e,t){const{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:o,rounds:a}=checkOpts({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return number$1(s),number$1(a),bool(o),bool(n),(c,l,u,f,h=0)=>{bytes$1(c),bytes$1(l),bytes$1(u);const p=u.length;if(f||(f=new Uint8Array(p)),bytes$1(f),number$1(h),h<0||h>=MAX_COUNTER)throw new Error("arx: counter overflow");if(f.length<p)throw new Error(`arx: output (${f.length}) is shorter than data (${p})`);const b=[];let _=c.length,g,y;if(_===32)g=c.slice(),b.push(g),y=sigma32_32;else if(_===16&&n)g=new Uint8Array(32),g.set(c),g.set(c,16),y=sigma16_32,b.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${_}`);isAligned32(l)||(l=l.slice(),b.push(l));const w=u32(g);if(r){if(l.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(y,w,u32(l.subarray(0,16)),w),l=l.subarray(16)}const R=16-s;if(R!==l.length)throw new Error(`arx: nonce must be ${R} or 16 bytes`);if(R!==12){const I=new Uint8Array(12);I.set(l,o?0:12-l.length),l=I,b.push(l)}const S=u32(l);for(runCipher(e,y,w,S,u,f,h,a);b.length>0;)b.pop().fill(0);return f}}function chachaCore(e,t,n,r,s,o=20){let a=e[0],c=e[1],l=e[2],u=e[3],f=t[0],h=t[1],p=t[2],b=t[3],_=t[4],g=t[5],y=t[6],w=t[7],R=s,S=n[0],I=n[1],O=n[2],B=a,C=c,L=l,F=u,M=f,$=h,x=p,A=b,k=_,E=g,v=y,T=w,N=R,U=S,D=I,P=O;for(let z=0;z<o;z+=2)B=B+M|0,N=rotl(N^B,16),k=k+N|0,M=rotl(M^k,12),B=B+M|0,N=rotl(N^B,8),k=k+N|0,M=rotl(M^k,7),C=C+$|0,U=rotl(U^C,16),E=E+U|0,$=rotl($^E,12),C=C+$|0,U=rotl(U^C,8),E=E+U|0,$=rotl($^E,7),L=L+x|0,D=rotl(D^L,16),v=v+D|0,x=rotl(x^v,12),L=L+x|0,D=rotl(D^L,8),v=v+D|0,x=rotl(x^v,7),F=F+A|0,P=rotl(P^F,16),T=T+P|0,A=rotl(A^T,12),F=F+A|0,P=rotl(P^F,8),T=T+P|0,A=rotl(A^T,7),B=B+$|0,P=rotl(P^B,16),v=v+P|0,$=rotl($^v,12),B=B+$|0,P=rotl(P^B,8),v=v+P|0,$=rotl($^v,7),C=C+x|0,N=rotl(N^C,16),T=T+N|0,x=rotl(x^T,12),C=C+x|0,N=rotl(N^C,8),T=T+N|0,x=rotl(x^T,7),L=L+A|0,U=rotl(U^L,16),k=k+U|0,A=rotl(A^k,12),L=L+A|0,U=rotl(U^L,8),k=k+U|0,A=rotl(A^k,7),F=F+M|0,D=rotl(D^F,16),E=E+D|0,M=rotl(M^E,12),F=F+M|0,D=rotl(D^F,8),E=E+D|0,M=rotl(M^E,7);let H=0;r[H++]=a+B|0,r[H++]=c+C|0,r[H++]=l+L|0,r[H++]=u+F|0,r[H++]=f+M|0,r[H++]=h+$|0,r[H++]=p+x|0,r[H++]=b+A|0,r[H++]=_+k|0,r[H++]=g+E|0,r[H++]=y+v|0,r[H++]=w+T|0,r[H++]=R+N|0,r[H++]=S+U|0,r[H++]=I+D|0,r[H++]=O+P|0}const chacha20=createCipher(chachaCore,{counterRight:!1,counterLength:4,allowShortKeys:!1});let HMAC$1=class extends Hash$1{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,assert.hash(t);const r=toBytes$1(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(r.length>s?t.create().update(r).digest():r);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=t.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),o.fill(0)}update(t){return assert.exists(this),this.iHash.update(t),this}digestInto(t){assert.exists(this),assert.bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:o,blockLen:a,outputLen:c}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=a,t.outputLen=c,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const hmac$1=(e,t,n)=>new HMAC$1(e,t).update(n).digest();hmac$1.create=(e,t)=>new HMAC$1(e,t);function extract(e,t,n){return assert.hash(e),hmac$1(e,toBytes$1(n),toBytes$1(t))}const HKDF_COUNTER=new Uint8Array([0]),EMPTY_BUFFER=new Uint8Array;function expand(e,t,n,r=32){if(assert.hash(e),assert.number(r),r>255*e.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(r/e.outputLen);n===void 0&&(n=EMPTY_BUFFER);const o=new Uint8Array(s*e.outputLen),a=hmac$1.create(e,t),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let u=0;u<s;u++)HKDF_COUNTER[0]=u+1,c.update(u===0?EMPTY_BUFFER:l).update(n).update(HKDF_COUNTER).digestInto(l),o.set(l,e.outputLen*u),a._cloneInto(c);return a.destroy(),c.destroy(),l.fill(0),HKDF_COUNTER.fill(0),o.slice(0,r)}var __defProp=Object.defineProperty,__export=(e,t)=>{for(var n in t)__defProp(e,n,{get:t[n],enumerable:!0})},verifiedSymbol=Symbol("verified"),isRecord=e=>e instanceof Object;function validateEvent(e){if(!isRecord(e)||typeof e.kind!="number"||typeof e.content!="string"||typeof e.created_at!="number"||typeof e.pubkey!="string"||!e.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(e.tags))return!1;for(let t=0;t<e.tags.length;t++){let n=e.tags[t];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]=="object")return!1}return!0}var utils_exports={};__export(utils_exports,{Queue:()=>Queue$1,QueueNode:()=>QueueNode,binarySearch:()=>binarySearch,insertEventIntoAscendingList:()=>insertEventIntoAscendingList,insertEventIntoDescendingList:()=>insertEventIntoDescendingList,normalizeURL:()=>normalizeURL,utf8Decoder:()=>utf8Decoder,utf8Encoder:()=>utf8Encoder});var utf8Decoder=new TextDecoder("utf-8"),utf8Encoder=new TextEncoder;function normalizeURL(e){e.indexOf("://")===-1&&(e="wss://"+e);let t=new URL(e);return t.pathname=t.pathname.replace(/\/+/g,"/"),t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1)),(t.port==="80"&&t.protocol==="ws:"||t.port==="443"&&t.protocol==="wss:")&&(t.port=""),t.searchParams.sort(),t.hash="",t.toString()}function insertEventIntoDescendingList(e,t){const[n,r]=binarySearch(e,s=>t.id===s.id?0:t.created_at===s.created_at?-1:s.created_at-t.created_at);return r||e.splice(n,0,t),e}function insertEventIntoAscendingList(e,t){const[n,r]=binarySearch(e,s=>t.id===s.id?0:t.created_at===s.created_at?-1:t.created_at-s.created_at);return r||e.splice(n,0,t),e}function binarySearch(e,t){let n=0,r=e.length-1;for(;n<=r;){const s=Math.floor((n+r)/2),o=t(e[s]);if(o===0)return[s,!0];o<0?r=s-1:n=s+1}return[n,!1]}var QueueNode=class{constructor(e){m(this,"value");m(this,"next",null);m(this,"prev",null);this.value=e}},Queue$1=class{constructor(){m(this,"first");m(this,"last");this.first=null,this.last=null}enqueue(t){const n=new QueueNode(t);return this.last?this.last===this.first?(this.last=n,this.last.prev=this.first,this.first.next=n):(n.prev=this.last,this.last.next=n,this.last=n):(this.first=n,this.last=n),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const n=this.first;return this.first=null,this.last=null,n.value}const t=this.first;return this.first=t.next,t.value}},JS=class{generateSecretKey(){return schnorr$1.utils.randomPrivateKey()}getPublicKey(e){return bytesToHex$2(schnorr$1.getPublicKey(e))}finalizeEvent(e,t){const n=e;return n.pubkey=bytesToHex$2(schnorr$1.getPublicKey(t)),n.id=getEventHash$1(n),n.sig=bytesToHex$2(schnorr$1.sign(getEventHash$1(n),t)),n[verifiedSymbol]=!0,n}verifyEvent(e){if(typeof e[verifiedSymbol]=="boolean")return e[verifiedSymbol];const t=getEventHash$1(e);if(t!==e.id)return e[verifiedSymbol]=!1,!1;try{const n=schnorr$1.verify(e.sig,t,e.pubkey);return e[verifiedSymbol]=n,n}catch{return e[verifiedSymbol]=!1,!1}}};function serializeEvent(e){if(!validateEvent(e))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content])}function getEventHash$1(e){let t=sha256$1(utf8Encoder.encode(serializeEvent(e)));return bytesToHex$2(t)}var i=new JS,generateSecretKey=i.generateSecretKey,getPublicKey=i.getPublicKey,finalizeEvent=i.finalizeEvent,verifyEvent=i.verifyEvent,kinds_exports={};__export(kinds_exports,{Application:()=>Application,BadgeAward:()=>BadgeAward,BadgeDefinition:()=>BadgeDefinition,BlockedRelaysList:()=>BlockedRelaysList,BookmarkList:()=>BookmarkList,Bookmarksets:()=>Bookmarksets,Calendar:()=>Calendar,CalendarEventRSVP:()=>CalendarEventRSVP,ChannelCreation:()=>ChannelCreation,ChannelHideMessage:()=>ChannelHideMessage,ChannelMessage:()=>ChannelMessage,ChannelMetadata:()=>ChannelMetadata,ChannelMuteUser:()=>ChannelMuteUser,ClassifiedListing:()=>ClassifiedListing,ClientAuth:()=>ClientAuth,CommunitiesList:()=>CommunitiesList,CommunityDefinition:()=>CommunityDefinition,CommunityPostApproval:()=>CommunityPostApproval,Contacts:()=>Contacts,CreateOrUpdateProduct:()=>CreateOrUpdateProduct,CreateOrUpdateStall:()=>CreateOrUpdateStall,Curationsets:()=>Curationsets,Date:()=>Date2,DirectMessageRelaysList:()=>DirectMessageRelaysList,DraftClassifiedListing:()=>DraftClassifiedListing,DraftLong:()=>DraftLong,Emojisets:()=>Emojisets,EncryptedDirectMessage:()=>EncryptedDirectMessage,EventDeletion:()=>EventDeletion,FileMetadata:()=>FileMetadata,FileServerPreference:()=>FileServerPreference,Followsets:()=>Followsets,GenericRepost:()=>GenericRepost,Genericlists:()=>Genericlists,GiftWrap:()=>GiftWrap,HTTPAuth:()=>HTTPAuth,Handlerinformation:()=>Handlerinformation,Handlerrecommendation:()=>Handlerrecommendation,Highlights:()=>Highlights,InterestsList:()=>InterestsList,Interestsets:()=>Interestsets,JobFeedback:()=>JobFeedback,JobRequest:()=>JobRequest,JobResult:()=>JobResult,Label:()=>Label,LightningPubRPC:()=>LightningPubRPC,LiveChatMessage:()=>LiveChatMessage,LiveEvent:()=>LiveEvent,LongFormArticle:()=>LongFormArticle,Metadata:()=>Metadata,Mutelist:()=>Mutelist,NWCWalletInfo:()=>NWCWalletInfo,NWCWalletRequest:()=>NWCWalletRequest,NWCWalletResponse:()=>NWCWalletResponse,NostrConnect:()=>NostrConnect,OpenTimestamps:()=>OpenTimestamps,Pinlist:()=>Pinlist,PrivateDirectMessage:()=>PrivateDirectMessage,ProblemTracker:()=>ProblemTracker,ProfileBadges:()=>ProfileBadges,PublicChatsList:()=>PublicChatsList,Reaction:()=>Reaction,RecommendRelay:()=>RecommendRelay,RelayList:()=>RelayList,Relaysets:()=>Relaysets,Report:()=>Report,Reporting:()=>Reporting,Repost:()=>Repost,Seal:()=>Seal,SearchRelaysList:()=>SearchRelaysList,ShortTextNote:()=>ShortTextNote,Time:()=>Time,UserEmojiList:()=>UserEmojiList,UserStatuses:()=>UserStatuses,Zap:()=>Zap,ZapGoal:()=>ZapGoal,ZapRequest:()=>ZapRequest,classifyKind:()=>classifyKind,isEphemeralKind:()=>isEphemeralKind,isParameterizedReplaceableKind:()=>isParameterizedReplaceableKind,isRegularKind:()=>isRegularKind,isReplaceableKind:()=>isReplaceableKind});function isRegularKind(e){return 1e3<=e&&e<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(e)}function isReplaceableKind(e){return[0,3].includes(e)||1e4<=e&&e<2e4}function isEphemeralKind(e){return 2e4<=e&&e<3e4}function isParameterizedReplaceableKind(e){return 3e4<=e&&e<4e4}function classifyKind(e){return isRegularKind(e)?"regular":isReplaceableKind(e)?"replaceable":isEphemeralKind(e)?"ephemeral":isParameterizedReplaceableKind(e)?"parameterized":"unknown"}var Metadata=0,ShortTextNote=1,RecommendRelay=2,Contacts=3,EncryptedDirectMessage=4,EventDeletion=5,Repost=6,Reaction=7,BadgeAward=8,Seal=13,PrivateDirectMessage=14,GenericRepost=16,ChannelCreation=40,ChannelMetadata=41,ChannelMessage=42,ChannelHideMessage=43,ChannelMuteUser=44,OpenTimestamps=1040,GiftWrap=1059,FileMetadata=1063,LiveChatMessage=1311,ProblemTracker=1971,Report=1984,Reporting=1984,Label=1985,CommunityPostApproval=4550,JobRequest=5999,JobResult=6999,JobFeedback=7e3,ZapGoal=9041,ZapRequest=9734,Zap=9735,Highlights=9802,Mutelist=1e4,Pinlist=10001,RelayList=10002,BookmarkList=10003,CommunitiesList=10004,PublicChatsList=10005,BlockedRelaysList=10006,SearchRelaysList=10007,InterestsList=10015,UserEmojiList=10030,DirectMessageRelaysList=10050,FileServerPreference=10096,NWCWalletInfo=13194,LightningPubRPC=21e3,ClientAuth=22242,NWCWalletRequest=23194,NWCWalletResponse=23195,NostrConnect=24133,HTTPAuth=27235,Followsets=3e4,Genericlists=30001,Relaysets=30002,Bookmarksets=30003,Curationsets=30004,ProfileBadges=30008,BadgeDefinition=30009,Interestsets=30015,CreateOrUpdateStall=30017,CreateOrUpdateProduct=30018,LongFormArticle=30023,DraftLong=30024,Emojisets=30030,Application=30078,LiveEvent=30311,UserStatuses=30315,ClassifiedListing=30402,DraftClassifiedListing=30403,Date2=31922,Time=31923,Calendar=31924,CalendarEventRSVP=31925,Handlerrecommendation=31989,Handlerinformation=31990,CommunityDefinition=34550;function matchFilter(e,t){if(e.ids&&e.ids.indexOf(t.id)===-1||e.kinds&&e.kinds.indexOf(t.kind)===-1||e.authors&&e.authors.indexOf(t.pubkey)===-1)return!1;for(let n in e)if(n[0]==="#"){let r=n.slice(1),s=e[`#${r}`];if(s&&!t.tags.find(([o,a])=>o===n.slice(1)&&s.indexOf(a)!==-1))return!1}return!(e.since&&t.created_at<e.since||e.until&&t.created_at>e.until)}function matchFilters(e,t){for(let n=0;n<e.length;n++)if(matchFilter(e[n],t))return!0;return!1}var fakejson_exports={};__export(fakejson_exports,{getHex64:()=>getHex64,getInt:()=>getInt,getSubscriptionId:()=>getSubscriptionId,matchEventId:()=>matchEventId,matchEventKind:()=>matchEventKind,matchEventPubkey:()=>matchEventPubkey});function getHex64(e,t){let n=t.length+3,r=e.indexOf(`"${t}":`)+n,s=e.slice(r).indexOf('"')+r+1;return e.slice(s,s+64)}function getInt(e,t){let n=t.length,r=e.indexOf(`"${t}":`)+n+3,s=e.slice(r),o=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,o),10)}function getSubscriptionId(e){let t=e.slice(0,22).indexOf('"EVENT"');if(t===-1)return null;let n=e.slice(t+7+1).indexOf('"');if(n===-1)return null;let r=t+7+1+n,s=e.slice(r+1,80).indexOf('"');if(s===-1)return null;let o=r+1+s;return e.slice(r+1,o)}function matchEventId(e,t){return t===getHex64(e,"id")}function matchEventPubkey(e,t){return t===getHex64(e,"pubkey")}function matchEventKind(e,t){return t===getInt(e,"kind")}var nip42_exports={};__export(nip42_exports,{makeAuthEvent:()=>makeAuthEvent});function makeAuthEvent(e,t){return{kind:ClientAuth,created_at:Math.floor(Date.now()/1e3),tags:[["relay",e],["challenge",t]],content:""}}var _WebSocket;try{_WebSocket=WebSocket}catch{}var _WebSocket2;try{_WebSocket2=WebSocket}catch{}var nip19_exports={};__export(nip19_exports,{BECH32_REGEX:()=>BECH32_REGEX$1,Bech32MaxSize:()=>Bech32MaxSize,NostrTypeGuard:()=>NostrTypeGuard,decode:()=>decode,encodeBytes:()=>encodeBytes,naddrEncode:()=>naddrEncode,neventEncode:()=>neventEncode,noteEncode:()=>noteEncode,nprofileEncode:()=>nprofileEncode,npubEncode:()=>npubEncode,nsecEncode:()=>nsecEncode});var NostrTypeGuard={isNProfile:e=>/^nprofile1[a-z\d]+$/.test(e||""),isNRelay:e=>/^nrelay1[a-z\d]+$/.test(e||""),isNEvent:e=>/^nevent1[a-z\d]+$/.test(e||""),isNAddr:e=>/^naddr1[a-z\d]+$/.test(e||""),isNSec:e=>/^nsec1[a-z\d]{58}$/.test(e||""),isNPub:e=>/^npub1[a-z\d]{58}$/.test(e||""),isNote:e=>/^note1[a-z\d]+$/.test(e||""),isNcryptsec:e=>/^ncryptsec1[a-z\d]+$/.test(e||"")},Bech32MaxSize=5e3,BECH32_REGEX$1=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function integerToUint8Array(e){const t=new Uint8Array(4);return t[0]=e>>24&255,t[1]=e>>16&255,t[2]=e>>8&255,t[3]=e&255,t}function decode(e){var s,o,a,c,l,u,f;let{prefix:t,words:n}=bech32$1.decode(e,Bech32MaxSize),r=new Uint8Array(bech32$1.fromWords(n));switch(t){case"nprofile":{let h=parseTLV(r);if(!((s=h[0])!=null&&s[0]))throw new Error("missing TLV 0 for nprofile");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[]}}}case"nevent":{let h=parseTLV(r);if(!((o=h[0])!=null&&o[0]))throw new Error("missing TLV 0 for nevent");if(h[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(h[2]&&h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(h[3]&&h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:bytesToHex$2(h[0][0]),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[],author:(a=h[2])!=null&&a[0]?bytesToHex$2(h[2][0]):void 0,kind:(c=h[3])!=null&&c[0]?parseInt(bytesToHex$2(h[3][0]),16):void 0}}}case"naddr":{let h=parseTLV(r);if(!((l=h[0])!=null&&l[0]))throw new Error("missing TLV 0 for naddr");if(!((u=h[2])!=null&&u[0]))throw new Error("missing TLV 2 for naddr");if(h[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!((f=h[3])!=null&&f[0]))throw new Error("missing TLV 3 for naddr");if(h[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:utf8Decoder.decode(h[0][0]),pubkey:bytesToHex$2(h[2][0]),kind:parseInt(bytesToHex$2(h[3][0]),16),relays:h[1]?h[1].map(p=>utf8Decoder.decode(p)):[]}}}case"nsec":return{type:t,data:r};case"npub":case"note":return{type:t,data:bytesToHex$2(r)};default:throw new Error(`unknown prefix ${t}`)}}function parseTLV(e){let t={},n=e;for(;n.length>0;){let r=n[0],s=n[1],o=n.slice(2,2+s);if(n=n.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${r}`);t[r]=t[r]||[],t[r].push(o)}return t}function nsecEncode(e){return encodeBytes("nsec",e)}function npubEncode(e){return encodeBytes("npub",hexToBytes$2(e))}function noteEncode(e){return encodeBytes("note",hexToBytes$2(e))}function encodeBech32(e,t){let n=bech32$1.toWords(t);return bech32$1.encode(e,n,Bech32MaxSize)}function encodeBytes(e,t){return encodeBech32(e,t)}function nprofileEncode(e){let t=encodeTLV({0:[hexToBytes$2(e.pubkey)],1:(e.relays||[]).map(n=>utf8Encoder.encode(n))});return encodeBech32("nprofile",t)}function neventEncode(e){let t;e.kind!==void 0&&(t=integerToUint8Array(e.kind));let n=encodeTLV({0:[hexToBytes$2(e.id)],1:(e.relays||[]).map(r=>utf8Encoder.encode(r)),2:e.author?[hexToBytes$2(e.author)]:[],3:t?[new Uint8Array(t)]:[]});return encodeBech32("nevent",n)}function naddrEncode(e){let t=new ArrayBuffer(4);new DataView(t).setUint32(0,e.kind,!1);let n=encodeTLV({0:[utf8Encoder.encode(e.identifier)],1:(e.relays||[]).map(r=>utf8Encoder.encode(r)),2:[hexToBytes$2(e.pubkey)],3:[new Uint8Array(t)]});return encodeBech32("naddr",n)}function encodeTLV(e){let t=[];return Object.entries(e).reverse().forEach(([n,r])=>{r.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(n)],0),o.set([s.length],1),o.set(s,2),t.push(o)})}),concatBytes$2(...t)}var nip04_exports={};__export(nip04_exports,{decrypt:()=>decrypt$1,encrypt:()=>encrypt$1});async function encrypt$1(e,t,n){const r=e instanceof Uint8Array?bytesToHex$2(e):e,s=secp256k1$1.getSharedSecret(r,"02"+t),o=getNormalizedX(s);let a=Uint8Array.from(randomBytes$1(16)),c=utf8Encoder.encode(n),l=cbc(o,a).encrypt(c),u=base64.encode(new Uint8Array(l)),f=base64.encode(new Uint8Array(a.buffer));return`${u}?iv=${f}`}async function decrypt$1(e,t,n){const r=e instanceof Uint8Array?bytesToHex$2(e):e;let[s,o]=n.split("?iv="),a=secp256k1$1.getSharedSecret(r,"02"+t),c=getNormalizedX(a),l=base64.decode(o),u=base64.decode(s),f=cbc(c,l).decrypt(u);return utf8Decoder.decode(f)}function getNormalizedX(e){return e.slice(1,33)}var nip05_exports={};__export(nip05_exports,{NIP05_REGEX:()=>NIP05_REGEX$1,isNip05:()=>isNip05,isValid:()=>isValid,queryProfile:()=>queryProfile,searchDomain:()=>searchDomain,useFetchImplementation:()=>useFetchImplementation});var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,isNip05=e=>NIP05_REGEX$1.test(e||""),_fetch;try{_fetch=fetch}catch{}function useFetchImplementation(e){_fetch=e}async function searchDomain(e,t=""){try{const n=`https://${e}/.well-known/nostr.json?name=${t}`;return(await(await _fetch(n,{redirect:"error"})).json()).names}catch{return{}}}async function queryProfile(e){var o;const t=e.match(NIP05_REGEX$1);if(!t)return null;const[n,r="_",s]=t;try{const a=`https://${s}/.well-known/nostr.json?name=${r}`,c=await(await _fetch(a,{redirect:"error"})).json();let l=c.names[r];return l?{pubkey:l,relays:(o=c.relays)==null?void 0:o[l]}:null}catch{return null}}async function isValid(e,t){let n=await queryProfile(t);return n?n.pubkey===e:!1}var nip10_exports={};__export(nip10_exports,{parse:()=>parse});function parse(e){const t={reply:void 0,root:void 0,mentions:[],profiles:[]},n=[];for(const r of e.tags)r[0]==="e"&&r[1]&&n.push(r),r[0]==="p"&&r[1]&&t.profiles.push({pubkey:r[1],relays:r[2]?[r[2]]:[]});for(let r=0;r<n.length;r++){const s=n[r],[o,a,c,l]=s,u={id:a,relays:c?[c]:[]},f=r===0,h=r===n.length-1;if(l==="root"){t.root=u;continue}if(l==="reply"){t.reply=u;continue}if(l==="mention"){t.mentions.push(u);continue}if(f){t.root=u;continue}if(h){t.reply=u;continue}t.mentions.push(u)}return t}var nip11_exports={};__export(nip11_exports,{fetchRelayInformation:()=>fetchRelayInformation,useFetchImplementation:()=>useFetchImplementation2});var _fetch2;try{_fetch2=fetch}catch{}function useFetchImplementation2(e){_fetch2=e}async function fetchRelayInformation(e){return await(await fetch(e.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var nip13_exports={};__export(nip13_exports,{getPow:()=>getPow,minePow:()=>minePow});function getPow(e){let t=0;for(let n=0;n<e.length;n++){const r=parseInt(e[n],16);if(r===0)t+=4;else{t+=Math.clz32(r)-28;break}}return t}function minePow(e,t){let n=0;const r=e,s=["nonce",n.toString(),t.toString()];for(r.tags.push(s);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==r.created_at&&(n=0,r.created_at=o),s[1]=(++n).toString(),r.id=getEventHash$1(r),getPow(r.id)>=t)break}return r}var nip18_exports={};__export(nip18_exports,{finishRepostEvent:()=>finishRepostEvent,getRepostedEvent:()=>getRepostedEvent,getRepostedEventPointer:()=>getRepostedEventPointer});function finishRepostEvent(e,t,n,r){return finalizeEvent({kind:Repost,tags:[...e.tags??[],["e",t.id,n],["p",t.pubkey]],content:e.content===""?"":JSON.stringify(t),created_at:e.created_at},r)}function getRepostedEventPointer(e){if(e.kind!==Repost)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){const s=e.tags[r];s.length>=2&&(s[0]==="e"&&t===void 0?t=s:s[0]==="p"&&n===void 0&&(n=s))}if(t!==void 0)return{id:t[1],relays:[t[2],n==null?void 0:n[2]].filter(r=>typeof r=="string"),author:n==null?void 0:n[1]}}function getRepostedEvent(e,{skipVerification:t}={}){const n=getRepostedEventPointer(e);if(n===void 0||e.content==="")return;let r;try{r=JSON.parse(e.content)}catch{return}if(r.id===n.id&&!(!t&&!verifyEvent(r)))return r}var nip21_exports={};__export(nip21_exports,{NOSTR_URI_REGEX:()=>NOSTR_URI_REGEX,parse:()=>parse2,test:()=>test});var NOSTR_URI_REGEX=new RegExp(`nostr:(${BECH32_REGEX$1.source})`);function test(e){return typeof e=="string"&&new RegExp(`^${NOSTR_URI_REGEX.source}$`).test(e)}function parse2(e){const t=e.match(new RegExp(`^${NOSTR_URI_REGEX.source}$`));if(!t)throw new Error(`Invalid Nostr URI: ${e}`);return{uri:t[0],value:t[1],decoded:decode(t[1])}}var nip25_exports={};__export(nip25_exports,{finishReactionEvent:()=>finishReactionEvent,getReactedEventPointer:()=>getReactedEventPointer});function finishReactionEvent(e,t,n){const r=t.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return finalizeEvent({...e,kind:Reaction,tags:[...e.tags??[],...r,["e",t.id],["p",t.pubkey]],content:e.content??"+"},n)}function getReactedEventPointer(e){if(e.kind!==Reaction)return;let t,n;for(let r=e.tags.length-1;r>=0&&(t===void 0||n===void 0);r--){const s=e.tags[r];s.length>=2&&(s[0]==="e"&&t===void 0?t=s:s[0]==="p"&&n===void 0&&(n=s))}if(!(t===void 0||n===void 0))return{id:t[1],relays:[t[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var nip27_exports={};__export(nip27_exports,{matchAll:()=>matchAll,regex:()=>regex,replaceAll:()=>replaceAll});var regex=()=>new RegExp(`\\b${NOSTR_URI_REGEX.source}\\b`,"g");function*matchAll(e){const t=e.matchAll(regex());for(const n of t)try{const[r,s]=n;yield{uri:r,value:s,decoded:decode(s),start:n.index,end:n.index+r.length}}catch{}}function replaceAll(e,t){return e.replaceAll(regex(),(n,r)=>t({uri:n,value:r,decoded:decode(r)}))}var nip28_exports={};__export(nip28_exports,{channelCreateEvent:()=>channelCreateEvent,channelHideMessageEvent:()=>channelHideMessageEvent,channelMessageEvent:()=>channelMessageEvent,channelMetadataEvent:()=>channelMetadataEvent,channelMuteUserEvent:()=>channelMuteUserEvent});var channelCreateEvent=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return finalizeEvent({kind:ChannelCreation,tags:[...e.tags??[]],content:n,created_at:e.created_at},t)},channelMetadataEvent=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return finalizeEvent({kind:ChannelMetadata,tags:[["e",e.channel_create_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},channelMessageEvent=(e,t)=>{const n=[["e",e.channel_create_event_id,e.relay_url,"root"]];return e.reply_to_channel_message_event_id&&n.push(["e",e.reply_to_channel_message_event_id,e.relay_url,"reply"]),finalizeEvent({kind:ChannelMessage,tags:[...n,...e.tags??[]],content:e.content,created_at:e.created_at},t)},channelHideMessageEvent=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return finalizeEvent({kind:ChannelHideMessage,tags:[["e",e.channel_message_event_id],...e.tags??[]],content:n,created_at:e.created_at},t)},channelMuteUserEvent=(e,t)=>{let n;if(typeof e.content=="object")n=JSON.stringify(e.content);else if(typeof e.content=="string")n=e.content;else return;return finalizeEvent({kind:ChannelMuteUser,tags:[["p",e.pubkey_to_mute],...e.tags??[]],content:n,created_at:e.created_at},t)},nip30_exports={};__export(nip30_exports,{EMOJI_SHORTCODE_REGEX:()=>EMOJI_SHORTCODE_REGEX,matchAll:()=>matchAll2,regex:()=>regex2,replaceAll:()=>replaceAll2});var EMOJI_SHORTCODE_REGEX=/:(\w+):/,regex2=()=>new RegExp(`\\B${EMOJI_SHORTCODE_REGEX.source}\\B`,"g");function*matchAll2(e){const t=e.matchAll(regex2());for(const n of t)try{const[r,s]=n;yield{shortcode:r,name:s,start:n.index,end:n.index+r.length}}catch{}}function replaceAll2(e,t){return e.replaceAll(regex2(),(n,r)=>t({shortcode:n,name:r}))}var nip39_exports={};__export(nip39_exports,{useFetchImplementation:()=>useFetchImplementation3,validateGithub:()=>validateGithub});var _fetch3;try{_fetch3=fetch}catch{}function useFetchImplementation3(e){_fetch3=e}async function validateGithub(e,t,n){try{return await(await _fetch3(`https://gist.github.com/${t}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${e}`}catch{return!1}}var nip44_exports={};__export(nip44_exports,{decrypt:()=>decrypt2,encrypt:()=>encrypt2,getConversationKey:()=>getConversationKey,v2:()=>v2});var minPlaintextSize=1,maxPlaintextSize=65535;function getConversationKey(e,t){const n=secp256k1$1.getSharedSecret(e,"02"+t).subarray(1,33);return extract(sha256$1,n,"nip44-v2")}function getMessageKeys(e,t){const n=expand(sha256$1,e,t,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function calcPaddedLen(e){if(!Number.isSafeInteger(e)||e<1)throw new Error("expected positive integer");if(e<=32)return 32;const t=1<<Math.floor(Math.log2(e-1))+1,n=t<=256?32:t/8;return n*(Math.floor((e-1)/n)+1)}function writeU16BE(e){if(!Number.isSafeInteger(e)||e<minPlaintextSize||e>maxPlaintextSize)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const t=new Uint8Array(2);return new DataView(t.buffer).setUint16(0,e,!1),t}function pad(e){const t=utf8Encoder.encode(e),n=t.length,r=writeU16BE(n),s=new Uint8Array(calcPaddedLen(n)-n);return concatBytes$2(r,t,s)}function unpad(e){const t=new DataView(e.buffer).getUint16(0),n=e.subarray(2,2+t);if(t<minPlaintextSize||t>maxPlaintextSize||n.length!==t||e.length!==2+calcPaddedLen(t))throw new Error("invalid padding");return utf8Decoder.decode(n)}function hmacAad(e,t,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=concatBytes$2(n,t);return hmac$1(sha256$1,e,r)}function decodePayload(e){if(typeof e!="string")throw new Error("payload must be a valid string");const t=e.length;if(t<132||t>87472)throw new Error("invalid payload length: "+t);if(e[0]==="#")throw new Error("unknown encryption version");let n;try{n=base64.decode(e)}catch(o){throw new Error("invalid base64: "+o.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const s=n[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function encrypt2(e,t,n=randomBytes$1(32)){const{chacha_key:r,chacha_nonce:s,hmac_key:o}=getMessageKeys(t,n),a=pad(e),c=chacha20(r,s,a),l=hmacAad(o,c,n);return base64.encode(concatBytes$2(new Uint8Array([2]),n,c,l))}function decrypt2(e,t){const{nonce:n,ciphertext:r,mac:s}=decodePayload(e),{chacha_key:o,chacha_nonce:a,hmac_key:c}=getMessageKeys(t,n),l=hmacAad(c,r,n);if(!equalBytes$1(l,s))throw new Error("invalid MAC");const u=chacha20(o,a,r);return unpad(u)}var v2={utils:{getConversationKey,calcPaddedLen},encrypt:encrypt2,decrypt:decrypt2},nip47_exports={};__export(nip47_exports,{makeNwcRequestEvent:()=>makeNwcRequestEvent,parseConnectionString:()=>parseConnectionString});function parseConnectionString(e){const{pathname:t,searchParams:n}=new URL(e),r=t,s=n.get("relay"),o=n.get("secret");if(!r||!s||!o)throw new Error("invalid connection string");return{pubkey:r,relay:s,secret:o}}async function makeNwcRequestEvent(e,t,n){const s=await encrypt$1(t,e,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),o={kind:NWCWalletRequest,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",e]]};return finalizeEvent(o,t)}var nip57_exports={};__export(nip57_exports,{getZapEndpoint:()=>getZapEndpoint,makeZapReceipt:()=>makeZapReceipt,makeZapRequest:()=>makeZapRequest,useFetchImplementation:()=>useFetchImplementation4,validateZapRequest:()=>validateZapRequest});var _fetch4;try{_fetch4=fetch}catch{}function useFetchImplementation4(e){_fetch4=e}async function getZapEndpoint(e){try{let t="",{lud06:n,lud16:r}=JSON.parse(e.content);if(n){let{words:a}=bech32$1.decode(n,1e3),c=bech32$1.fromWords(a);t=utf8Decoder.decode(c)}else if(r){let[a,c]=r.split("@");t=new URL(`/.well-known/lnurlp/${a}`,`https://${c}`).toString()}else return null;let o=await(await _fetch4(t)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function makeZapRequest({profile:e,event:t,amount:n,relays:r,comment:s=""}){if(!n)throw new Error("amount not given");if(!e)throw new Error("profile not given");let o={kind:9734,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",e],["amount",n.toString()],["relays",...r]]};return t&&o.tags.push(["e",t]),o}function validateZapRequest(e){let t;try{t=JSON.parse(e)}catch{return"Invalid zap request JSON."}if(!validateEvent(t))return"Zap request is not a valid Nostr event.";if(!verifyEvent(t))return"Invalid signature on zap request.";let n=t.tags.find(([o,a])=>o==="p"&&a);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=t.tags.find(([o,a])=>o==="e"&&a);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":t.tags.find(([o,a])=>o==="relays"&&a)?null:"Zap request doesn't have a 'relays' tag."}function makeZapReceipt({zapRequest:e,preimage:t,bolt11:n,paidAt:r}){let s=JSON.parse(e),o=s.tags.filter(([c])=>c==="e"||c==="p"||c==="a"),a={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...o,["P",s.pubkey],["bolt11",n],["description",e]]};return t&&a.tags.push(["preimage",t]),a}var nip59_exports={};__export(nip59_exports,{createRumor:()=>createRumor,createSeal:()=>createSeal,createWrap:()=>createWrap,unwrapEvent:()=>unwrapEvent,wrapEvent:()=>wrapEvent});var TWO_DAYS=2*24*60*60,now=()=>Math.round(Date.now()/1e3),randomNow=()=>Math.round(now()-Math.random()*TWO_DAYS),nip44ConversationKey=(e,t)=>getConversationKey(e,t),nip44Encrypt=(e,t,n)=>encrypt2(JSON.stringify(e),nip44ConversationKey(t,n)),nip44Decrypt=(e,t)=>JSON.parse(decrypt2(e.content,nip44ConversationKey(t,e.pubkey)));function createRumor(e,t){const n={created_at:now(),content:"",tags:[],...e,pubkey:getPublicKey(t)};return n.id=getEventHash$1(n),n}function createSeal(e,t,n){return finalizeEvent({kind:Seal,content:nip44Encrypt(e,t,n),created_at:randomNow(),tags:[]},t)}function createWrap(e,t){const n=generateSecretKey();return finalizeEvent({kind:GiftWrap,content:nip44Encrypt(e,n,t),created_at:randomNow(),tags:[["p",t]]},n)}function wrapEvent(e,t,n){const r=createRumor(e,t),s=createSeal(r,t,n);return createWrap(s,n)}function unwrapEvent(e,t){const n=nip44Decrypt(e,t);return nip44Decrypt(n,t)}var nip98_exports={};__export(nip98_exports,{getToken:()=>getToken,hashPayload:()=>hashPayload,unpackEventFromToken:()=>unpackEventFromToken,validateEvent:()=>validateEvent2,validateEventKind:()=>validateEventKind,validateEventMethodTag:()=>validateEventMethodTag,validateEventPayloadTag:()=>validateEventPayloadTag,validateEventTimestamp:()=>validateEventTimestamp,validateEventUrlTag:()=>validateEventUrlTag,validateToken:()=>validateToken});var _authorizationScheme="Nostr ";async function getToken(e,t,n,r=!1,s){const o={kind:HTTPAuth,tags:[["u",e],["method",t]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&o.tags.push(["payload",hashPayload(s)]);const a=await n(o);return(r?_authorizationScheme:"")+base64.encode(utf8Encoder.encode(JSON.stringify(a)))}async function validateToken(e,t,n){const r=await unpackEventFromToken(e).catch(o=>{throw o});return await validateEvent2(r,t,n).catch(o=>{throw o})}async function unpackEventFromToken(e){if(!e)throw new Error("Missing token");e=e.replace(_authorizationScheme,"");const t=utf8Decoder.decode(base64.decode(e));if(!t||t.length===0||!t.startsWith("{"))throw new Error("Invalid token");return JSON.parse(t)}function validateEventTimestamp(e){return e.created_at?Math.round(new Date().getTime()/1e3)-e.created_at<60:!1}function validateEventKind(e){return e.kind===HTTPAuth}function validateEventUrlTag(e,t){const n=e.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===t:!1}function validateEventMethodTag(e,t){const n=e.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===t.toLowerCase():!1}function hashPayload(e){const t=sha256$1(utf8Encoder.encode(JSON.stringify(e)));return bytesToHex$2(t)}function validateEventPayloadTag(e,t){const n=e.tags.find(s=>s[0]==="payload");if(!n)return!1;const r=hashPayload(t);return n.length>0&&n[1]===r}async function validateEvent2(e,t,n,r){if(!verifyEvent(e))throw new Error("Invalid nostr event, signature invalid");if(!validateEventKind(e))throw new Error("Invalid nostr event, kind invalid");if(!validateEventTimestamp(e))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!validateEventUrlTag(e,t))throw new Error("Invalid nostr event, url tag invalid");if(!validateEventMethodTag(e,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!validateEventPayloadTag(e,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var lib$1={},types={};Object.defineProperty(types,"__esModule",{value:!0});var ee={},taskCollection$1={},taskCollection={},utils$1={};Object.defineProperty(utils$1,"__esModule",{value:!0});utils$1._fast_remove_single=void 0;function _fast_remove_single(e,t){t!==-1&&(t===0?e.shift():t===e.length-1?e.length=e.length-1:e.splice(t,1))}utils$1._fast_remove_single=_fast_remove_single;var bakeCollection={};(function(exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.bakeCollectionVariadic=exports.bakeCollectionAwait=exports.bakeCollection=exports.BAKED_EMPTY_FUNC=void 0,exports.BAKED_EMPTY_FUNC=function(){};var FORLOOP_FALLBACK=1500;function generateArgsDefCode(e){var t="";if(e===0)return t;for(var n=0;n<e-1;++n)t+="arg"+String(n)+", ";return t+="arg"+String(e-1),t}function generateBodyPartsCode(e,t){for(var n="",r="",s=0;s<t;++s)n+="var f".concat(s," = collection[").concat(s,`];
`),r+="f".concat(s,"(").concat(e,`)
`);return{funcDefCode:n,funcCallCode:r}}function generateBodyPartsVariadicCode(e){for(var t="",n="",r=0;r<e;++r)t+="var f".concat(r," = collection[").concat(r,`];
`),n+="f".concat(r,`.apply(undefined, arguments)
`);return{funcDefCode:t,funcCallCode:n}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection);var __spreadArray$1=commonjsGlobal&&commonjsGlobal.__spreadArray||function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))};Object.defineProperty(taskCollection,"__esModule",{value:!0});taskCollection.TaskCollection=void 0;var utils_1$1=utils$1,bake_collection_1=bakeCollection;function push_norebuild(e,t){var n=this.length;if(n>1)if(t){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(e),this.length++;else if(t){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,e]:this._tasks=e,this.length++}function push_rebuild(e,t){var n=this.length;if(n>1)if(t){var r;(r=this._tasks).push.apply(r,arguments),this.length+=arguments.length}else this._tasks.push(e),this.length++;else if(t){if(n===1){var s=Array(1+arguments.length);s.push(s),s.push.apply(s,arguments),this._tasks=s}else{var s=Array(arguments.length);s.push.apply(s,arguments),this._tasks=s}this.length+=arguments.length}else n===1?this._tasks=[this._tasks,e]:this._tasks=e,this.length++;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function removeLast_norebuild(e){this.length!==0&&(this.length===1?this._tasks===e&&(this.length=0):((0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(e)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function removeLast_rebuild(e){if(this.length!==0){if(this.length===1)if(this._tasks===e&&(this.length=0),this.firstEmitBuildStrategy){this.call=bake_collection_1.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,utils_1$1._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(e)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}}function insert_norebuild(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((t=this._tasks).splice.apply(t,__spreadArray$1([e,0],n,!1)),this.length=this._tasks.length)}function insert_rebuild(e){for(var t,n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];this.length===0?(this._tasks=n,this.length=1):this.length===1?(n.unshift(this._tasks),this._tasks=n,this.length=this._tasks.length):((t=this._tasks).splice.apply(t,__spreadArray$1([e,0],n,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild()}function rebuild_noawait(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollection)(this._tasks,this.argsNum)}function rebuild_await(){this.length===0?this.call=bake_collection_1.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,bake_collection_1.bakeCollectionAwait)(this._tasks,this.argsNum)}function rebuild_on_first_call(){this.rebuild(),this.call.apply(void 0,arguments)}var TaskCollection=function(){function e(t,n,r,s){n===void 0&&(n=!0),r===void 0&&(r=null),s===void 0&&(s=!1),this.awaitTasks=s,this.call=bake_collection_1.BAKED_EMPTY_FUNC,this.argsNum=t,this.firstEmitBuildStrategy=!0,s?this.rebuild=rebuild_await.bind(this):this.rebuild=rebuild_noawait.bind(this),this.setAutoRebuild(n),r?typeof r=="function"?(this._tasks=r,this.length=1):(this._tasks=r,this.length=r.length):(this._tasks=null,this.length=0),n&&this.rebuild()}return e}();taskCollection.TaskCollection=TaskCollection;function fastClear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function clear(){this._tasks=null,this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC}function growArgsNum(e){this.argsNum<e&&(this.argsNum=e,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}function setAutoRebuild(e){e?(this.push=push_rebuild.bind(this),this.insert=insert_rebuild.bind(this),this.removeLast=removeLast_rebuild.bind(this)):(this.push=push_norebuild.bind(this),this.insert=insert_norebuild.bind(this),this.removeLast=removeLast_norebuild.bind(this))}function tasksAsArray(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function setTasks(e){e.length===0?(this.length=0,this.call=bake_collection_1.BAKED_EMPTY_FUNC):e.length===1?(this.length=1,this.call=e[0],this._tasks=e[0]):(this.length=e.length,this._tasks=e,this.firstEmitBuildStrategy?this.call=rebuild_on_first_call:this.rebuild())}TaskCollection.prototype.fastClear=fastClear;TaskCollection.prototype.clear=clear;TaskCollection.prototype.growArgsNum=growArgsNum;TaskCollection.prototype.setAutoRebuild=setAutoRebuild;TaskCollection.prototype.tasksAsArray=tasksAsArray;TaskCollection.prototype.setTasks=setTasks;(function(e){var t=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(s,o);(!c||("get"in c?!s.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,c)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&t(s,r,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(taskCollection,e)})(taskCollection$1);var utils={};Object.defineProperty(utils,"__esModule",{value:!0});utils.nullObj=void 0;function nullObj(){var e={};return e.__proto__=null,e}utils.nullObj=nullObj;var __spreadArray=commonjsGlobal&&commonjsGlobal.__spreadArray||function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))};Object.defineProperty(ee,"__esModule",{value:!0});ee.EventEmitter=void 0;var task_collection_1=taskCollection$1,utils_1=utils$1,utils_2=utils;function emit(e,t,n,r,s,o){var a=this.events[e];if(a){if(a.length===0)return!1;if(a.argsNum<6)a.call(t,n,r,s,o);else{for(var c=new Array(a.argsNum),l=0,u=c.length;l<u;++l)c[l]=arguments[l+1];a.call.apply(void 0,c)}return!0}return!1}function emitHasOnce(e,t,n,r,s,o){var a=this.events[e],c;if(a!==void 0){if(a.length===0)return!1;if(a.argsNum<6)a.call(t,n,r,s,o);else{c=new Array(a.argsNum);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1];a.call.apply(void 0,c)}}var f=this.onceEvents[e];if(f){if(typeof f=="function")if(this.onceEvents[e]=void 0,arguments.length<6)f(t,n,r,s,o);else{if(c===void 0){c=new Array(arguments.length-1);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1]}f.apply(void 0,c)}else{var h=f;if(this.onceEvents[e]=void 0,arguments.length<6)for(var l=0;l<h.length;++l)h[l](t,n,r,s,o);else{if(c===void 0){c=new Array(arguments.length-1);for(var l=0,u=c.length;l<u;++l)c[l]=arguments[l+1]}for(var l=0;l<h.length;++l)h[l].apply(void 0,c)}}return!0}return a!==void 0}var EventEmitter=function(){function e(){this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(e.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),e}();ee.EventEmitter=EventEmitter;function once(e,t){switch(this.emit===emit&&(this.emit=emitHasOnce),typeof this.onceEvents[e]){case"undefined":this.onceEvents[e]=t,typeof e=="symbol"&&this._symbolKeys.add(e);break;case"function":this.onceEvents[e]=[this.onceEvents[e],t];break;case"object":this.onceEvents[e].push(t)}return this}function addListener(e,t,n){if(n===void 0&&(n=t.length),typeof t!="function")throw new TypeError("The listener must be a function");var r=this.events[e];return r?(r.push(t),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(e),'" event!'))):(this.events[e]=new task_collection_1.TaskCollection(n,!0,t,!1),typeof e=="symbol"&&this._symbolKeys.add(e)),this}function removeListener(e,t){var n=this.events[e];n&&n.removeLast(t);var r=this.onceEvents[e];return r&&(typeof r=="function"?this.onceEvents[e]=void 0:typeof r=="object"&&(r.length===1&&r[0]===t?this.onceEvents[e]=void 0:(0,utils_1._fast_remove_single)(r,r.lastIndexOf(t)))),this}function addListenerBound(e,t,n,r){n===void 0&&(n=this),r===void 0&&(r=t.length),this.boundFuncs||(this.boundFuncs=new Map);var s=t.bind(n);return this.boundFuncs.set(t,s),this.addListener(e,s,r)}function removeListenerBound(e,t){var n,r,s=(n=this.boundFuncs)===null||n===void 0?void 0:n.get(t);return(r=this.boundFuncs)===null||r===void 0||r.delete(t),this.removeListener(e,s)}function hasListeners(e){return this.events[e]&&!!this.events[e].length}function prependListener(e,t,n){if(n===void 0&&(n=t.length),typeof t!="function")throw new TypeError("The listener must be a function");var r=this.events[e];return!r||!(r instanceof task_collection_1.TaskCollection)?(r=this.events[e]=new task_collection_1.TaskCollection(n,!0,t,!1),typeof e=="symbol"&&this._symbolKeys.add(e)):(r.insert(0,t),r.growArgsNum(n),this.maxListeners!==1/0&&this.maxListeners<=r.length&&console.warn('Maximum event listeners for "'.concat(String(e),'" event!'))),this}function prependOnceListener(e,t){this.emit===emit&&(this.emit=emitHasOnce);var n=this.onceEvents[e];return n?typeof n!="object"?(this.onceEvents[e]=[t,n],typeof e=="symbol"&&this._symbolKeys.add(e)):(n.unshift(t),this.maxListeners!==1/0&&this.maxListeners<=n.length&&console.warn('Maximum event listeners for "'.concat(String(e),'" once event!'))):(this.onceEvents[e]=[t],typeof e=="symbol"&&this._symbolKeys.add(e)),this}function removeAllListeners(e){return e===void 0?(this.events=(0,utils_2.nullObj)(),this.onceEvents=(0,utils_2.nullObj)(),this._symbolKeys=new Set):(this.events[e]=void 0,this.onceEvents[e]=void 0,typeof e=="symbol"&&this._symbolKeys.delete(e)),this}function setMaxListeners(e){return this.maxListeners=e,this}function getMaxListeners(){return this.maxListeners}function listeners(e){return this.emit===emit?this.events[e]?this.events[e].tasksAsArray().slice():[]:this.events[e]&&this.onceEvents[e]?__spreadArray(__spreadArray([],this.events[e].tasksAsArray(),!0),typeof this.onceEvents[e]=="function"?[this.onceEvents[e]]:this.onceEvents[e],!0):this.events[e]?this.events[e].tasksAsArray():this.onceEvents[e]?typeof this.onceEvents[e]=="function"?[this.onceEvents[e]]:this.onceEvents[e]:[]}function eventNames(){var e=this;if(this.emit===emit){var t=Object.keys(this.events);return __spreadArray(__spreadArray([],t,!0),Array.from(this._symbolKeys),!0).filter(function(r){return r in e.events&&e.events[r]&&e.events[r].length})}else{var t=Object.keys(this.events).filter(function(s){return e.events[s]&&e.events[s].length}),n=Object.keys(this.onceEvents).filter(function(s){return e.onceEvents[s]&&e.onceEvents[s].length});return __spreadArray(__spreadArray(__spreadArray([],t,!0),n,!0),Array.from(this._symbolKeys).filter(function(s){return s in e.events&&e.events[s]&&e.events[s].length||s in e.onceEvents&&e.onceEvents[s]&&e.onceEvents[s].length}),!0)}}function listenerCount(e){return this.emit===emit?this.events[e]&&this.events[e].length||0:(this.events[e]&&this.events[e].length||0)+(this.onceEvents[e]&&this.onceEvents[e].length||0)}EventEmitter.prototype.emit=emit;EventEmitter.prototype.on=addListener;EventEmitter.prototype.once=once;EventEmitter.prototype.addListener=addListener;EventEmitter.prototype.removeListener=removeListener;EventEmitter.prototype.addListenerBound=addListenerBound;EventEmitter.prototype.removeListenerBound=removeListenerBound;EventEmitter.prototype.hasListeners=hasListeners;EventEmitter.prototype.prependListener=prependListener;EventEmitter.prototype.prependOnceListener=prependOnceListener;EventEmitter.prototype.off=removeListener;EventEmitter.prototype.removeAllListeners=removeAllListeners;EventEmitter.prototype.setMaxListeners=setMaxListeners;EventEmitter.prototype.getMaxListeners=getMaxListeners;EventEmitter.prototype.listeners=listeners;EventEmitter.prototype.eventNames=eventNames;EventEmitter.prototype.listenerCount=listenerCount;(function(e){var t=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(s,o);(!c||("get"in c?!s.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,c)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&t(s,r,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(types,e),n(ee,e)})(lib$1);var browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var e=1e3,t=e*60,n=t*60,r=n*24,s=r*7,o=r*365.25;ms=function(f,h){h=h||{};var p=typeof f;if(p==="string"&&f.length>0)return a(f);if(p==="number"&&isFinite(f))return h.long?l(f):c(f);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(f))};function a(f){if(f=String(f),!(f.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(f);if(h){var p=parseFloat(h[1]),b=(h[2]||"ms").toLowerCase();switch(b){case"years":case"year":case"yrs":case"yr":case"y":return p*o;case"weeks":case"week":case"w":return p*s;case"days":case"day":case"d":return p*r;case"hours":case"hour":case"hrs":case"hr":case"h":return p*n;case"minutes":case"minute":case"mins":case"min":case"m":return p*t;case"seconds":case"second":case"secs":case"sec":case"s":return p*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function c(f){var h=Math.abs(f);return h>=r?Math.round(f/r)+"d":h>=n?Math.round(f/n)+"h":h>=t?Math.round(f/t)+"m":h>=e?Math.round(f/e)+"s":f+"ms"}function l(f){var h=Math.abs(f);return h>=r?u(f,h,r,"day"):h>=n?u(f,h,n,"hour"):h>=t?u(f,h,t,"minute"):h>=e?u(f,h,e,"second"):f+" ms"}function u(f,h,p,b){var _=h>=p*1.5;return Math.round(f/p)+" "+b+(_?"s":"")}return ms}function setup(e){n.debug=n,n.default=n,n.coerce=l,n.disable=o,n.enable=s,n.enabled=a,n.humanize=requireMs(),n.destroy=u,Object.keys(e).forEach(f=>{n[f]=e[f]}),n.names=[],n.skips=[],n.formatters={};function t(f){let h=0;for(let p=0;p<f.length;p++)h=(h<<5)-h+f.charCodeAt(p),h|=0;return n.colors[Math.abs(h)%n.colors.length]}n.selectColor=t;function n(f){let h,p=null,b,_;function g(...y){if(!g.enabled)return;const w=g,R=Number(new Date),S=R-(h||R);w.diff=S,w.prev=h,w.curr=R,h=R,y[0]=n.coerce(y[0]),typeof y[0]!="string"&&y.unshift("%O");let I=0;y[0]=y[0].replace(/%([a-zA-Z%])/g,(B,C)=>{if(B==="%%")return"%";I++;const L=n.formatters[C];if(typeof L=="function"){const F=y[I];B=L.call(w,F),y.splice(I,1),I--}return B}),n.formatArgs.call(w,y),(w.log||n.log).apply(w,y)}return g.namespace=f,g.useColors=n.useColors(),g.color=n.selectColor(f),g.extend=r,g.destroy=n.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(b!==n.namespaces&&(b=n.namespaces,_=n.enabled(f)),_),set:y=>{p=y}}),typeof n.init=="function"&&n.init(g),g}function r(f,h){const p=n(this.namespace+(typeof h>"u"?":":h)+f);return p.log=this.log,p}function s(f){n.save(f),n.namespaces=f,n.names=[],n.skips=[];let h;const p=(typeof f=="string"?f:"").split(/[\s,]+/),b=p.length;for(h=0;h<b;h++)p[h]&&(f=p[h].replace(/\*/g,".*?"),f[0]==="-"?n.skips.push(new RegExp("^"+f.slice(1)+"$")):n.names.push(new RegExp("^"+f+"$")))}function o(){const f=[...n.names.map(c),...n.skips.map(c).map(h=>"-"+h)].join(",");return n.enable(""),f}function a(f){if(f[f.length-1]==="*")return!0;let h,p;for(h=0,p=n.skips.length;h<p;h++)if(n.skips[h].test(f))return!1;for(h=0,p=n.names.length;h<p;h++)if(n.names[h].test(f))return!0;return!1}function c(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function l(f){return f instanceof Error?f.stack||f.message:f}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return n.enable(n.load()),n}var common=setup;(function(e,t){var n={};t.formatArgs=s,t.save=o,t.load=a,t.useColors=r,t.storage=c(),t.destroy=(()=>{let u=!1;return()=>{u||(u=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let u;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(u=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(u[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function s(u){if(u[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+u[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const f="color: "+this.color;u.splice(1,0,f,"color: inherit");let h=0,p=0;u[0].replace(/%[a-zA-Z%]/g,b=>{b!=="%%"&&(h++,b==="%c"&&(p=h))}),u.splice(p,0,f)}t.log=console.debug||console.log||(()=>{});function o(u){try{u?t.storage.setItem("debug",u):t.storage.removeItem("debug")}catch{}}function a(){let u;try{u=t.storage.getItem("debug")}catch{}return!u&&typeof process<"u"&&"env"in process&&(u=n.DEBUG),u}function c(){try{return localStorage}catch{}}e.exports=common(t);const{formatters:l}=e.exports;l.j=function(u){try{return JSON.stringify(u)}catch(f){return"[UnexpectedJSONParseError]: "+f.message}}})(browser,browser.exports);var browserExports=browser.exports;const debug7=getDefaultExportFromCjs(browserExports);function number(e){if(!Number.isSafeInteger(e)||e<0)throw new Error(`positive integer expected, not ${e}`)}function isBytes$2(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function bytes(e,...t){if(!isBytes$2(e))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw new Error(`Uint8Array expected of length ${t}, not of length=${e.length}`)}function hash(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");number(e.outputLen),number(e.blockLen)}function exists(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function output(e,t){bytes(e);const n=t.outputLen;if(e.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const crypto$1=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const createView=e=>new DataView(e.buffer,e.byteOffset,e.byteLength),rotr=(e,t)=>e<<32-t|e>>>t;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const hexes$1=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function bytesToHex$1(e){bytes(e);let t="";for(let n=0;n<e.length;n++)t+=hexes$1[e[n]];return t}const asciis$1={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16$1(e){if(e>=asciis$1._0&&e<=asciis$1._9)return e-asciis$1._0;if(e>=asciis$1._A&&e<=asciis$1._F)return e-(asciis$1._A-10);if(e>=asciis$1._a&&e<=asciis$1._f)return e-(asciis$1._a-10)}function hexToBytes$1(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length,n=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){const a=asciiToBase16$1(e.charCodeAt(o)),c=asciiToBase16$1(e.charCodeAt(o+1));if(a===void 0||c===void 0){const l=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}r[s]=a*16+c}return r}function utf8ToBytes$1(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}function toBytes(e){return typeof e=="string"&&(e=utf8ToBytes$1(e)),bytes(e),e}function concatBytes$1(...e){let t=0;for(let r=0;r<e.length;r++){const s=e[r];bytes(s),t+=s.length}const n=new Uint8Array(t);for(let r=0,s=0;r<e.length;r++){const o=e[r];n.set(o,s),s+=o.length}return n}class Hash{clone(){return this._cloneInto()}}function wrapConstructor(e){const t=r=>e().update(toBytes(r)).digest(),n=e();return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=()=>e(),t}function randomBytes(e=32){if(crypto$1&&typeof crypto$1.getRandomValues=="function")return crypto$1.getRandomValues(new Uint8Array(e));if(crypto$1&&typeof crypto$1.randomBytes=="function")return crypto$1.randomBytes(e);throw new Error("crypto.getRandomValues must be defined")}function setBigUint64(e,t,n,r){if(typeof e.setBigUint64=="function")return e.setBigUint64(t,n,r);const s=BigInt(32),o=BigInt(4294967295),a=Number(n>>s&o),c=Number(n&o),l=r?4:0,u=r?0:4;e.setUint32(t+l,a,r),e.setUint32(t+u,c,r)}const Chi=(e,t,n)=>e&t^~e&n,Maj=(e,t,n)=>e&t^e&n^t&n;class HashMD extends Hash{constructor(t,n,r,s){super(),this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(t),this.view=createView(this.buffer)}update(t){exists(this);const{view:n,buffer:r,blockLen:s}=this;t=toBytes(t);const o=t.length;for(let a=0;a<o;){const c=Math.min(s-this.pos,o-a);if(c===s){const l=createView(t);for(;s<=o-a;a+=s)this.process(l,a);continue}r.set(t.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){exists(this),output(t,this),this.finished=!0;const{buffer:n,view:r,blockLen:s,isLE:o}=this;let{pos:a}=this;n[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>s-a&&(this.process(r,0),a=0);for(let h=a;h<s;h++)n[h]=0;setBigUint64(r,s-8,BigInt(this.length*8),o),this.process(r,0);const c=createView(t),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=l/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<u;h++)c.setUint32(4*h,f[h],o)}digest(){const{buffer:t,outputLen:n}=this;this.digestInto(t);const r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:n,buffer:r,length:s,finished:o,destroyed:a,pos:c}=this;return t.length=s,t.pos=c,t.finished=o,t.destroyed=a,s%n&&t.buffer.set(r),t}}const SHA256_K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),SHA256_IV=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),SHA256_W=new Uint32Array(64);class SHA256 extends HashMD{constructor(){super(64,32,8,!1),this.A=SHA256_IV[0]|0,this.B=SHA256_IV[1]|0,this.C=SHA256_IV[2]|0,this.D=SHA256_IV[3]|0,this.E=SHA256_IV[4]|0,this.F=SHA256_IV[5]|0,this.G=SHA256_IV[6]|0,this.H=SHA256_IV[7]|0}get(){const{A:t,B:n,C:r,D:s,E:o,F:a,G:c,H:l}=this;return[t,n,r,s,o,a,c,l]}set(t,n,r,s,o,a,c,l){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=a|0,this.G=c|0,this.H=l|0}process(t,n){for(let h=0;h<16;h++,n+=4)SHA256_W[h]=t.getUint32(n,!1);for(let h=16;h<64;h++){const p=SHA256_W[h-15],b=SHA256_W[h-2],_=rotr(p,7)^rotr(p,18)^p>>>3,g=rotr(b,17)^rotr(b,19)^b>>>10;SHA256_W[h]=g+SHA256_W[h-7]+_+SHA256_W[h-16]|0}let{A:r,B:s,C:o,D:a,E:c,F:l,G:u,H:f}=this;for(let h=0;h<64;h++){const p=rotr(c,6)^rotr(c,11)^rotr(c,25),b=f+p+Chi(c,l,u)+SHA256_K[h]+SHA256_W[h]|0,g=(rotr(r,2)^rotr(r,13)^rotr(r,22))+Maj(r,s,o)|0;f=u,u=l,l=c,c=a+b|0,a=o,o=s,s=r,r=b+g|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,a=a+this.D|0,c=c+this.E|0,l=l+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(r,s,o,a,c,l,u,f)}roundClean(){SHA256_W.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const sha256=wrapConstructor(()=>new SHA256);class HMAC extends Hash{constructor(t,n){super(),this.finished=!1,this.destroyed=!1,hash(t);const r=toBytes(n);if(this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(r.length>s?t.create().update(r).digest():r);for(let a=0;a<o.length;a++)o[a]^=54;this.iHash.update(o),this.oHash=t.create();for(let a=0;a<o.length;a++)o[a]^=106;this.oHash.update(o),o.fill(0)}update(t){return exists(this),this.iHash.update(t),this}digestInto(t){exists(this),bytes(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){const t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:s,destroyed:o,blockLen:a,outputLen:c}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=a,t.outputLen=c,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const hmac=(e,t,n)=>new HMAC(e,t).update(n).digest();hmac.create=(e,t)=>new HMAC(e,t);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$4=BigInt(0),_1n$4=BigInt(1),_2n$2=BigInt(2);function isBytes$1(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function abytes(e){if(!isBytes$1(e))throw new Error("Uint8Array expected")}function abool(e,t){if(typeof t!="boolean")throw new Error(`${e} must be valid boolean, got "${t}".`)}const hexes=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function bytesToHex(e){abytes(e);let t="";for(let n=0;n<e.length;n++)t+=hexes[e[n]];return t}function numberToHexUnpadded(e){const t=e.toString(16);return t.length&1?`0${t}`:t}function hexToNumber(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return BigInt(e===""?"0":`0x${e}`)}const asciis={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function asciiToBase16(e){if(e>=asciis._0&&e<=asciis._9)return e-asciis._0;if(e>=asciis._A&&e<=asciis._F)return e-(asciis._A-10);if(e>=asciis._a&&e<=asciis._f)return e-(asciis._a-10)}function hexToBytes(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);const t=e.length,n=t/2;if(t%2)throw new Error("padded hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){const a=asciiToBase16(e.charCodeAt(o)),c=asciiToBase16(e.charCodeAt(o+1));if(a===void 0||c===void 0){const l=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}r[s]=a*16+c}return r}function bytesToNumberBE(e){return hexToNumber(bytesToHex(e))}function bytesToNumberLE(e){return abytes(e),hexToNumber(bytesToHex(Uint8Array.from(e).reverse()))}function numberToBytesBE(e,t){return hexToBytes(e.toString(16).padStart(t*2,"0"))}function numberToBytesLE(e,t){return numberToBytesBE(e,t).reverse()}function numberToVarBytesBE(e){return hexToBytes(numberToHexUnpadded(e))}function ensureBytes(e,t,n){let r;if(typeof t=="string")try{r=hexToBytes(t)}catch(o){throw new Error(`${e} must be valid hex string, got "${t}". Cause: ${o}`)}else if(isBytes$1(t))r=Uint8Array.from(t);else throw new Error(`${e} must be hex string or Uint8Array`);const s=r.length;if(typeof n=="number"&&s!==n)throw new Error(`${e} expected ${n} bytes, got ${s}`);return r}function concatBytes(...e){let t=0;for(let r=0;r<e.length;r++){const s=e[r];abytes(s),t+=s.length}const n=new Uint8Array(t);for(let r=0,s=0;r<e.length;r++){const o=e[r];n.set(o,s),s+=o.length}return n}function equalBytes(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return n===0}function utf8ToBytes(e){if(typeof e!="string")throw new Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}const isPosBig=e=>typeof e=="bigint"&&_0n$4<=e;function inRange(e,t,n){return isPosBig(e)&&isPosBig(t)&&isPosBig(n)&&t<=e&&e<n}function aInRange(e,t,n,r){if(!inRange(t,n,r))throw new Error(`expected valid ${e}: ${n} <= n < ${r}, got ${typeof t} ${t}`)}function bitLen(e){let t;for(t=0;e>_0n$4;e>>=_1n$4,t+=1);return t}function bitGet(e,t){return e>>BigInt(t)&_1n$4}function bitSet(e,t,n){return e|(n?_1n$4:_0n$4)<<BigInt(t)}const bitMask=e=>(_2n$2<<BigInt(e-1))-_1n$4,u8n=e=>new Uint8Array(e),u8fr=e=>Uint8Array.from(e);function createHmacDrbg(e,t,n){if(typeof e!="number"||e<2)throw new Error("hashLen must be a number");if(typeof t!="number"||t<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=u8n(e),s=u8n(e),o=0;const a=()=>{r.fill(1),s.fill(0),o=0},c=(...h)=>n(s,r,...h),l=(h=u8n())=>{s=c(u8fr([0]),h),r=c(),h.length!==0&&(s=c(u8fr([1]),h),r=c())},u=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<t;){r=c();const b=r.slice();p.push(b),h+=r.length}return concatBytes(...p)};return(h,p)=>{a(),l(h);let b;for(;!(b=p(u()));)l();return a(),b}}const validatorFns={bigint:e=>typeof e=="bigint",function:e=>typeof e=="function",boolean:e=>typeof e=="boolean",string:e=>typeof e=="string",stringOrUint8Array:e=>typeof e=="string"||isBytes$1(e),isSafeInteger:e=>Number.isSafeInteger(e),array:e=>Array.isArray(e),field:(e,t)=>t.Fp.isValid(e),hash:e=>typeof e=="function"&&Number.isSafeInteger(e.outputLen)};function validateObject(e,t,n={}){const r=(s,o,a)=>{const c=validatorFns[o];if(typeof c!="function")throw new Error(`Invalid validator "${o}", expected function`);const l=e[s];if(!(a&&l===void 0)&&!c(l,e))throw new Error(`Invalid param ${String(s)}=${l} (${typeof l}), expected ${o}`)};for(const[s,o]of Object.entries(t))r(s,o,!1);for(const[s,o]of Object.entries(n))r(s,o,!0);return e}const notImplemented=()=>{throw new Error("not implemented")};function memoized(e){const t=new WeakMap;return(n,...r)=>{const s=t.get(n);if(s!==void 0)return s;const o=e(n,...r);return t.set(n,o),o}}const ut=Object.freeze(Object.defineProperty({__proto__:null,aInRange,abool,abytes,bitGet,bitLen,bitMask,bitSet,bytesToHex,bytesToNumberBE,bytesToNumberLE,concatBytes,createHmacDrbg,ensureBytes,equalBytes,hexToBytes,hexToNumber,inRange,isBytes:isBytes$1,memoized,notImplemented,numberToBytesBE,numberToBytesLE,numberToHexUnpadded,numberToVarBytesBE,utf8ToBytes,validateObject},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$3=BigInt(0),_1n$3=BigInt(1),_2n$1=BigInt(2),_3n$1=BigInt(3),_4n=BigInt(4),_5n=BigInt(5),_8n=BigInt(8);BigInt(9);BigInt(16);function mod(e,t){const n=e%t;return n>=_0n$3?n:t+n}function pow(e,t,n){if(n<=_0n$3||t<_0n$3)throw new Error("Expected power/modulo > 0");if(n===_1n$3)return _0n$3;let r=_1n$3;for(;t>_0n$3;)t&_1n$3&&(r=r*e%n),e=e*e%n,t>>=_1n$3;return r}function pow2(e,t,n){let r=e;for(;t-- >_0n$3;)r*=r,r%=n;return r}function invert(e,t){if(e===_0n$3||t<=_0n$3)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let n=mod(e,t),r=t,s=_0n$3,o=_1n$3;for(;n!==_0n$3;){const c=r/n,l=r%n,u=s-o*c;r=n,n=l,s=o,o=u}if(r!==_1n$3)throw new Error("invert: does not exist");return mod(s,t)}function tonelliShanks(e){const t=(e-_1n$3)/_2n$1;let n,r,s;for(n=e-_1n$3,r=0;n%_2n$1===_0n$3;n/=_2n$1,r++);for(s=_2n$1;s<e&&pow(s,t,e)!==e-_1n$3;s++);if(r===1){const a=(e+_1n$3)/_4n;return function(l,u){const f=l.pow(u,a);if(!l.eql(l.sqr(f),u))throw new Error("Cannot find square root");return f}}const o=(n+_1n$3)/_2n$1;return function(c,l){if(c.pow(l,t)===c.neg(c.ONE))throw new Error("Cannot find square root");let u=r,f=c.pow(c.mul(c.ONE,s),n),h=c.pow(l,o),p=c.pow(l,n);for(;!c.eql(p,c.ONE);){if(c.eql(p,c.ZERO))return c.ZERO;let b=1;for(let g=c.sqr(p);b<u&&!c.eql(g,c.ONE);b++)g=c.sqr(g);const _=c.pow(f,_1n$3<<BigInt(u-b-1));f=c.sqr(_),h=c.mul(h,_),p=c.mul(p,f),u=b}return h}}function FpSqrt(e){if(e%_4n===_3n$1){const t=(e+_1n$3)/_4n;return function(r,s){const o=r.pow(s,t);if(!r.eql(r.sqr(o),s))throw new Error("Cannot find square root");return o}}if(e%_8n===_5n){const t=(e-_5n)/_8n;return function(r,s){const o=r.mul(s,_2n$1),a=r.pow(o,t),c=r.mul(s,a),l=r.mul(r.mul(c,_2n$1),a),u=r.mul(c,r.sub(l,r.ONE));if(!r.eql(r.sqr(u),s))throw new Error("Cannot find square root");return u}}return tonelliShanks(e)}const FIELD_FIELDS=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function validateField(e){const t={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=FIELD_FIELDS.reduce((r,s)=>(r[s]="function",r),t);return validateObject(e,n)}function FpPow(e,t,n){if(n<_0n$3)throw new Error("Expected power > 0");if(n===_0n$3)return e.ONE;if(n===_1n$3)return t;let r=e.ONE,s=t;for(;n>_0n$3;)n&_1n$3&&(r=e.mul(r,s)),s=e.sqr(s),n>>=_1n$3;return r}function FpInvertBatch(e,t){const n=new Array(t.length),r=t.reduce((o,a,c)=>e.is0(a)?o:(n[c]=o,e.mul(o,a)),e.ONE),s=e.inv(r);return t.reduceRight((o,a,c)=>e.is0(a)?o:(n[c]=e.mul(o,n[c]),e.mul(o,a)),s),n}function nLength(e,t){const n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function Field(e,t,n=!1,r={}){if(e<=_0n$3)throw new Error(`Expected Field ORDER > 0, got ${e}`);const{nBitLength:s,nByteLength:o}=nLength(e,t);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const a=FpSqrt(e),c=Object.freeze({ORDER:e,BITS:s,BYTES:o,MASK:bitMask(s),ZERO:_0n$3,ONE:_1n$3,create:l=>mod(l,e),isValid:l=>{if(typeof l!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof l}`);return _0n$3<=l&&l<e},is0:l=>l===_0n$3,isOdd:l=>(l&_1n$3)===_1n$3,neg:l=>mod(-l,e),eql:(l,u)=>l===u,sqr:l=>mod(l*l,e),add:(l,u)=>mod(l+u,e),sub:(l,u)=>mod(l-u,e),mul:(l,u)=>mod(l*u,e),pow:(l,u)=>FpPow(c,l,u),div:(l,u)=>mod(l*invert(u,e),e),sqrN:l=>l*l,addN:(l,u)=>l+u,subN:(l,u)=>l-u,mulN:(l,u)=>l*u,inv:l=>invert(l,e),sqrt:r.sqrt||(l=>a(c,l)),invertBatch:l=>FpInvertBatch(c,l),cmov:(l,u,f)=>f?u:l,toBytes:l=>n?numberToBytesLE(l,o):numberToBytesBE(l,o),fromBytes:l=>{if(l.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${l.length}`);return n?bytesToNumberLE(l):bytesToNumberBE(l)}});return Object.freeze(c)}function getFieldBytesLength(e){if(typeof e!="bigint")throw new Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function getMinHashLength(e){const t=getFieldBytesLength(e);return t+Math.ceil(t/2)}function mapHashToField(e,t,n=!1){const r=e.length,s=getFieldBytesLength(t),o=getMinHashLength(t);if(r<16||r<o||r>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${r}`);const a=n?bytesToNumberBE(e):bytesToNumberLE(e),c=mod(a,t-_1n$3)+_1n$3;return n?numberToBytesLE(c,s):numberToBytesBE(c,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const _0n$2=BigInt(0),_1n$2=BigInt(1),pointPrecomputes=new WeakMap,pointWindowSizes=new WeakMap;function wNAF(e,t){const n=(o,a)=>{const c=a.negate();return o?c:a},r=o=>{if(!Number.isSafeInteger(o)||o<=0||o>t)throw new Error(`Wrong window size=${o}, should be [1..${t}]`)},s=o=>{r(o);const a=Math.ceil(t/o)+1,c=2**(o-1);return{windows:a,windowSize:c}};return{constTimeNegate:n,unsafeLadder(o,a){let c=e.ZERO,l=o;for(;a>_0n$2;)a&_1n$2&&(c=c.add(l)),l=l.double(),a>>=_1n$2;return c},precomputeWindow(o,a){const{windows:c,windowSize:l}=s(a),u=[];let f=o,h=f;for(let p=0;p<c;p++){h=f,u.push(h);for(let b=1;b<l;b++)h=h.add(f),u.push(h);f=h.double()}return u},wNAF(o,a,c){const{windows:l,windowSize:u}=s(o);let f=e.ZERO,h=e.BASE;const p=BigInt(2**o-1),b=2**o,_=BigInt(o);for(let g=0;g<l;g++){const y=g*u;let w=Number(c&p);c>>=_,w>u&&(w-=b,c+=_1n$2);const R=y,S=y+Math.abs(w)-1,I=g%2!==0,O=w<0;w===0?h=h.add(n(I,a[R])):f=f.add(n(O,a[S]))}return{p:f,f:h}},wNAFCached(o,a,c){const l=pointWindowSizes.get(o)||1;let u=pointPrecomputes.get(o);return u||(u=this.precomputeWindow(o,l),l!==1&&pointPrecomputes.set(o,c(u))),this.wNAF(l,u,a)},setWindowSize(o,a){r(a),pointWindowSizes.set(o,a),pointPrecomputes.delete(o)}}}function pippenger(e,t,n,r){if(!Array.isArray(n)||!Array.isArray(r)||r.length!==n.length)throw new Error("arrays of points and scalars must have equal length");r.forEach((f,h)=>{if(!t.isValid(f))throw new Error(`wrong scalar at index ${h}`)}),n.forEach((f,h)=>{if(!(f instanceof e))throw new Error(`wrong point at index ${h}`)});const s=bitLen(BigInt(n.length)),o=s>12?s-3:s>4?s-2:s?2:1,a=(1<<o)-1,c=new Array(a+1).fill(e.ZERO),l=Math.floor((t.BITS-1)/o)*o;let u=e.ZERO;for(let f=l;f>=0;f-=o){c.fill(e.ZERO);for(let p=0;p<r.length;p++){const b=r[p],_=Number(b>>BigInt(f)&BigInt(a));c[_]=c[_].add(n[p])}let h=e.ZERO;for(let p=c.length-1,b=e.ZERO;p>0;p--)b=b.add(c[p]),h=h.add(b);if(u=u.add(h),f!==0)for(let p=0;p<o;p++)u=u.double()}return u}function validateBasic(e){return validateField(e.Fp),validateObject(e,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nLength(e.n,e.nBitLength),...e,p:e.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function validateSigVerOpts(e){e.lowS!==void 0&&abool("lowS",e.lowS),e.prehash!==void 0&&abool("prehash",e.prehash)}function validatePointOpts(e){const t=validateBasic(e);validateObject(t,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:s}=t;if(n){if(!r.eql(s,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...t})}const{bytesToNumberBE:b2n,hexToBytes:h2b}=ut,DER={Err:class extends Error{constructor(t=""){super(t)}},_tlv:{encode:(e,t)=>{const{Err:n}=DER;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length&1)throw new n("tlv.encode: unpadded data");const r=t.length/2,s=numberToHexUnpadded(r);if(s.length/2&128)throw new n("tlv.encode: long form length too big");const o=r>127?numberToHexUnpadded(s.length/2|128):"";return`${numberToHexUnpadded(e)}${o}${s}${t}`},decode(e,t){const{Err:n}=DER;let r=0;if(e<0||e>256)throw new n("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new n("tlv.decode: wrong tlv");const s=t[r++],o=!!(s&128);let a=0;if(!o)a=s;else{const l=s&127;if(!l)throw new n("tlv.decode(long): indefinite length not supported");if(l>4)throw new n("tlv.decode(long): byte length is too big");const u=t.subarray(r,r+l);if(u.length!==l)throw new n("tlv.decode: length bytes not complete");if(u[0]===0)throw new n("tlv.decode(long): zero leftmost byte");for(const f of u)a=a<<8|f;if(r+=l,a<128)throw new n("tlv.decode(long): not minimal encoding")}const c=t.subarray(r,r+a);if(c.length!==a)throw new n("tlv.decode: wrong value length");return{v:c,l:t.subarray(r+a)}}},_int:{encode(e){const{Err:t}=DER;if(e<_0n$1)throw new t("integer: negative integers are not allowed");let n=numberToHexUnpadded(e);if(Number.parseInt(n[0],16)&8&&(n="00"+n),n.length&1)throw new t("unexpected assertion");return n},decode(e){const{Err:t}=DER;if(e[0]&128)throw new t("Invalid signature integer: negative");if(e[0]===0&&!(e[1]&128))throw new t("Invalid signature integer: unnecessary leading zero");return b2n(e)}},toSig(e){const{Err:t,_int:n,_tlv:r}=DER,s=typeof e=="string"?h2b(e):e;abytes(s);const{v:o,l:a}=r.decode(48,s);if(a.length)throw new t("Invalid signature: left bytes after parsing");const{v:c,l}=r.decode(2,o),{v:u,l:f}=r.decode(2,l);if(f.length)throw new t("Invalid signature: left bytes after parsing");return{r:n.decode(c),s:n.decode(u)}},hexFromSig(e){const{_tlv:t,_int:n}=DER,r=`${t.encode(2,n.encode(e.r))}${t.encode(2,n.encode(e.s))}`;return t.encode(48,r)}},_0n$1=BigInt(0),_1n$1=BigInt(1);BigInt(2);const _3n=BigInt(3);BigInt(4);function weierstrassPoints(e){const t=validatePointOpts(e),{Fp:n}=t,r=Field(t.n,t.nBitLength),s=t.toBytes||((g,y,w)=>{const R=y.toAffine();return concatBytes(Uint8Array.from([4]),n.toBytes(R.x),n.toBytes(R.y))}),o=t.fromBytes||(g=>{const y=g.subarray(1),w=n.fromBytes(y.subarray(0,n.BYTES)),R=n.fromBytes(y.subarray(n.BYTES,2*n.BYTES));return{x:w,y:R}});function a(g){const{a:y,b:w}=t,R=n.sqr(g),S=n.mul(R,g);return n.add(n.add(S,n.mul(g,y)),w)}if(!n.eql(n.sqr(t.Gy),a(t.Gx)))throw new Error("bad generator point: equation left != right");function c(g){return inRange(g,_1n$1,t.n)}function l(g){const{allowedPrivateKeyLengths:y,nByteLength:w,wrapPrivateKey:R,n:S}=t;if(y&&typeof g!="bigint"){if(isBytes$1(g)&&(g=bytesToHex(g)),typeof g!="string"||!y.includes(g.length))throw new Error("Invalid key");g=g.padStart(w*2,"0")}let I;try{I=typeof g=="bigint"?g:bytesToNumberBE(ensureBytes("private key",g,w))}catch{throw new Error(`private key must be ${w} bytes, hex or bigint, not ${typeof g}`)}return R&&(I=mod(I,S)),aInRange("private key",I,_1n$1,S),I}function u(g){if(!(g instanceof p))throw new Error("ProjectivePoint expected")}const f=memoized((g,y)=>{const{px:w,py:R,pz:S}=g;if(n.eql(S,n.ONE))return{x:w,y:R};const I=g.is0();y==null&&(y=I?n.ONE:n.inv(S));const O=n.mul(w,y),B=n.mul(R,y),C=n.mul(S,y);if(I)return{x:n.ZERO,y:n.ZERO};if(!n.eql(C,n.ONE))throw new Error("invZ was invalid");return{x:O,y:B}}),h=memoized(g=>{if(g.is0()){if(t.allowInfinityPoint&&!n.is0(g.py))return;throw new Error("bad point: ZERO")}const{x:y,y:w}=g.toAffine();if(!n.isValid(y)||!n.isValid(w))throw new Error("bad point: x or y not FE");const R=n.sqr(w),S=a(y);if(!n.eql(R,S))throw new Error("bad point: equation left != right");if(!g.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class p{constructor(y,w,R){if(this.px=y,this.py=w,this.pz=R,y==null||!n.isValid(y))throw new Error("x required");if(w==null||!n.isValid(w))throw new Error("y required");if(R==null||!n.isValid(R))throw new Error("z required");Object.freeze(this)}static fromAffine(y){const{x:w,y:R}=y||{};if(!y||!n.isValid(w)||!n.isValid(R))throw new Error("invalid affine point");if(y instanceof p)throw new Error("projective point not allowed");const S=I=>n.eql(I,n.ZERO);return S(w)&&S(R)?p.ZERO:new p(w,R,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(y){const w=n.invertBatch(y.map(R=>R.pz));return y.map((R,S)=>R.toAffine(w[S])).map(p.fromAffine)}static fromHex(y){const w=p.fromAffine(o(ensureBytes("pointHex",y)));return w.assertValidity(),w}static fromPrivateKey(y){return p.BASE.multiply(l(y))}static msm(y,w){return pippenger(p,r,y,w)}_setWindowSize(y){_.setWindowSize(this,y)}assertValidity(){h(this)}hasEvenY(){const{y}=this.toAffine();if(n.isOdd)return!n.isOdd(y);throw new Error("Field doesn't support isOdd")}equals(y){u(y);const{px:w,py:R,pz:S}=this,{px:I,py:O,pz:B}=y,C=n.eql(n.mul(w,B),n.mul(I,S)),L=n.eql(n.mul(R,B),n.mul(O,S));return C&&L}negate(){return new p(this.px,n.neg(this.py),this.pz)}double(){const{a:y,b:w}=t,R=n.mul(w,_3n),{px:S,py:I,pz:O}=this;let B=n.ZERO,C=n.ZERO,L=n.ZERO,F=n.mul(S,S),M=n.mul(I,I),$=n.mul(O,O),x=n.mul(S,I);return x=n.add(x,x),L=n.mul(S,O),L=n.add(L,L),B=n.mul(y,L),C=n.mul(R,$),C=n.add(B,C),B=n.sub(M,C),C=n.add(M,C),C=n.mul(B,C),B=n.mul(x,B),L=n.mul(R,L),$=n.mul(y,$),x=n.sub(F,$),x=n.mul(y,x),x=n.add(x,L),L=n.add(F,F),F=n.add(L,F),F=n.add(F,$),F=n.mul(F,x),C=n.add(C,F),$=n.mul(I,O),$=n.add($,$),F=n.mul($,x),B=n.sub(B,F),L=n.mul($,M),L=n.add(L,L),L=n.add(L,L),new p(B,C,L)}add(y){u(y);const{px:w,py:R,pz:S}=this,{px:I,py:O,pz:B}=y;let C=n.ZERO,L=n.ZERO,F=n.ZERO;const M=t.a,$=n.mul(t.b,_3n);let x=n.mul(w,I),A=n.mul(R,O),k=n.mul(S,B),E=n.add(w,R),v=n.add(I,O);E=n.mul(E,v),v=n.add(x,A),E=n.sub(E,v),v=n.add(w,S);let T=n.add(I,B);return v=n.mul(v,T),T=n.add(x,k),v=n.sub(v,T),T=n.add(R,S),C=n.add(O,B),T=n.mul(T,C),C=n.add(A,k),T=n.sub(T,C),F=n.mul(M,v),C=n.mul($,k),F=n.add(C,F),C=n.sub(A,F),F=n.add(A,F),L=n.mul(C,F),A=n.add(x,x),A=n.add(A,x),k=n.mul(M,k),v=n.mul($,v),A=n.add(A,k),k=n.sub(x,k),k=n.mul(M,k),v=n.add(v,k),x=n.mul(A,v),L=n.add(L,x),x=n.mul(T,v),C=n.mul(E,C),C=n.sub(C,x),x=n.mul(E,A),F=n.mul(T,F),F=n.add(F,x),new p(C,L,F)}subtract(y){return this.add(y.negate())}is0(){return this.equals(p.ZERO)}wNAF(y){return _.wNAFCached(this,y,p.normalizeZ)}multiplyUnsafe(y){aInRange("scalar",y,_0n$1,t.n);const w=p.ZERO;if(y===_0n$1)return w;if(y===_1n$1)return this;const{endo:R}=t;if(!R)return _.unsafeLadder(this,y);let{k1neg:S,k1:I,k2neg:O,k2:B}=R.splitScalar(y),C=w,L=w,F=this;for(;I>_0n$1||B>_0n$1;)I&_1n$1&&(C=C.add(F)),B&_1n$1&&(L=L.add(F)),F=F.double(),I>>=_1n$1,B>>=_1n$1;return S&&(C=C.negate()),O&&(L=L.negate()),L=new p(n.mul(L.px,R.beta),L.py,L.pz),C.add(L)}multiply(y){const{endo:w,n:R}=t;aInRange("scalar",y,_1n$1,R);let S,I;if(w){const{k1neg:O,k1:B,k2neg:C,k2:L}=w.splitScalar(y);let{p:F,f:M}=this.wNAF(B),{p:$,f:x}=this.wNAF(L);F=_.constTimeNegate(O,F),$=_.constTimeNegate(C,$),$=new p(n.mul($.px,w.beta),$.py,$.pz),S=F.add($),I=M.add(x)}else{const{p:O,f:B}=this.wNAF(y);S=O,I=B}return p.normalizeZ([S,I])[0]}multiplyAndAddUnsafe(y,w,R){const S=p.BASE,I=(B,C)=>C===_0n$1||C===_1n$1||!B.equals(S)?B.multiplyUnsafe(C):B.multiply(C),O=I(this,w).add(I(y,R));return O.is0()?void 0:O}toAffine(y){return f(this,y)}isTorsionFree(){const{h:y,isTorsionFree:w}=t;if(y===_1n$1)return!0;if(w)return w(p,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:y,clearCofactor:w}=t;return y===_1n$1?this:w?w(p,this):this.multiplyUnsafe(t.h)}toRawBytes(y=!0){return abool("isCompressed",y),this.assertValidity(),s(p,this,y)}toHex(y=!0){return abool("isCompressed",y),bytesToHex(this.toRawBytes(y))}}p.BASE=new p(t.Gx,t.Gy,n.ONE),p.ZERO=new p(n.ZERO,n.ONE,n.ZERO);const b=t.nBitLength,_=wNAF(p,t.endo?Math.ceil(b/2):b);return{CURVE:t,ProjectivePoint:p,normPrivateKeyToScalar:l,weierstrassEquation:a,isWithinCurveOrder:c}}function validateOpts(e){const t=validateBasic(e);return validateObject(t,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...t})}function weierstrass(e){const t=validateOpts(e),{Fp:n,n:r}=t,s=n.BYTES+1,o=2*n.BYTES+1;function a(k){return mod(k,r)}function c(k){return invert(k,r)}const{ProjectivePoint:l,normPrivateKeyToScalar:u,weierstrassEquation:f,isWithinCurveOrder:h}=weierstrassPoints({...t,toBytes(k,E,v){const T=E.toAffine(),N=n.toBytes(T.x),U=concatBytes;return abool("isCompressed",v),v?U(Uint8Array.from([E.hasEvenY()?2:3]),N):U(Uint8Array.from([4]),N,n.toBytes(T.y))},fromBytes(k){const E=k.length,v=k[0],T=k.subarray(1);if(E===s&&(v===2||v===3)){const N=bytesToNumberBE(T);if(!inRange(N,_1n$1,n.ORDER))throw new Error("Point is not on curve");const U=f(N);let D;try{D=n.sqrt(U)}catch(z){const V=z instanceof Error?": "+z.message:"";throw new Error("Point is not on curve"+V)}const P=(D&_1n$1)===_1n$1;return(v&1)===1!==P&&(D=n.neg(D)),{x:N,y:D}}else if(E===o&&v===4){const N=n.fromBytes(T.subarray(0,n.BYTES)),U=n.fromBytes(T.subarray(n.BYTES,2*n.BYTES));return{x:N,y:U}}else throw new Error(`Point of length ${E} was invalid. Expected ${s} compressed bytes or ${o} uncompressed bytes`)}}),p=k=>bytesToHex(numberToBytesBE(k,t.nByteLength));function b(k){const E=r>>_1n$1;return k>E}function _(k){return b(k)?a(-k):k}const g=(k,E,v)=>bytesToNumberBE(k.slice(E,v));class y{constructor(E,v,T){this.r=E,this.s=v,this.recovery=T,this.assertValidity()}static fromCompact(E){const v=t.nByteLength;return E=ensureBytes("compactSignature",E,v*2),new y(g(E,0,v),g(E,v,2*v))}static fromDER(E){const{r:v,s:T}=DER.toSig(ensureBytes("DER",E));return new y(v,T)}assertValidity(){aInRange("r",this.r,_1n$1,r),aInRange("s",this.s,_1n$1,r)}addRecoveryBit(E){return new y(this.r,this.s,E)}recoverPublicKey(E){const{r:v,s:T,recovery:N}=this,U=B(ensureBytes("msgHash",E));if(N==null||![0,1,2,3].includes(N))throw new Error("recovery id invalid");const D=N===2||N===3?v+t.n:v;if(D>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const P=N&1?"03":"02",H=l.fromHex(P+p(D)),z=c(D),V=a(-U*z),W=a(T*z),q=l.BASE.multiplyAndAddUnsafe(H,V,W);if(!q)throw new Error("point at infinify");return q.assertValidity(),q}hasHighS(){return b(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return hexToBytes(this.toDERHex())}toDERHex(){return DER.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hexToBytes(this.toCompactHex())}toCompactHex(){return p(this.r)+p(this.s)}}const w={isValidPrivateKey(k){try{return u(k),!0}catch{return!1}},normPrivateKeyToScalar:u,randomPrivateKey:()=>{const k=getMinHashLength(t.n);return mapHashToField(t.randomBytes(k),t.n)},precompute(k=8,E=l.BASE){return E._setWindowSize(k),E.multiply(BigInt(3)),E}};function R(k,E=!0){return l.fromPrivateKey(k).toRawBytes(E)}function S(k){const E=isBytes$1(k),v=typeof k=="string",T=(E||v)&&k.length;return E?T===s||T===o:v?T===2*s||T===2*o:k instanceof l}function I(k,E,v=!0){if(S(k))throw new Error("first arg must be private key");if(!S(E))throw new Error("second arg must be public key");return l.fromHex(E).multiply(u(k)).toRawBytes(v)}const O=t.bits2int||function(k){const E=bytesToNumberBE(k),v=k.length*8-t.nBitLength;return v>0?E>>BigInt(v):E},B=t.bits2int_modN||function(k){return a(O(k))},C=bitMask(t.nBitLength);function L(k){return aInRange(`num < 2^${t.nBitLength}`,k,_0n$1,C),numberToBytesBE(k,t.nByteLength)}function F(k,E,v=M){if(["recovered","canonical"].some(Y=>Y in v))throw new Error("sign() legacy options not supported");const{hash:T,randomBytes:N}=t;let{lowS:U,prehash:D,extraEntropy:P}=v;U==null&&(U=!0),k=ensureBytes("msgHash",k),validateSigVerOpts(v),D&&(k=ensureBytes("prehashed msgHash",T(k)));const H=B(k),z=u(E),V=[L(z),L(H)];if(P!=null&&P!==!1){const Y=P===!0?N(n.BYTES):P;V.push(ensureBytes("extraEntropy",Y))}const W=concatBytes(...V),q=H;function Z(Y){const J=O(Y);if(!h(J))return;const X=c(J),Q=l.BASE.multiply(J).toAffine(),j=a(Q.x);if(j===_0n$1)return;const G=a(X*a(q+j*z));if(G===_0n$1)return;let K=(Q.x===j?0:2)|Number(Q.y&_1n$1),ie=G;return U&&b(G)&&(ie=_(G),K^=1),new y(j,ie,K)}return{seed:W,k2sig:Z}}const M={lowS:t.lowS,prehash:!1},$={lowS:t.lowS,prehash:!1};function x(k,E,v=M){const{seed:T,k2sig:N}=F(k,E,v),U=t;return createHmacDrbg(U.hash.outputLen,U.nByteLength,U.hmac)(T,N)}l.BASE._setWindowSize(8);function A(k,E,v,T=$){var Q;const N=k;if(E=ensureBytes("msgHash",E),v=ensureBytes("publicKey",v),"strict"in T)throw new Error("options.strict was renamed to lowS");validateSigVerOpts(T);const{lowS:U,prehash:D}=T;let P,H;try{if(typeof N=="string"||isBytes$1(N))try{P=y.fromDER(N)}catch(j){if(!(j instanceof DER.Err))throw j;P=y.fromCompact(N)}else if(typeof N=="object"&&typeof N.r=="bigint"&&typeof N.s=="bigint"){const{r:j,s:G}=N;P=new y(j,G)}else throw new Error("PARSE");H=l.fromHex(v)}catch(j){if(j.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(U&&P.hasHighS())return!1;D&&(E=t.hash(E));const{r:z,s:V}=P,W=B(E),q=c(V),Z=a(W*q),Y=a(z*q),J=(Q=l.BASE.multiplyAndAddUnsafe(H,Z,Y))==null?void 0:Q.toAffine();return J?a(J.x)===z:!1}return{CURVE:t,getPublicKey:R,getSharedSecret:I,sign:x,verify:A,ProjectivePoint:l,Signature:y,utils:w}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function getHash(e){return{hash:e,hmac:(t,...n)=>hmac(e,t,concatBytes$1(...n)),randomBytes}}function createCurve(e,t){const n=r=>weierstrass({...e,...getHash(r)});return Object.freeze({...n(t),create:n})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const secp256k1P=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),secp256k1N=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),_1n=BigInt(1),_2n=BigInt(2),divNearest=(e,t)=>(e+t/_2n)/t;function sqrtMod(e){const t=secp256k1P,n=BigInt(3),r=BigInt(6),s=BigInt(11),o=BigInt(22),a=BigInt(23),c=BigInt(44),l=BigInt(88),u=e*e*e%t,f=u*u*e%t,h=pow2(f,n,t)*f%t,p=pow2(h,n,t)*f%t,b=pow2(p,_2n,t)*u%t,_=pow2(b,s,t)*b%t,g=pow2(_,o,t)*_%t,y=pow2(g,c,t)*g%t,w=pow2(y,l,t)*y%t,R=pow2(w,c,t)*g%t,S=pow2(R,n,t)*f%t,I=pow2(S,a,t)*_%t,O=pow2(I,r,t)*u%t,B=pow2(O,_2n,t);if(!Fp.eql(Fp.sqr(B),e))throw new Error("Cannot find square root");return B}const Fp=Field(secp256k1P,void 0,void 0,{sqrt:sqrtMod}),secp256k1=createCurve({a:BigInt(0),b:BigInt(7),Fp,n:secp256k1N,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:e=>{const t=secp256k1N,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-_1n*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,a=BigInt("0x100000000000000000000000000000000"),c=divNearest(o*e,t),l=divNearest(-r*e,t);let u=mod(e-c*n-l*s,t),f=mod(-c*r-l*o,t);const h=u>a,p=f>a;if(h&&(u=t-u),p&&(f=t-f),u>a||f>a)throw new Error("splitScalar: Endomorphism failed, k="+e);return{k1neg:h,k1:u,k2neg:p,k2:f}}}},sha256),_0n=BigInt(0),TAGGED_HASH_PREFIXES={};function taggedHash(e,...t){let n=TAGGED_HASH_PREFIXES[e];if(n===void 0){const r=sha256(Uint8Array.from(e,s=>s.charCodeAt(0)));n=concatBytes(r,r),TAGGED_HASH_PREFIXES[e]=n}return sha256(concatBytes(n,...t))}const pointToBytes=e=>e.toRawBytes(!0).slice(1),numTo32b=e=>numberToBytesBE(e,32),modP=e=>mod(e,secp256k1P),modN=e=>mod(e,secp256k1N),Point=secp256k1.ProjectivePoint,GmulAdd=(e,t,n)=>Point.BASE.multiplyAndAddUnsafe(e,t,n);function schnorrGetExtPubKey(e){let t=secp256k1.utils.normPrivateKeyToScalar(e),n=Point.fromPrivateKey(t);return{scalar:n.hasEvenY()?t:modN(-t),bytes:pointToBytes(n)}}function lift_x(e){aInRange("x",e,_1n,secp256k1P);const t=modP(e*e),n=modP(t*e+BigInt(7));let r=sqrtMod(n);r%_2n!==_0n&&(r=modP(-r));const s=new Point(e,r,_1n);return s.assertValidity(),s}const num=bytesToNumberBE;function challenge(...e){return modN(num(taggedHash("BIP0340/challenge",...e)))}function schnorrGetPublicKey(e){return schnorrGetExtPubKey(e).bytes}function schnorrSign(e,t,n=randomBytes(32)){const r=ensureBytes("message",e),{bytes:s,scalar:o}=schnorrGetExtPubKey(t),a=ensureBytes("auxRand",n,32),c=numTo32b(o^num(taggedHash("BIP0340/aux",a))),l=taggedHash("BIP0340/nonce",c,s,r),u=modN(num(l));if(u===_0n)throw new Error("sign failed: k is zero");const{bytes:f,scalar:h}=schnorrGetExtPubKey(u),p=challenge(f,s,r),b=new Uint8Array(64);if(b.set(f,0),b.set(numTo32b(modN(h+p*o)),32),!schnorrVerify(b,r,s))throw new Error("sign: Invalid signature produced");return b}function schnorrVerify(e,t,n){const r=ensureBytes("signature",e,64),s=ensureBytes("message",t),o=ensureBytes("publicKey",n,32);try{const a=lift_x(num(o)),c=num(r.subarray(0,32));if(!inRange(c,_1n,secp256k1P))return!1;const l=num(r.subarray(32,64));if(!inRange(l,_1n,secp256k1N))return!1;const u=challenge(numTo32b(c),pointToBytes(a),s),f=GmulAdd(a,l,modN(-u));return!(!f||!f.hasEvenY()||f.toAffine().x!==c)}catch{return!1}}const schnorr={getPublicKey:schnorrGetPublicKey,sign:schnorrSign,verify:schnorrVerify,utils:{randomPrivateKey:secp256k1.utils.randomPrivateKey,lift_x,pointToBytes,numberToBytesBE,bytesToNumberBE,taggedHash,mod}};var dist={},LRUCache$1={},LRUCacheNode$1={};Object.defineProperty(LRUCacheNode$1,"__esModule",{value:!0});LRUCacheNode$1.LRUCacheNode=void 0;class LRUCacheNode{constructor(t,n,r){const{entryExpirationTimeInMS:s=null,next:o=null,prev:a=null,onEntryEvicted:c,onEntryMarkedAsMostRecentlyUsed:l,clone:u,cloneFn:f}=r??{};if(typeof s=="number"&&(s<=0||Number.isNaN(s)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=u??!1,this.cloneFn=f??this.defaultClone,this.key=t,this.internalValue=this.clone?this.cloneFn(n):n,this.created=Date.now(),this.entryExpirationTimeInMS=s,this.next=o,this.prev=a,this.onEntryEvicted=c,this.onEntryMarkedAsMostRecentlyUsed=l}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:t,value:n,isExpired:r}=this;this.onEntryEvicted({key:t,value:n,isExpired:r})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:t,value:n}=this;this.onEntryMarkedAsMostRecentlyUsed({key:t,value:n})}}defaultClone(t){return typeof t=="boolean"||typeof t=="string"||typeof t=="number"?t:JSON.parse(JSON.stringify(t))}}LRUCacheNode$1.LRUCacheNode=LRUCacheNode;Object.defineProperty(LRUCache$1,"__esModule",{value:!0});LRUCache$1.LRUCache=void 0;const LRUCacheNode_1=LRUCacheNode$1;class LRUCache{constructor(t){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:n=25,entryExpirationTimeInMS:r=null,onEntryEvicted:s,onEntryMarkedAsMostRecentlyUsed:o,cloneFn:a,clone:c}=t??{};if(Number.isNaN(n)||n<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=n,this.entryExpirationTimeInMS=r,this.onEntryEvicted=s,this.onEntryMarkedAsMostRecentlyUsed=o,this.clone=c,this.cloneFn=a}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(t){if(Number.isNaN(t)||t<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=t,this.enforceSizeLimit()}set(t,n,r){const s=this.lookupTable.get(t);s&&this.removeNodeFromListAndLookupTable(s);const o=new LRUCacheNode_1.LRUCacheNode(t,n,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(o),this.lookupTable.set(t,o),this.enforceSizeLimit(),this}get(t){const n=this.lookupTable.get(t);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):(this.setNodeAsHead(n),n.value):null}peek(t){const n=this.lookupTable.get(t);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),null):n.value:null}delete(t){const n=this.lookupTable.get(t);return n?this.removeNodeFromListAndLookupTable(n):!1}has(t){const n=this.lookupTable.get(t);return n?n.isExpired?(this.removeNodeFromListAndLookupTable(n),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(t){let n=this.head;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}const r=this.mapNodeToEntry(n);if(t(r))return this.setNodeAsHead(n),r;n=n.next}return null}forEach(t){let n=this.head,r=0;for(;n;){if(n.isExpired){const s=n.next;this.removeNodeFromListAndLookupTable(n),n=s;continue}t(n.value,n.key,r),n=n.next,r++}}*values(){let t=this.head;for(;t;){if(t.isExpired){const n=t.next;this.removeNodeFromListAndLookupTable(t),t=n;continue}yield t.value,t=t.next}}*keys(){let t=this.head;for(;t;){if(t.isExpired){const n=t.next;this.removeNodeFromListAndLookupTable(t),t=n;continue}yield t.key,t=t.next}}*entries(){let t=this.head;for(;t;){if(t.isExpired){const n=t.next;this.removeNodeFromListAndLookupTable(t),t=n;continue}yield this.mapNodeToEntry(t),t=t.next}}*[Symbol.iterator](){let t=this.head;for(;t;){if(t.isExpired){const n=t.next;this.removeNodeFromListAndLookupTable(t),t=n;continue}yield this.mapNodeToEntry(t),t=t.next}}enforceSizeLimit(){let t=this.tail;for(;t!==null&&this.size>this.maxSizeInternal;){const n=t.prev;this.removeNodeFromListAndLookupTable(t),t=n}}mapNodeToEntry({key:t,value:n}){return{key:t,value:n}}setNodeAsHead(t){this.removeNodeFromList(t),this.head?(t.next=this.head,this.head.prev=t,this.head=t):(this.head=t,this.tail=t),t.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(t){t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.head===t&&(this.head=t.next),this.tail===t&&(this.tail=t.prev),t.next=null,t.prev=null}removeNodeFromListAndLookupTable(t){return t.invokeOnEvicted(),this.removeNodeFromList(t),this.lookupTable.delete(t.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const t=[];for(const n of this.lookupTable.values())n.isExpired&&t.push(n);t.forEach(n=>this.removeNodeFromListAndLookupTable(n))}}LRUCache$1.LRUCache=LRUCache;(function(e){var t=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(r,s,o,a){a===void 0&&(a=o);var c=Object.getOwnPropertyDescriptor(s,o);(!c||("get"in c?!s.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return s[o]}}),Object.defineProperty(r,a,c)}:function(r,s,o,a){a===void 0&&(a=o),r[a]=s[o]}),n=commonjsGlobal&&commonjsGlobal.__exportStar||function(r,s){for(var o in r)o!=="default"&&!Object.prototype.hasOwnProperty.call(s,o)&&t(s,r,o)};Object.defineProperty(e,"__esModule",{value:!0}),n(LRUCache$1,e)})(dist);/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function isBytes(e){return e instanceof Uint8Array||e!=null&&typeof e=="object"&&e.constructor.name==="Uint8Array"}function chain(...e){const t=o=>o,n=(o,a)=>c=>o(a(c)),r=e.map(o=>o.encode).reduceRight(n,t),s=e.map(o=>o.decode).reduce(n,t);return{encode:r,decode:s}}function alphabet(e){return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return t.map(n=>{if(n<0||n>=e.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${e.length})`);return e[n]})},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("alphabet.decode input should be array of strings");return t.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=e.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${e}`);return r})}}}function join(e=""){if(typeof e!="string")throw new Error("join separator should be string");return{encode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return t.join(e)},decode:t=>{if(typeof t!="string")throw new Error("join.decode input should be string");return t.split(e)}}}const gcd=(e,t)=>t?gcd(t,e%t):e,radix2carry=(e,t)=>e+(t-gcd(e,t));function convertRadix2(e,t,n,r){if(!Array.isArray(e))throw new Error("convertRadix2: data should be array");if(t<=0||t>32)throw new Error(`convertRadix2: wrong from=${t}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(radix2carry(t,n)>32)throw new Error(`convertRadix2: carry overflow from=${t} to=${n} carryBits=${radix2carry(t,n)}`);let s=0,o=0;const a=2**n-1,c=[];for(const l of e){if(l>=2**t)throw new Error(`convertRadix2: invalid data word=${l} from=${t}`);if(s=s<<t|l,o+t>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${t}`);for(o+=t;o>=n;o-=n)c.push((s>>o-n&a)>>>0);s&=2**o-1}if(s=s<<n-o&a,!r&&o>=t)throw new Error("Excess padding");if(!r&&s)throw new Error(`Non-zero padding: ${s}`);return r&&o>0&&c.push(s>>>0),c}function radix2(e,t=!1){if(e<=0||e>32)throw new Error("radix2: bits should be in (0..32]");if(radix2carry(8,e)>32||radix2carry(e,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!isBytes(n))throw new Error("radix2.encode input should be Uint8Array");return convertRadix2(Array.from(n),8,e,!t)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of numbers");return Uint8Array.from(convertRadix2(n,e,8,t))}}}function unsafeWrapper(e){if(typeof e!="function")throw new Error("unsafeWrapper fn should be function");return function(...t){try{return e.apply(null,t)}catch{}}}const BECH_ALPHABET=chain(alphabet("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),join("")),POLYMOD_GENERATORS=[996825010,642813549,513874426,1027748829,705979059];function bech32Polymod(e){const t=e>>25;let n=(e&33554431)<<5;for(let r=0;r<POLYMOD_GENERATORS.length;r++)(t>>r&1)===1&&(n^=POLYMOD_GENERATORS[r]);return n}function bechChecksum(e,t,n=1){const r=e.length;let s=1;for(let o=0;o<r;o++){const a=e.charCodeAt(o);if(a<33||a>126)throw new Error(`Invalid prefix (${e})`);s=bech32Polymod(s)^a>>5}s=bech32Polymod(s);for(let o=0;o<r;o++)s=bech32Polymod(s)^e.charCodeAt(o)&31;for(let o of t)s=bech32Polymod(s)^o;for(let o=0;o<6;o++)s=bech32Polymod(s);return s^=n,BECH_ALPHABET.encode(convertRadix2([s%2**30],30,5,!1))}function genBech32(e){const t=e==="bech32"?1:734539939,n=radix2(5),r=n.decode,s=n.encode,o=unsafeWrapper(r);function a(h,p,b=90){if(typeof h!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof h}`);if(p instanceof Uint8Array&&(p=Array.from(p)),!Array.isArray(p)||p.length&&typeof p[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof p}`);if(h.length===0)throw new TypeError(`Invalid prefix length ${h.length}`);const _=h.length+7+p.length;if(b!==!1&&_>b)throw new TypeError(`Length ${_} exceeds limit ${b}`);const g=h.toLowerCase(),y=bechChecksum(g,p,t);return`${g}1${BECH_ALPHABET.encode(p)}${y}`}function c(h,p=90){if(typeof h!="string")throw new Error(`bech32.decode input should be string, not ${typeof h}`);if(h.length<8||p!==!1&&h.length>p)throw new TypeError(`Wrong string length: ${h.length} (${h}). Expected (8..${p})`);const b=h.toLowerCase();if(h!==b&&h!==h.toUpperCase())throw new Error("String must be lowercase or uppercase");const _=b.lastIndexOf("1");if(_===0||_===-1)throw new Error('Letter "1" must be present between prefix and data only');const g=b.slice(0,_),y=b.slice(_+1);if(y.length<6)throw new Error("Data must be at least 6 characters long");const w=BECH_ALPHABET.decode(y).slice(0,-6),R=bechChecksum(g,w,t);if(!y.endsWith(R))throw new Error(`Invalid checksum in ${h}: expected "${R}"`);return{prefix:g,words:w}}const l=unsafeWrapper(c);function u(h){const{prefix:p,words:b}=c(h,!1);return{prefix:p,words:b,bytes:r(b)}}function f(h,p){return a(h,s(p))}return{encode:a,decode:c,encodeFromBytes:f,decodeToBytes:u,decodeUnsafe:l,fromWords:r,fromWordsUnsafe:o,toWords:s}}const bech32=genBech32("bech32");var lib={};(function(e){/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */Object.defineProperty(e,"__esModule",{value:!0}),e.bytes=e.stringToBytes=e.str=e.bytesToString=e.hex=e.utf8=e.bech32m=e.bech32=e.base58check=e.base58xmr=e.base58xrp=e.base58flickr=e.base58=e.base64url=e.base64=e.base32crockford=e.base32hex=e.base32=e.base16=e.utils=e.assertNumber=void 0;function t($){if(!Number.isSafeInteger($))throw new Error(`Wrong integer: ${$}`)}e.assertNumber=t;function n(...$){const x=(E,v)=>T=>E(v(T)),A=Array.from($).reverse().reduce((E,v)=>E?x(E,v.encode):v.encode,void 0),k=$.reduce((E,v)=>E?x(E,v.decode):v.decode,void 0);return{encode:A,decode:k}}function r($){return{encode:x=>{if(!Array.isArray(x)||x.length&&typeof x[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return x.map(A=>{if(t(A),A<0||A>=$.length)throw new Error(`Digit index outside alphabet: ${A} (alphabet: ${$.length})`);return $[A]})},decode:x=>{if(!Array.isArray(x)||x.length&&typeof x[0]!="string")throw new Error("alphabet.decode input should be array of strings");return x.map(A=>{if(typeof A!="string")throw new Error(`alphabet.decode: not string element=${A}`);const k=$.indexOf(A);if(k===-1)throw new Error(`Unknown letter: "${A}". Allowed: ${$}`);return k})}}}function s($=""){if(typeof $!="string")throw new Error("join separator should be string");return{encode:x=>{if(!Array.isArray(x)||x.length&&typeof x[0]!="string")throw new Error("join.encode input should be array of strings");for(let A of x)if(typeof A!="string")throw new Error(`join.encode: non-string input=${A}`);return x.join($)},decode:x=>{if(typeof x!="string")throw new Error("join.decode input should be string");return x.split($)}}}function o($,x="="){if(t($),typeof x!="string")throw new Error("padding chr should be string");return{encode(A){if(!Array.isArray(A)||A.length&&typeof A[0]!="string")throw new Error("padding.encode input should be array of strings");for(let k of A)if(typeof k!="string")throw new Error(`padding.encode: non-string input=${k}`);for(;A.length*$%8;)A.push(x);return A},decode(A){if(!Array.isArray(A)||A.length&&typeof A[0]!="string")throw new Error("padding.encode input should be array of strings");for(let E of A)if(typeof E!="string")throw new Error(`padding.decode: non-string input=${E}`);let k=A.length;if(k*$%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;k>0&&A[k-1]===x;k--)if(!((k-1)*$%8))throw new Error("Invalid padding: string has too much padding");return A.slice(0,k)}}}function a($){if(typeof $!="function")throw new Error("normalize fn should be function");return{encode:x=>x,decode:x=>$(x)}}function c($,x,A){if(x<2)throw new Error(`convertRadix: wrong from=${x}, base cannot be less than 2`);if(A<2)throw new Error(`convertRadix: wrong to=${A}, base cannot be less than 2`);if(!Array.isArray($))throw new Error("convertRadix: data should be array");if(!$.length)return[];let k=0;const E=[],v=Array.from($);for(v.forEach(T=>{if(t(T),T<0||T>=x)throw new Error(`Wrong integer: ${T}`)});;){let T=0,N=!0;for(let U=k;U<v.length;U++){const D=v[U],P=x*T+D;if(!Number.isSafeInteger(P)||x*T/x!==T||P-D!==x*T)throw new Error("convertRadix: carry overflow");if(T=P%A,v[U]=Math.floor(P/A),!Number.isSafeInteger(v[U])||v[U]*A+T!==P)throw new Error("convertRadix: carry overflow");if(N)v[U]?N=!1:k=U;else continue}if(E.push(T),N)break}for(let T=0;T<$.length-1&&$[T]===0;T++)E.push(0);return E.reverse()}const l=($,x)=>x?l(x,$%x):$,u=($,x)=>$+(x-l($,x));function f($,x,A,k){if(!Array.isArray($))throw new Error("convertRadix2: data should be array");if(x<=0||x>32)throw new Error(`convertRadix2: wrong from=${x}`);if(A<=0||A>32)throw new Error(`convertRadix2: wrong to=${A}`);if(u(x,A)>32)throw new Error(`convertRadix2: carry overflow from=${x} to=${A} carryBits=${u(x,A)}`);let E=0,v=0;const T=2**A-1,N=[];for(const U of $){if(t(U),U>=2**x)throw new Error(`convertRadix2: invalid data word=${U} from=${x}`);if(E=E<<x|U,v+x>32)throw new Error(`convertRadix2: carry overflow pos=${v} from=${x}`);for(v+=x;v>=A;v-=A)N.push((E>>v-A&T)>>>0);E&=2**v-1}if(E=E<<A-v&T,!k&&v>=x)throw new Error("Excess padding");if(!k&&E)throw new Error(`Non-zero padding: ${E}`);return k&&v>0&&N.push(E>>>0),N}function h($){return t($),{encode:x=>{if(!(x instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return c(Array.from(x),2**8,$)},decode:x=>{if(!Array.isArray(x)||x.length&&typeof x[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(c(x,$,2**8))}}}function p($,x=!1){if(t($),$<=0||$>32)throw new Error("radix2: bits should be in (0..32]");if(u(8,$)>32||u($,8)>32)throw new Error("radix2: carry overflow");return{encode:A=>{if(!(A instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return f(Array.from(A),8,$,!x)},decode:A=>{if(!Array.isArray(A)||A.length&&typeof A[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(f(A,$,8,x))}}}function b($){if(typeof $!="function")throw new Error("unsafeWrapper fn should be function");return function(...x){try{return $.apply(null,x)}catch{}}}function _($,x){if(t($),typeof x!="function")throw new Error("checksum fn should be function");return{encode(A){if(!(A instanceof Uint8Array))throw new Error("checksum.encode: input should be Uint8Array");const k=x(A).slice(0,$),E=new Uint8Array(A.length+$);return E.set(A),E.set(k,A.length),E},decode(A){if(!(A instanceof Uint8Array))throw new Error("checksum.decode: input should be Uint8Array");const k=A.slice(0,-$),E=x(k).slice(0,$),v=A.slice(-$);for(let T=0;T<$;T++)if(E[T]!==v[T])throw new Error("Invalid checksum");return k}}}e.utils={alphabet:r,chain:n,checksum:_,radix:h,radix2:p,join:s,padding:o},e.base16=n(p(4),r("0123456789ABCDEF"),s("")),e.base32=n(p(5),r("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),o(5),s("")),e.base32hex=n(p(5),r("0123456789ABCDEFGHIJKLMNOPQRSTUV"),o(5),s("")),e.base32crockford=n(p(5),r("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),s(""),a($=>$.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1"))),e.base64=n(p(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),o(6),s("")),e.base64url=n(p(6),r("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),o(6),s(""));const g=$=>n(h(58),r($),s(""));e.base58=g("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),e.base58flickr=g("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"),e.base58xrp=g("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const y=[0,2,3,5,6,7,9,10,11];e.base58xmr={encode($){let x="";for(let A=0;A<$.length;A+=8){const k=$.subarray(A,A+8);x+=e.base58.encode(k).padStart(y[k.length],"1")}return x},decode($){let x=[];for(let A=0;A<$.length;A+=11){const k=$.slice(A,A+11),E=y.indexOf(k.length),v=e.base58.decode(k);for(let T=0;T<v.length-E;T++)if(v[T]!==0)throw new Error("base58xmr: wrong padding");x=x.concat(Array.from(v.slice(v.length-E)))}return Uint8Array.from(x)}};const w=$=>n(_(4,x=>$($(x))),e.base58);e.base58check=w;const R=n(r("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),s("")),S=[996825010,642813549,513874426,1027748829,705979059];function I($){const x=$>>25;let A=($&33554431)<<5;for(let k=0;k<S.length;k++)(x>>k&1)===1&&(A^=S[k]);return A}function O($,x,A=1){const k=$.length;let E=1;for(let v=0;v<k;v++){const T=$.charCodeAt(v);if(T<33||T>126)throw new Error(`Invalid prefix (${$})`);E=I(E)^T>>5}E=I(E);for(let v=0;v<k;v++)E=I(E)^$.charCodeAt(v)&31;for(let v of x)E=I(E)^v;for(let v=0;v<6;v++)E=I(E);return E^=A,R.encode(f([E%2**30],30,5,!1))}function B($){const x=$==="bech32"?1:734539939,A=p(5),k=A.decode,E=A.encode,v=b(k);function T(P,H,z=90){if(typeof P!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof P}`);if(!Array.isArray(H)||H.length&&typeof H[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof H}`);const V=P.length+7+H.length;if(z!==!1&&V>z)throw new TypeError(`Length ${V} exceeds limit ${z}`);return P=P.toLowerCase(),`${P}1${R.encode(H)}${O(P,H,x)}`}function N(P,H=90){if(typeof P!="string")throw new Error(`bech32.decode input should be string, not ${typeof P}`);if(P.length<8||H!==!1&&P.length>H)throw new TypeError(`Wrong string length: ${P.length} (${P}). Expected (8..${H})`);const z=P.toLowerCase();if(P!==z&&P!==P.toUpperCase())throw new Error("String must be lowercase or uppercase");P=z;const V=P.lastIndexOf("1");if(V===0||V===-1)throw new Error('Letter "1" must be present between prefix and data only');const W=P.slice(0,V),q=P.slice(V+1);if(q.length<6)throw new Error("Data must be at least 6 characters long");const Z=R.decode(q).slice(0,-6),Y=O(W,Z,x);if(!q.endsWith(Y))throw new Error(`Invalid checksum in ${P}: expected "${Y}"`);return{prefix:W,words:Z}}const U=b(N);function D(P){const{prefix:H,words:z}=N(P,!1);return{prefix:H,words:z,bytes:k(z)}}return{encode:T,decode:N,decodeToBytes:D,decodeUnsafe:U,fromWords:k,fromWordsUnsafe:v,toWords:E}}e.bech32=B("bech32"),e.bech32m=B("bech32m"),e.utf8={encode:$=>new TextDecoder().decode($),decode:$=>new TextEncoder().encode($)},e.hex=n(p(4),r("0123456789abcdef"),s(""),a($=>{if(typeof $!="string"||$.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof $} with length ${$.length}`);return $.toLowerCase()}));const C={utf8:e.utf8,hex:e.hex,base16:e.base16,base32:e.base32,base64:e.base64,base64url:e.base64url,base58:e.base58,base58xmr:e.base58xmr},L=`Invalid encoding type. Available types: ${Object.keys(C).join(", ")}`,F=($,x)=>{if(typeof $!="string"||!C.hasOwnProperty($))throw new TypeError(L);if(!(x instanceof Uint8Array))throw new TypeError("bytesToString() expects Uint8Array");return C[$].encode(x)};e.bytesToString=F,e.str=e.bytesToString;const M=($,x)=>{if(!C.hasOwnProperty($))throw new TypeError(L);if(typeof x!="string")throw new TypeError("stringToBytes() expects string");return C[$].decode(x)};e.stringToBytes=M,e.bytes=e.stringToBytes})(lib);BigInt(1e3),BigInt(1e6),BigInt(1e9),BigInt(1e12);BigInt("2100000000000000000");BigInt(1e11);const TAGCODES={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27};for(let e=0,t=Object.keys(TAGCODES);e<t.length;e++)t[e],TAGCODES[t[e]].toString();function getRelaysForSync(e,t,n="write"){if(!e.outboxTracker)return;const r=e.outboxTracker.data.get(t);if(r)return n==="write"?r.writeRelays:r.readRelays}async function getWriteRelaysFor(e,t,n="write"){if(e.outboxTracker)return e.outboxTracker.data.has(t)||await e.outboxTracker.trackUsers([t]),getRelaysForSync(e,t,n)}function getTopRelaysForAuthors(e,t){const n=new Map;return t.forEach(s=>{const o=getRelaysForSync(e,s);o&&o.forEach(a=>{const c=n.get(a)||0;n.set(a,c+1)})}),Array.from(n.entries()).sort((s,o)=>o[1]-s[1]).map(s=>s[0])}function getAllRelaysForAllPubkeys(e,t,n="read"){const r=new Map,s=new Set;return t.forEach(o=>{const a=getRelaysForSync(e,o,n);a&&a.size>0?(a.forEach(c=>{(r.get(c)||new Set).add(o)}),r.set(o,a)):s.add(o)}),{pubkeysToRelays:r,authorsMissingRelays:s}}function chooseRelayCombinationForPubkeys(e,t,n,{count:r,preferredRelays:s}={}){r??(r=2),s??(s=new Set);const o=e.pool,a=o.connectedRelays();a.forEach(p=>{s.add(p.url)});const c=new Map,{pubkeysToRelays:l,authorsMissingRelays:u}=getAllRelaysForAllPubkeys(e,t,n),f=getTopRelaysForAuthors(e,t),h=(p,b)=>{const _=c.get(b)||[];_.push(p),c.set(b,_)};for(const[p,b]of l.entries()){let _=r;for(const g of a)b.has(g.url)&&(h(p,g.url),_--);for(const g of b)c.has(g)&&(h(p,g),_--);if(!(_<=0))for(const g of f){if(_<=0)break;b.has(g)&&(h(p,g),_--)}}for(const p of u)o.permanentAndConnectedRelays().forEach(b=>{const _=c.get(b.url)||[];_.push(p),c.set(b.url,_)});return c}function getRelaysForFilterWithAuthors(e,t,n=2){return chooseRelayCombinationForPubkeys(e,t,"write",{count:n})}function tryNormalizeRelayUrl(e){try{return normalizeRelayUrl(e)}catch{return}}function normalizeRelayUrl(e){let t=normalizeUrl(e.toLowerCase(),{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return t.endsWith("/")||(t+="/"),t}function normalize(e){const t=new Set;for(const n of e)try{t.add(normalizeRelayUrl(n))}catch{}return Array.from(t)}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(e,t)=>t.some(n=>n instanceof RegExp?n.test(e):n===e),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=e=>{try{const{protocol:t}=new URL(e);return t.endsWith(":")&&!t.includes(".")&&!supportedProtocols.has(t)}catch{return!1}},normalizeDataURL=(e,{stripHash:t})=>{var h,p,b,_;const n=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(e);if(!n)throw new Error(`Invalid URL: ${e}`);let r=((h=n.groups)==null?void 0:h.type)??"",s=((p=n.groups)==null?void 0:p.data)??"",o=((b=n.groups)==null?void 0:b.hash)??"";const a=r.split(";");o=t?"":o;let c=!1;a[a.length-1]==="base64"&&(a.pop(),c=!0);const l=((_=a.shift())==null?void 0:_.toLowerCase())??"",f=[...a.map(g=>{let[y,w=""]=g.split("=").map(R=>R.trim());return y==="charset"&&(w=w.toLowerCase(),w===DATA_URL_DEFAULT_CHARSET)?"":`${y}${w?`=${w}`:""}`}).filter(Boolean)];return c&&f.push("base64"),(f.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE)&&f.unshift(l),`data:${f.join(";")},${c?s.trim():s}${o?`#${o}`:""}`};function normalizeUrl(e,t){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),e=e.trim(),/^data:/i.test(e))return normalizeDataURL(e,t);if(hasCustomProtocol(e))return e;const n=e.startsWith("//");!n&&/^\.*\//.test(e)||(e=e.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const s=new URL(e);if(t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&s.protocol==="https:"&&(s.protocol="http:"),t.forceHttps&&s.protocol==="http:"&&(s.protocol="https:"),t.stripAuthentication&&(s.username="",s.password=""),t.stripHash?s.hash="":t.stripTextFragment&&(s.hash=s.hash.replace(/#?:~:text.*?$/i,"")),s.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let c=0,l="";for(;;){const f=a.exec(s.pathname);if(!f)break;const h=f[0],p=f.index,b=s.pathname.slice(c,p);l+=b.replace(/\/{2,}/g,"/"),l+=h,c=p+h.length}const u=s.pathname.slice(c,s.pathname.length);l+=u.replace(/\/{2,}/g,"/"),s.pathname=l}if(s.pathname)try{s.pathname=decodeURI(s.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let a=s.pathname.split("/");const c=a[a.length-1];testParameter(c,t.removeDirectoryIndex)&&(a=a.slice(0,-1),s.pathname=a.slice(1).join("/")+"/")}if(s.hostname&&(s.hostname=s.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(s.hostname)&&(s.hostname=s.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const a of[...s.searchParams.keys()])testParameter(a,t.removeQueryParameters)&&s.searchParams.delete(a);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(s.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const a of[...s.searchParams.keys()])testParameter(a,t.keepQueryParameters)||s.searchParams.delete(a);if(t.sortQueryParameters){s.searchParams.sort();try{s.search=decodeURIComponent(s.search)}catch{}}t.removeTrailingSlash&&(s.pathname=s.pathname.replace(/\/$/,"")),t.removeExplicitPort&&s.port&&(s.port="");const o=e;return e=s.toString(),!t.removeSingleSlash&&s.pathname==="/"&&!o.endsWith("/")&&s.hash===""&&(e=e.replace(/\/$/,"")),(t.removeTrailingSlash||s.pathname==="/")&&s.hash===""&&t.removeSingleSlash&&(e=e.replace(/\/$/,"")),n&&!t.normalizeProtocol&&(e=e.replace(/^http:\/\//,"//")),t.stripProtocol&&(e=e.replace(/^(?:https?:)?\/\//,"")),e}var NDKKind=(e=>(e[e.Metadata=0]="Metadata",e[e.Text=1]="Text",e[e.RecommendRelay=2]="RecommendRelay",e[e.Contacts=3]="Contacts",e[e.EncryptedDirectMessage=4]="EncryptedDirectMessage",e[e.EventDeletion=5]="EventDeletion",e[e.Repost=6]="Repost",e[e.Reaction=7]="Reaction",e[e.BadgeAward=8]="BadgeAward",e[e.GroupChat=9]="GroupChat",e[e.GroupNote=11]="GroupNote",e[e.GroupReply=12]="GroupReply",e[e.GenericRepost=16]="GenericRepost",e[e.ChannelCreation=40]="ChannelCreation",e[e.ChannelMetadata=41]="ChannelMetadata",e[e.ChannelMessage=42]="ChannelMessage",e[e.ChannelHideMessage=43]="ChannelHideMessage",e[e.ChannelMuteUser=44]="ChannelMuteUser",e[e.Media=1063]="Media",e[e.Report=1984]="Report",e[e.Label=1985]="Label",e[e.DVMReqTextExtraction=5e3]="DVMReqTextExtraction",e[e.DVMReqTextSummarization=5001]="DVMReqTextSummarization",e[e.DVMReqTextTranslation=5002]="DVMReqTextTranslation",e[e.DVMReqTextGeneration=5050]="DVMReqTextGeneration",e[e.DVMReqImageGeneration=5100]="DVMReqImageGeneration",e[e.DVMReqTextToSpeech=5250]="DVMReqTextToSpeech",e[e.DVMReqDiscoveryNostrContent=5300]="DVMReqDiscoveryNostrContent",e[e.DVMReqDiscoveryNostrPeople=5301]="DVMReqDiscoveryNostrPeople",e[e.DVMReqTimestamping=5900]="DVMReqTimestamping",e[e.DVMEventSchedule=5905]="DVMEventSchedule",e[e.DVMJobFeedback=7e3]="DVMJobFeedback",e[e.Subscribe=7001]="Subscribe",e[e.Unsubscribe=7002]="Unsubscribe",e[e.SubscriptionReceipt=7003]="SubscriptionReceipt",e[e.CashuQuote=7374]="CashuQuote",e[e.CashuToken=7375]="CashuToken",e[e.WalletChange=7376]="WalletChange",e[e.GroupAdminAddUser=9e3]="GroupAdminAddUser",e[e.GroupAdminRemoveUser=9001]="GroupAdminRemoveUser",e[e.GroupAdminEditMetadata=9002]="GroupAdminEditMetadata",e[e.GroupAdminEditStatus=9006]="GroupAdminEditStatus",e[e.GroupAdminCreateGroup=9007]="GroupAdminCreateGroup",e[e.GroupAdminRequestJoin=9021]="GroupAdminRequestJoin",e[e.MuteList=1e4]="MuteList",e[e.PinList=10001]="PinList",e[e.RelayList=10002]="RelayList",e[e.BookmarkList=10003]="BookmarkList",e[e.CommunityList=10004]="CommunityList",e[e.PublicChatList=10005]="PublicChatList",e[e.BlockRelayList=10006]="BlockRelayList",e[e.SearchRelayList=10007]="SearchRelayList",e[e.SimpleGroupList=10009]="SimpleGroupList",e[e.InterestList=10015]="InterestList",e[e.CashuMintList=10019]="CashuMintList",e[e.EmojiList=10030]="EmojiList",e[e.DirectMessageReceiveRelayList=10050]="DirectMessageReceiveRelayList",e[e.BlossomList=10063]="BlossomList",e[e.NostrWaletConnectInfo=13194]="NostrWaletConnectInfo",e[e.TierList=17e3]="TierList",e[e.FollowSet=3e4]="FollowSet",e[e.CategorizedPeopleList=3e4]="CategorizedPeopleList",e[e.CategorizedBookmarkList=30001]="CategorizedBookmarkList",e[e.RelaySet=30002]="RelaySet",e[e.CategorizedRelayList=30002]="CategorizedRelayList",e[e.BookmarkSet=30003]="BookmarkSet",e[e.CurationSet=30004]="CurationSet",e[e.ArticleCurationSet=30004]="ArticleCurationSet",e[e.VideoCurationSet=30005]="VideoCurationSet",e[e.InterestSet=30015]="InterestSet",e[e.InterestsList=30015]="InterestsList",e[e.EmojiSet=30030]="EmojiSet",e[e.ModularArticle=30040]="ModularArticle",e[e.ModularArticleItem=30041]="ModularArticleItem",e[e.Wiki=30818]="Wiki",e[e.Draft=31234]="Draft",e[e.SubscriptionTier=37001]="SubscriptionTier",e[e.EcashMintRecommendation=38e3]="EcashMintRecommendation",e[e.HighlightSet=39802]="HighlightSet",e[e.CategorizedHighlightList=39802]="CategorizedHighlightList",e[e.Nutzap=9321]="Nutzap",e[e.ZapRequest=9734]="ZapRequest",e[e.Zap=9735]="Zap",e[e.Highlight=9802]="Highlight",e[e.ClientAuth=22242]="ClientAuth",e[e.NostrWalletConnectReq=23194]="NostrWalletConnectReq",e[e.NostrWalletConnectRes=23195]="NostrWalletConnectRes",e[e.NostrConnect=24133]="NostrConnect",e[e.BlossomUpload=24242]="BlossomUpload",e[e.HttpAuth=27235]="HttpAuth",e[e.ProfileBadge=30008]="ProfileBadge",e[e.BadgeDefinition=30009]="BadgeDefinition",e[e.MarketStall=30017]="MarketStall",e[e.MarketProduct=30018]="MarketProduct",e[e.Article=30023]="Article",e[e.AppSpecificData=30078]="AppSpecificData",e[e.Classified=30402]="Classified",e[e.HorizontalVideo=34235]="HorizontalVideo",e[e.VerticalVideo=34236]="VerticalVideo",e[e.CashuWallet=37375]="CashuWallet",e[e.GroupMetadata=39e3]="GroupMetadata",e[e.GroupAdmins=39001]="GroupAdmins",e[e.GroupMembers=39002]="GroupMembers",e[e.AppRecommendation=31989]="AppRecommendation",e[e.AppHandler=31990]="AppHandler",e))(NDKKind||{}),MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{constructor(e,t){m(this,"ndkRelay");m(this,"ws");m(this,"_status");m(this,"timeoutMs");m(this,"connectedAt");m(this,"_connectionStats",{attempts:0,success:0,durations:[]});m(this,"debug");m(this,"connectTimeout");m(this,"reconnectTimeout");m(this,"ndk");m(this,"openSubs",new Map);m(this,"openCountRequests",new Map);m(this,"openEventPublishes",new Map);m(this,"serial",0);m(this,"baseEoseTimeout",4400);m(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=e,this._status=1;const n=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend("connectivity"+n),this.ndk=t}async connect(e,t=!0){if(this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),e??(e=this.timeoutMs),!this.timeoutMs&&e&&(this.timeoutMs=e),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(t),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(n){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,n),this._status=1,t?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2*24*60*60*1e3),n}}disconnect(){var e;this._status=0;try{(e=this.ws)==null||e.close()}catch(t){this.debug("Failed to disconnect",t),this._status=1}}onConnectionError(e){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),e&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){this.updateConnectionStats.disconnected(),this._status=1}onMessage(e){try{const t=JSON.parse(e.data),[n,r,...s]=t;switch(n){case"EVENT":{const o=this.openSubs.get(r),a=t[2];if(!o){this.debug(`Received event for unknown subscription ${r}`);return}o.onevent(a);return}case"COUNT":{const o=t[2],a=this.openCountRequests.get(r);a&&(a.resolve(o.count),this.openCountRequests.delete(r));return}case"EOSE":{const o=this.openSubs.get(r);if(!o)return;o.oneose(r);return}case"OK":{const o=t[2],a=t[3],c=this.openEventPublishes.get(r),l=c==null?void 0:c.pop();if(!c||!l){this.debug("Received OK for unknown event publish",r);return}o?l.resolve(a):l.reject(new Error(a)),c.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,c);return}case"CLOSED":{const o=this.openSubs.get(r);if(!o)return;o.onclosed(t[2]);return}case"NOTICE":this.onNotice(t[1]);return;case"AUTH":{this.onAuthRequested(t[1]);return}}}catch(t){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${t.message}`,t==null?void 0:t.stack);return}}async onAuthRequested(e){var n,r,s;const t=this.ndkRelay.authPolicy??((n=this.ndk)==null?void 0:n.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!t}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,t){if(this._status>=5){this._status=7;let o;try{o=await t(this.ndkRelay,e)}catch(a){this.debug("Authentication policy threw an error",a),o=!1}if(this.debug("Authentication policy returned",!!o),o instanceof NDKEvent||o===!0){o instanceof NDKEvent&&await this.auth(o);const a=async()=>{if(this._status>=5&&this._status<8){const c=new NDKEvent(this.ndk);c.kind=22242,c.tags=[["relay",this.ndkRelay.url],["challenge",e]],await c.sign(),this.auth(c).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(l=>{this._status=6,this.ndkRelay.emit("auth:failed",l),this.debug("Authentication failed",l)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};o===!0&&((r=this.ndk)!=null&&r.signer?a().catch(c=>{console.error("Error authenticating",c)}):(this.debug("No signer available for authentication localhost"),(s=this.ndk)==null||s.once("signer:ready",a))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",e)}onError(e){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,e)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const e=this._connectionStats.durations;if(e.length%3!==0)return!1;const n=e.reduce((a,c)=>a+c,0)/e.length,r=e.map(a=>Math.pow(a-n,2)).reduce((a,c)=>a+c,0)/e.length;return Math.sqrt(r)<FLAPPING_THRESHOLD_MS}async onNotice(e){this.ndkRelay.emit("notice",e)}handleReconnection(e=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}const t=this.connectedAt?Math.max(0,6e4-(Date.now()-this.connectedAt)):5e3*(this._connectionStats.attempts+1);this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(n=>{e<MAX_RECONNECT_ATTEMPTS?setTimeout(()=>{this.handleReconnection(e+1)},1e3*(e+1)^4):this.debug("Reconnect failed")})},t),this.ndkRelay.emit("delayed-connect",t),this.debug("Reconnecting in",t),this._connectionStats.nextReconnectAt=Date.now()+t}async send(e){var t,n;this._status>=5&&((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN?(n=this.ws)==null||n.send(e):this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${e}`,this._status)}async auth(e){const t=new Promise((n,r)=>{const s=this.openEventPublishes.get(e.id)??[];s.push({resolve:n,reject:r}),this.openEventPublishes.set(e.id,s)});return this.send('["AUTH",'+JSON.stringify(e.rawEvent())+"]"),t}async publish(e){const t=new Promise((n,r)=>{const s=this.openEventPublishes.get(e.id)??[];s.length>0&&console.warn("Duplicate event publishing detected, you are publishing event "+e.id+" twice"),s.push({resolve:n,reject:r}),this.openEventPublishes.set(e.id,s)});return this.send('["EVENT",'+JSON.stringify(e)+"]"),t}async count(e,t){this.serial++;const n=(t==null?void 0:t.id)||"count:"+this.serial,r=new Promise((s,o)=>{this.openCountRequests.set(n,{resolve:s,reject:o})});return this.send('["COUNT","'+n+'",'+JSON.stringify(e).substring(1)),r}close(e,t){this.send('["CLOSE","'+e+'"]');const n=this.openSubs.get(e);this.openSubs.delete(e),n&&n.onclose(t)}req(e){this.send('["REQ","'+e.subId+'",'+JSON.stringify(e.executeFilters).substring(1))+"",this.openSubs.set(e.subId,e)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var e;return this._status>=5&&((e=this.ws)==null?void 0:e.readyState)===WebSocket.OPEN}},NDKRelayPublisher=class{constructor(e){m(this,"ndkRelay");m(this,"debug");this.ndkRelay=e,this.debug=e.debug.extend("publisher")}async publish(e,t=2500){let n;const r=()=>new Promise((f,h)=>{try{this.publishEvent(e).then(p=>{this.ndkRelay.emit("published",e),e.emit("relay:published",this.ndkRelay),f(!0)}).catch(h)}catch(p){h(p)}}),s=new Promise((f,h)=>{n=setTimeout(()=>{n=void 0,h(new Error("Timeout: "+t+"ms"))},t)}),o=()=>{r().then(f=>a(f)).catch(f=>c(f))};let a,c;const l=f=>{throw this.ndkRelay.debug("Publish failed",f,e.id),this.ndkRelay.emit("publish:failed",e,f),e.emit("relay:publish:failed",this.ndkRelay,f),f},u=()=>{n&&clearTimeout(n),this.ndkRelay.removeListener("connect",o)};return this.ndkRelay.status>=5?Promise.race([r(),s]).catch(l).finally(u):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((f,h)=>{a=f,c=h,this.ndkRelay.once("connect",o)}),s]).catch(l).finally(u))}async publishEvent(e){return this.ndkRelay.connectivity.publish(e.rawEvent())}};function filterFingerprint(e,t){const n=[];for(const s of e){if(s.since||s.until)return;const a=Object.keys(s||{}).sort().join("-");n.push(a)}let r=t?"+":"";return r+=n.join("|"),r}function mergeFilters(e){const t={};return e.forEach(n=>{Object.entries(n).forEach(([r,s])=>{Array.isArray(s)?t[r]===void 0?t[r]=[...s]:t[r]=Array.from(new Set([...t[r],...s])):t[r]=s})}),t}var NDKRelaySubscription=class{constructor(e,t){m(this,"fingerprint");m(this,"items",new Map);m(this,"topSubscriptionManager");m(this,"debug");m(this,"status",0);m(this,"onClose");m(this,"relay");m(this,"eosed",!1);m(this,"itemsToRemoveAfterEose",[]);m(this,"executionTimer");m(this,"fireTime");m(this,"delayType");m(this,"executeFilters");m(this,"eventIds",new Set);m(this,"_subId");m(this,"subIdParts",new Set);m(this,"executeOnRelayReady",()=>{this.status===2&&(this.status=1,this.execute())});m(this,"reExecuteAfterAuth",(()=>{const e=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:e}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",e,this.subId)}).bind(this));this.relay=e;const n=Math.random().toString(36).substring(7);this.debug=e.debug.extend("subscription-"+n),this.fingerprint=t||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(e){this.subIdParts.add(e)}addItem(e,t){if(!this.items.has(e.internalId))switch(e.on("close",this.removeItem.bind(this,e)),this.items.set(e.internalId,{subscription:e,filters:t}),this.status!==3&&e.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(e.subId),this.status){case 0:this.evaluateExecutionPlan(e);break;case 3:break;case 1:this.evaluateExecutionPlan(e);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",e,t),new Error("Cannot add new items to a closed subscription")}}removeItem(e){if(!this.eosed){this.itemsToRemoveAfterEose.push(e.internalId);return}this.items.delete(e.internalId),this.items.size===0&&this.close()}close(){if(this.status===4)return;const e=this.status;if(this.status=4,e===3)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:e,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}catchUpSubscription(e,t){this.debug("TODO: catch up subscription",e,t)}evaluateExecutionPlan(e){if(!e.isGroupable()){this.status=1,this.execute();return}const t=e.groupableDelay,n=e.groupableDelayType;if(!t)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(t,n);else{const r=this.delayType,s=this.fireTime-Date.now();if(r==="at-least"&&n==="at-least")s<t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,n));else if(r==="at-least"&&n==="at-most")s>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,n));else if(r==="at-most"&&n==="at-most")s>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,n));else if(r==="at-most"&&n==="at-least")s>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,n));else throw new Error("Unknown delay type combination "+r+" "+n)}}schedule(e,t){this.status=1;const n=Date.now();this.fireTime=n+e,this.delayType=t;const r=setTimeout(this.execute.bind(this),e);t==="at-least"&&(this.executionTimer=r)}finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+="-"+Math.random().toString(36).substring(2,7)}execute(){if(this.status===1){if(this.relay.connected)this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth);else{this.status=2,this.relay.once("ready",this.executeOnRelayReady);return}this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(e){var t;(t=this.topSubscriptionManager)==null||t.seenEvent(e.id,this.relay);for(const{subscription:n}of this.items.values())matchFilters(n.filters,e)&&n.eventReceived(e,this.relay,!1)}oneose(e){if(this.eosed=!0,e!==this.subId){this.debug("Received EOSE for an abandoned subscription",e,this.subId),this.relay.close(e);return}for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&this.removeItem(t)}onclose(e){this.status=4}onclosed(e){if(e)for(const{subscription:t}of this.items.values())t.closedReceived(this.relay,e)}compileFilters(){const e=[],t=Array.from(this.items.values()).map(r=>r.filters);t[0]||(this.debug(" No filters to merge",this.items),console.trace("No filters to merge"));const n=t[0].length;for(let r=0;r<n;r++){const s=t.map(o=>o[r]);e.push(mergeFilters(s))}return e}},NDKRelaySubscriptionManager=class{constructor(e,t){m(this,"relay");m(this,"subscriptions");m(this,"topSubscriptionManager");m(this,"debug");this.relay=e,this.subscriptions=new Map,this.debug=e.debug.extend("sub-manager"),this.topSubscriptionManager=t}addSubscription(e,t){let n;if(!e.isGroupable())n=this.createSubscription(e,t);else{const r=filterFingerprint(t,e.closeOnEose);r&&(n=this.subscriptions.get(r)),n??(n=this.createSubscription(e,t,r))}n.addItem(e,t)}createSubscription(e,t,n){const r=new NDKRelaySubscription(this.relay,n);return r.topSubscriptionManager=this.topSubscriptionManager,r.onClose=this.onRelaySubscriptionClose.bind(this),this.subscriptions.set(r.fingerprint,r),r}onRelaySubscriptionClose(e){this.subscriptions.delete(e.fingerprint)}},re,NDKRelay=(re=class extends lib$1.EventEmitter{constructor(n,r,s){super();m(this,"url");m(this,"scores");m(this,"connectivity");m(this,"subs");m(this,"publisher");m(this,"authPolicy");m(this,"lowestValidationRatio");m(this,"targetValidationRatio");m(this,"validationRatioFn");m(this,"validatedEventCount",0);m(this,"nonValidatedEventCount",0);m(this,"trusted",!1);m(this,"complaining",!1);m(this,"debug");m(this,"req");m(this,"close");this.url=normalizeRelayUrl(n),this.scores=new Map,this.debug=debug7(`ndk:relay:${n}`),this.connectivity=new NDKRelayConnectivity(this,s),this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,s==null?void 0:s.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=r,this.targetValidationRatio=s==null?void 0:s.initialValidationRatio,this.lowestValidationRatio=s==null?void 0:s.lowestValidationRatio,this.validationRatioFn=((s==null?void 0:s.validationRatioFn)??re.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),s||console.trace("relay created without ndk")}updateValidationRatio(){setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(n,r=!0){return this.connectivity.connect(n,r)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(n,r){this.subs.addSubscription(n,r)}async publish(n,r=2500){return this.publisher.publish(n,r)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0?!0:this.validationRatio<this.targetValidationRatio}get connected(){return this.connectivity.connected}},m(re,"defaultValidationRatioUpdateFn",(n,r,s)=>{if(n.lowestValidationRatio===void 0||n.targetValidationRatio===void 0)return 1;let o=n.validationRatio;if(n.validationRatio>n.targetValidationRatio){const a=r/100;o=Math.max(n.lowestValidationRatio,n.validationRatio-a)}return o<n.validationRatio?o:n.validationRatio}),re),NDKPublishError=class extends Error{constructor(t,n,r,s){super(t);m(this,"errors");m(this,"publishedToRelays");m(this,"intendedRelaySet");this.errors=n,this.publishedToRelays=r,this.intendedRelaySet=s}get relayErrors(){const t=[];for(const[n,r]of this.errors)t.push(`${n.url}: ${r}`);return t.join(`
`)}},NDKRelaySet=class ae{constructor(t,n){m(this,"relays");m(this,"debug");m(this,"ndk");this.relays=t,this.ndk=n,this.debug=n.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(t,n,r=!0){const s=new Set;for(const o of t){const a=n.pool.relays.get(normalizeRelayUrl(o));if(a)a.status<5&&r&&a.connect(),s.add(a);else{const c=new NDKRelay(normalizeRelayUrl(o),n==null?void 0:n.relayAuthDefaultPolicy,n);n.pool.useTemporaryRelay(c,void 0,"requested from fromRelayUrls "+t),s.add(c)}}return new ae(new Set(s),n)}async publish(t,n,r=1){const s=new Set,o=new Map,a=t.isEphemeral();t.publishStatus="pending";const c=Array.from(this.relays).map(l=>new Promise(u=>{l.publish(t,n).then(f=>{s.add(l),u()}).catch(f=>{a||o.set(l,f),u()})}));if(await Promise.all(c),s.size<r){if(!a){const l=new NDKPublishError("Not enough relays received the event",o,s,this);throw t.publishStatus="error",t.publishError=l,this.ndk.emit("event:publish-failed",t,l,this.relayUrls),l}}else t.emit("published",{relaySet:this,publishedToRelays:s});return s}get size(){return this.relays.size}},d=debug7("ndk:outbox:calculate");async function calculateRelaySetFromEvent(e,t){var a;const n=new Set,r=await getWriteRelaysFor(e,t.pubkey);r&&r.forEach(c=>{var u;const l=(u=e.pool)==null?void 0:u.getRelay(c);l&&n.add(l)});let s=t.tags.filter(c=>["a","e"].includes(c[0])).map(c=>c[2]).filter(c=>c&&c.startsWith("wss://")).filter(c=>{try{return new URL(c),!0}catch{return!1}}).map(c=>normalizeRelayUrl(c));s=Array.from(new Set(s)).slice(0,5),s.forEach(c=>{var u;const l=(u=e.pool)==null?void 0:u.getRelay(c,!0,!0);l&&(d("Adding relay hint %s",c),n.add(l))});const o=t.getMatchingTags("p").map(c=>c[1]);return o.length<5?Array.from(chooseRelayCombinationForPubkeys(e,o,"read",{preferredRelays:new Set(r)}).keys()).forEach(l=>{var f;const u=(f=e.pool)==null?void 0:f.getRelay(l,!1,!0);u&&(d("Adding p-tagged relay %s",l),n.add(u))}):d("Too many p-tags to consider %d",o.length),(a=e.pool)==null||a.permanentAndConnectedRelays().forEach(c=>n.add(c)),new NDKRelaySet(n,e)}function calculateRelaySetsFromFilter(e,t,n){const r=new Map,s=new Set;if(t.forEach(o=>{o.authors&&o.authors.forEach(a=>s.add(a))}),s.size>0){const o=getRelaysForFilterWithAuthors(e,Array.from(s));for(const a of o.keys())r.set(a,[]);for(const a of t)if(a.authors)for(const[c,l]of o.entries()){const u=a.authors.filter(f=>l.includes(f));r.set(c,[...r.get(c),{...a,authors:u}])}else for(const c of o.keys())r.set(c,[...r.get(c),a])}else e.explicitRelayUrls&&e.explicitRelayUrls.forEach(o=>{r.set(o,t)});return r.size===0&&n.permanentAndConnectedRelays().slice(0,5).forEach(o=>{r.set(o.url,t)}),r.size===0&&console.warn("No relays found for filter",t),r}function calculateRelaySetsFromFilters(e,t,n){return calculateRelaySetsFromFilter(e,t,n)}function mergeTags(e,t){const n=new Map,r=a=>a.join(","),s=(a,c)=>a.every((l,u)=>l===c[u]),o=a=>{for(const[c,l]of n)if(s(l,a)||s(a,l)){a.length>=l.length&&n.set(c,a);return}n.set(r(a),a)};return e.concat(t).forEach(o),Array.from(n.values())}async function generateContentTags(e,t=[]){const n=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,r=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g"),s=[],o=a=>{t.find(c=>["q",a[0]].includes(c[0])&&c[1]===a[1])||t.push(a)};return e=e.replace(n,a=>{try{const c=a.split(/(@|nostr:)/)[2],{type:l,data:u}=nip19_exports.decode(c);let f;switch(l){case"npub":f=["p",u];break;case"nprofile":f=["p",u.pubkey];break;case"note":s.push(new Promise(async h=>{o(["e",u,await maybeGetEventRelayUrl(c),"mention"]),h()}));break;case"nevent":s.push(new Promise(async h=>{const{id:p,author:b}=u;let{relays:_}=u;(!_||_.length===0)&&(_=[await maybeGetEventRelayUrl(c)]),o(["e",p,_[0],"mention"]),b&&o(["p",b]),h()}));break;case"naddr":s.push(new Promise(async h=>{const p=[u.kind,u.pubkey,u.identifier].join(":");let b=u.relays??[];b.length===0&&(b=[await maybeGetEventRelayUrl(c)]),o(["a",p,b[0],"mention"]),o(["p",u.pubkey]),h()}));break;default:return a}return f&&o(f),`nostr:${c}`}catch{return a}}),await Promise.all(s),e=e.replace(r,(a,c)=>{const l=["t",c.slice(1)];return t.find(u=>u[0]===l[0]&&u[1]===l[1])||t.push(l),a}),{content:e,tags:t}}async function maybeGetEventRelayUrl(e){return""}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_ENCRYPTION_SCHEME="nip04";async function encrypt(e,t,n=DEFAULT_ENCRYPTION_SCHEME){if(!this.ndk)throw new Error("No NDK instance found!");if(t||(await this.ndk.assertSigner(),t=this.ndk.signer),!e){const r=this.getMatchingTags("p");if(r.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");e=this.ndk.getUser({pubkey:r[0][1]})}this.content=await(t==null?void 0:t.encrypt(e,this.content,n))}async function decrypt(e,t,n=DEFAULT_ENCRYPTION_SCHEME){if(!this.ndk)throw new Error("No NDK instance found!");t||(await this.ndk.assertSigner(),t=this.ndk.signer),e||(e=this.author),this.content=await(t==null?void 0:t.decrypt(e,this.content,n))}function encode(e=5){let t=[];return this.onRelays.length>0?t=this.onRelays.map(n=>n.url):this.relay&&(t=[this.relay.url]),t.length>e&&(t=t.slice(0,e)),this.isParamReplaceable()?nip19_exports.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:t}):t.length>0?nip19_exports.neventEncode({id:this.tagId(),relays:t,author:this.pubkey}):nip19_exports.noteEncode(this.tagId())}async function repost(e=!0,t){if(!t&&e){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t=this.ndk.signer}const n=new NDKEvent(this.ndk,{kind:getKind(this),content:""});return n.tag(this),n.kind===16?n.tags.push(["k",`${this.kind}`]):n.content=JSON.stringify(this.rawEvent()),t&&await n.sign(t),e&&await n.publish(),n}function getKind(e){return e.kind===1?6:16}function eventHasETagMarkers(e){return e.getMatchingTags("e").some(t=>t[3])}function getRootTag(e,t){t??(t=e.tagType());const n=e.tags.find(r=>r[3]==="root");if(!n){if(eventHasETagMarkers(e))return;const r=e.getMatchingTags(t);if(r.length<3)return r[0]}return n}function getReplyTag(e,t){t??(t=e.tagType());let n=e.tags.find(r=>r[3]==="reply");if(n)return n;if(n||(n=e.tags.find(r=>r[3]==="root")),!n){if(eventHasETagMarkers(e))return;const r=e.getMatchingTags(t);if(r.length===1)return r[0];if(r.length===2)return r[1]}}async function fetchTaggedEvent(e,t){if(!this.ndk)throw new Error("NDK instance not found");const n=this.getMatchingTags(e,t);if(n.length===0)return;const[r,s,o]=n[0];return await this.ndk.fetchEvent(s,{},void 0)}async function fetchRootEvent(e){if(!this.ndk)throw new Error("NDK instance not found");const t=getRootTag(this);if(t)return this.ndk.fetchEventFromTag(t,this,e)}async function fetchReplyEvent(e){if(!this.ndk)throw new Error("NDK instance not found");const t=getReplyTag(this);if(t)return this.ndk.fetchEventFromTag(t,this,e)}function serialize(e=!1,t=!1){const n=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return e&&n.push(this.sig),t&&n.push(this.id),JSON.stringify(n)}function deserialize(e){const t=JSON.parse(e),n={pubkey:t[1],created_at:t[2],kind:t[3],tags:t[4],content:t[5]};return t.length===7&&(n.sig=t[6]),t.length===8&&(n.id=t[7]),n}var worker,processingQueue={};function signatureVerificationInit(e){worker=e,worker.onmessage=t=>{const[n,r]=t.data,s=processingQueue[n];if(!s){console.error("No record found for event",n);return}delete processingQueue[n];for(const o of s.resolves)o(r)}}async function verifySignatureAsync(e,t){return new Promise(r=>{const s=e.serialize();let o=!1;processingQueue[e.id]||(processingQueue[e.id]={event:e,resolves:[]},o=!0),processingQueue[e.id].resolves.push(r),o&&worker.postMessage({serialized:s,id:e.id,sig:e.sig,pubkey:e.pubkey})})}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let e=0;e<this.tags.length;e++){const t=this.tags[e];if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(typeof t[n]=="object")return!1}return!0}var verifiedSignatures=new dist.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(e){var n;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const t=verifiedSignatures.get(this.id);if(t!==null)return this.signatureVerified=!!t;try{if((n=this.ndk)!=null&&n.asyncSigVerification)verifySignatureAsync(this,e).then(r=>{e&&(this.signatureVerified=r,r&&verifiedSignatures.set(this.id,this.sig)),r||(this.ndk.emit("event:invalid-sig",this),verifiedSignatures.set(this.id,!1))});else{const r=sha256(new TextEncoder().encode(this.serialize())),s=schnorr.verify(this.sig,r,this.pubkey);return s?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=s}}catch{return this.signatureVerified=!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(e){const t=sha256(new TextEncoder().encode(e));return bytesToHex$1(t)}var skipClientTagOnKinds=[3],NDKEvent=class se extends lib$1.EventEmitter{constructor(n,r){var s;super();m(this,"ndk");m(this,"created_at");m(this,"content","");m(this,"tags",[]);m(this,"kind");m(this,"id","");m(this,"sig");m(this,"pubkey","");m(this,"signatureVerified");m(this,"_author");m(this,"relay");m(this,"publishStatus","success");m(this,"publishError");m(this,"serialize",serialize.bind(this));m(this,"getEventHash",getEventHash.bind(this));m(this,"validate",validate.bind(this));m(this,"verifySignature",verifySignature.bind(this));m(this,"isReplaceable",isReplaceable.bind(this));m(this,"isEphemeral",isEphemeral.bind(this));m(this,"isParamReplaceable",isParamReplaceable.bind(this));m(this,"encode",encode.bind(this));m(this,"encrypt",encrypt.bind(this));m(this,"decrypt",decrypt.bind(this));m(this,"fetchTaggedEvent",fetchTaggedEvent.bind(this));m(this,"fetchRootEvent",fetchRootEvent.bind(this));m(this,"fetchReplyEvent",fetchReplyEvent.bind(this));m(this,"repost",repost.bind(this));this.ndk=n,this.created_at=r==null?void 0:r.created_at,this.content=(r==null?void 0:r.content)||"",this.tags=(r==null?void 0:r.tags)||[],this.id=(r==null?void 0:r.id)||"",this.sig=r==null?void 0:r.sig,this.pubkey=(r==null?void 0:r.pubkey)||"",this.kind=r==null?void 0:r.kind,r instanceof se&&(this.relay&&(this.relay=r.relay,(s=this.ndk)==null||s.subManager.seenEvent(r.id,this.relay)),this.publishStatus=r.publishStatus,this.publishError=r.publishError)}get onRelays(){let n=[];return this.ndk?n=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&n.push(this.relay),n}static deserialize(n,r){return new se(n,deserialize(r))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(n){var r;this.pubkey=n.pubkey,this._author=n,(r=this._author).ndk??(r.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const n=this.ndk.getUser({pubkey:this.pubkey});return this._author=n,n}tagExternal(n,r,s){let o=["i"],a=["k"];switch(r){case"url":const c=new URL(n);c.hash="",o.push(c.toString()),a.push(`${c.protocol}//${c.host}`);break;case"hashtag":o.push(`#${n.toLowerCase()}`),a.push("#");break;case"geohash":o.push(`geo:${n.toLowerCase()}`),a.push("geo");break;case"isbn":o.push(`isbn:${n.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":o.push(`podcast:guid:${n}`),a.push("podcast:guid");break;case"podcast:item:guid":o.push(`podcast:item:guid:${n}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":o.push(`podcast:publisher:guid:${n}`),a.push("podcast:publisher:guid");break;case"isan":o.push(`isan:${n.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":o.push(`doi:${n.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${r}`)}s&&o.push(s),this.tags.push(o),this.tags.push(a)}tag(n,r,s,o){let a=[];if(n.fetchProfile!==void 0){o??(o="p");const l=[o,n.pubkey];r&&l.push("",r),a.push(l)}else if(n instanceof se){const l=n;s??(s=(l==null?void 0:l.pubkey)===this.pubkey),a=l.referenceTags(r,s,o);for(const u of l.getMatchingTags("p"))u[1]!==this.pubkey&&(this.tags.find(f=>f[0]==="p"&&f[1]===u[1])||this.tags.push(["p",u[1]]))}else if(Array.isArray(n))a=[n];else throw new Error("Invalid argument",n);this.tags=mergeTags(this.tags,a)}async toNostrEvent(n){var o,a;if(!n&&this.pubkey===""){const c=await((a=(o=this.ndk)==null?void 0:o.signer)==null?void 0:a.user());this.pubkey=(c==null?void 0:c.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:r,tags:s}=await this.generateTags();this.content=r||"",this.tags=s;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(n,r){const s=this.tags.filter(o=>o[0]===n);return r===void 0?s:s.filter(o=>o[3]===r)}hasTag(n,r){return this.tags.some(s=>s[0]===n&&(!r||s[3]===r))}tagValue(n){const r=this.getMatchingTags(n);if(r.length!==0)return r[0][1]}get alt(){return this.tagValue("alt")}set alt(n){this.removeTag("alt"),n&&this.tags.push(["alt",n])}get dTag(){return this.tagValue("d")}set dTag(n){this.removeTag("d"),n&&this.tags.push(["d",n])}removeTag(n){const r=Array.isArray(n)?n:[n];this.tags=this.tags.filter(s=>!r.includes(s[0]))}async sign(n){var s;n?this.author=await n.user():((s=this.ndk)==null||s.assertSigner(),n=this.ndk.signer);const r=await this.toNostrEvent();return this.sig=await n.sign(r),this.sig}async publishReplaceable(n,r,s){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(n,r,s)}async publish(n,r,s){var c,l;if(this.sig||await this.sign(),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");n||(n=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this)),this.kind===5&&((c=this.ndk.cacheAdapter)!=null&&c.deleteEvent)&&this.ndk.cacheAdapter.deleteEvent(this);const o=this.rawEvent();if((l=this.ndk.cacheAdapter)!=null&&l.addUnpublishedEvent)try{this.ndk.cacheAdapter.addUnpublishedEvent(this,n.relayUrls)}catch(u){console.error("Error adding unpublished event to cache",u)}this.ndk.subManager.subscriptions.forEach(u=>{u.filters.some(f=>matchFilter(f,o))&&u.eventReceived(this,void 0,!1,!0)});const a=await n.publish(this,r,s);return a.forEach(u=>{var f;return(f=this.ndk)==null?void 0:f.subManager.seenEvent(this.id,u)}),a}async generateTags(){var o,a;let n=[];const r=await generateContentTags(this.content,this.tags),s=r.content;if(n=r.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const l=this.tagValue("title");let f=[...Array(l?6:16)].map(()=>Math.random().toString(36)[2]).join("");l&&l.length>0&&(f=l.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")+"-"+f),n.push(["d",f])}if(((o=this.ndk)!=null&&o.clientName||(a=this.ndk)!=null&&a.clientNip89)&&skipClientTagOnKinds.includes(this.kind)&&!this.tags.some(c=>c[0]==="client")){const c=["client",this.ndk.clientName??""];this.ndk.clientNip89&&c.push(this.ndk.clientNip89),n.push(c)}return{content:s||"",tags:n}}muted(){var o,a;const n=(o=this.ndk)==null?void 0:o.mutedIds.get(this.pubkey);if(n&&n==="p")return"author";const r=this.tagReference(),s=(a=this.ndk)==null?void 0:a.mutedIds.get(r[1]);return s&&s===r[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const n=this.getMatchingTags("d")[0];return n?n[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(!this.isParamReplaceable())throw new Error("This must only be called on replaceable events");const n=this.replaceableDTag();return`${this.kind}:${this.pubkey}:${n}`}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(n){let r;return this.isParamReplaceable()?r=["a",this.tagAddress()]:r=["e",this.tagId()],this.relay?r.push(this.relay.url):r.push(""),n&&r.push(n),r}referenceTags(n,r,s){var a;let o=[];return this.isParamReplaceable()?o=[[s??"a",this.tagAddress()],[s??"e",this.id]]:o=[[s??"e",this.id]],(a=this.relay)!=null&&a.url?o=o.map(c=>{var l;return c.push((l=this.relay)==null?void 0:l.url),c}):n&&(o=o.map(c=>(c.push(""),c))),n&&o.forEach(c=>c.push(n)),o=[...o,...this.getMatchingTags("h")],r||o.push(...this.author.referenceTags()),o}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}async delete(n,r=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const s=new se(this.ndk,{kind:5,content:n||""});return s.tag(this,void 0,!0),s.tags.push(["k",this.kind.toString()]),r&&await s.publish(),s}async react(n,r=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const s=new se(this.ndk,{kind:7,content:n});return s.tag(this),r?await s.publish():await s.sign(),s}get isValid(){return this.validate()}};function queryFullyFilled(e){return!!(filterIncludesIds(e.filter)&&resultHasAllRequestedIds(e))}function filterIncludesIds(e){return!!e.ids}function resultHasAllRequestedIds(e){const t=e.filter.ids;return!!t&&t.length===e.eventFirstSeen.size}function filterFromId(e){let t;if(e.match(NIP33_A_REGEX)){const[n,r,s]=e.split(":"),o={authors:[r],kinds:[parseInt(n)]};return s&&(o["#d"]=[s]),o}if(e.match(BECH32_REGEX))try{switch(t=nip19_exports.decode(e),t.type){case"nevent":{const r={ids:[t.data.id]};return t.data.author&&(r.authors=[t.data.author]),t.data.kind&&(r.kinds=[t.data.kind]),r}case"note":return{ids:[t.data]};case"naddr":const n={authors:[t.data.pubkey],kinds:[t.data.kind]};return t.data.identifier&&(n["#d"]=[t.data.identifier]),n}}catch(n){console.error("Error decoding",e,n)}return{ids:[e]}}function isNip33AValue(e){return e.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(e,t){try{const n=nip19_exports.decode(e);if(["naddr","nevent"].includes(n==null?void 0:n.type)){const r=n.data;if(r!=null&&r.relays)return r.relays.map(s=>new NDKRelay(s,t==null?void 0:t.relayAuthDefaultPolicy,t))}}catch{}return[]}var defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",groupable:!0,groupableDelay:100,groupableDelayType:"at-most"},NDKSubscription=class extends lib$1.EventEmitter{constructor(t,n,r,s,o){super();m(this,"subId");m(this,"filters");m(this,"opts");m(this,"pool");m(this,"skipVerification",!1);m(this,"skipValidation",!1);m(this,"relayFilters");m(this,"relaySet");m(this,"ndk");m(this,"debug");m(this,"eventFirstSeen",new Map);m(this,"eosesSeen",new Set);m(this,"lastEventReceivedAt");m(this,"internalId");m(this,"closeOnEose");m(this,"poolMonitor");m(this,"eoseTimeout");m(this,"eosed",!1);if(this.ndk=t,this.pool=(r==null?void 0:r.pool)||t.pool,this.opts={...defaultOpts,...r||{}},this.filters=n instanceof Array?n:[n],this.subId=o||(r==null?void 0:r.subId),this.internalId=Math.random().toString(36).substring(7),this.relaySet=s,this.debug=t.debug.extend(`subscription[${(r==null?void 0:r.subId)??this.internalId}]`),this.skipVerification=(r==null?void 0:r.skipVerification)||!1,this.skipValidation=(r==null?void 0:r.skipValidation)||!1,this.closeOnEose=(r==null?void 0:r.closeOnEose)||!1,this.opts.cacheUsage==="ONLY_CACHE"&&!this.opts.closeOnEose)throw new Error("Cannot use cache-only options with a persistent subscription")}relaysMissingEose(){return this.relayFilters?Array.from(this.relayFilters.keys()).filter(n=>!this.eosesSeen.has(this.pool.getRelay(n,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){var t;if(this.isGroupable())return(t=this.opts)==null?void 0:t.groupableDelay}get groupableDelayType(){var t;return((t=this.opts)==null?void 0:t.groupableDelayType)||"at-most"}isGroupable(){var t;return((t=this.opts)==null?void 0:t.groupable)||!1}shouldQueryCache(){var t;return((t=this.opts)==null?void 0:t.cacheUsage)!=="ONLY_RELAY"}shouldQueryRelays(){var t;return((t=this.opts)==null?void 0:t.cacheUsage)!=="ONLY_CACHE"}shouldWaitForCache(){var t;return this.opts.closeOnEose&&!!((t=this.ndk.cacheAdapter)!=null&&t.locking)&&this.opts.cacheUsage!=="PARALLEL"}async start(){let t;if(this.shouldQueryCache()&&(t=this.startWithCache(),this.shouldWaitForCache()&&(await t,queryFullyFilled(this)))){this.emit("eose",this);return}this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{var r,s;if((r=this.relayFilters)!=null&&r.has(t.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool).get(t.url)&&((s=this.relayFilters)==null||s.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}stop(){this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),this.removeAllListeners()}hasAuthorsFilter(){return this.filters.some(t=>{var n;return(n=t.authors)==null?void 0:n.length})}async startWithCache(){var t;if((t=this.ndk.cacheAdapter)!=null&&t.query){const n=this.ndk.cacheAdapter.query(this);this.ndk.cacheAdapter.locking&&await n}}startWithRelays(){if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool);else{this.relayFilters=new Map;for(const t of this.relaySet.relays)this.relayFilters.set(t.url,this.filters)}if(!(!this.relayFilters||this.relayFilters.size===0))for(const[t,n]of this.relayFilters)this.pool.getRelay(t,!0,!0,n).subscribe(this,n)}eventReceived(t,n,r=!1,s=!1){const o=t.id,a=this.eventFirstSeen.has(o);let c;if(t instanceof NDKEvent&&(c=t),a){const l=Date.now()-(this.eventFirstSeen.get(o)||0);if(this.emit("event:dup",o,n,l,this),n){const u=verifiedSignatures.get(o);u&&typeof u=="string"&&t.sig===u&&n.addValidatedEvent()}}else{if(c??(c=new NDKEvent(this.ndk,t)),c.ndk=this.ndk,c.relay=n,!r&&!s){if(!this.skipValidation&&!c.isValid){this.debug("Event failed validation %s from relay %s",o,n==null?void 0:n.url);return}if(n)if((n==null?void 0:n.shouldValidateEvent())!==!1){if(!this.skipVerification)if(!c.verifySignature(!0)&&!this.ndk.asyncSigVerification){this.debug("Event failed signature validation",t);return}else n&&n.addValidatedEvent()}else n.addNonValidatedEvent();this.ndk.cacheAdapter&&this.ndk.cacheAdapter.setEvent(c,this.filters,n)}!r&&n&&this.ndk.emit("event",c,n),this.emit("event",c,n,this),this.eventFirstSeen.set(o,Date.now())}this.lastEventReceivedAt=Date.now()}closedReceived(t,n){this.emit("closed",t,n)}eoseReceived(t){var a;this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const r=this.eosesSeen.size===((a=this.relayFilters)==null?void 0:a.size),s=queryFullyFilled(this),o=c=>{var l;this.debug("Performing EOSE: %s %d",c,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,(l=this.opts)!=null&&l.closeOnEose&&this.stop())};if(s||r)o("query filled or seen all");else if(this.relayFilters){let c=1e3;const l=new Set(this.pool.connectedRelays().map(h=>h.url)),u=Array.from(this.relayFilters.keys()).filter(h=>l.has(h));if(u.length===0)return;const f=this.eosesSeen.size/u.length;if(this.eosesSeen.size>=2&&f>=.5){if(c=c*(1-f),c===0){o("tiem to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const h=()=>{n=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,n!==void 0&&n<20?this.eoseTimeout=setTimeout(h,c):o("send eose timeout: "+c)};this.eoseTimeout=setTimeout(h,c)}}}};async function follows(e,t,n=3){var s,o;if(!this.ndk)throw new Error("NDK not set");const r=await this.ndk.fetchEvent({kinds:[n],authors:[this.pubkey]},e||{groupable:!1});if(r){const a=new Set;return r.tags.forEach(c=>{c[0]==="p"&&a.add(c[1])}),t&&((o=(s=this.ndk)==null?void 0:s.outboxTracker)==null||o.trackUsers(Array.from(a))),[...a].reduce((c,l)=>{const u=new NDKUser({pubkey:l});return u.ndk=this.ndk,c.add(u),c},new Set)}return new Set}function profileFromEvent(e){const t={};let n;try{n=JSON.parse(e.content)}catch(r){throw new Error(`Failed to parse profile event: ${r}`)}return t.created_at=e.created_at,t.profileEvent=JSON.stringify(e.rawEvent()),Object.keys(n).forEach(r=>{switch(r){case"name":t.name=n.name;break;case"display_name":t.displayName=n.display_name;break;case"image":case"picture":t.image=n.picture||n.image;break;case"banner":t.banner=n.banner;break;case"bio":t.bio=n.bio;break;case"nip05":t.nip05=n.nip05;break;case"lud06":t.lud06=n.lud06;break;case"lud16":t.lud16=n.lud16;break;case"about":t.about=n.about;break;case"zapService":t.zapService=n.zapService;break;case"website":t.website=n.website;break;default:t[r]=n[r];break}}),t}function serializeProfile(e){const t={};for(const[n,r]of Object.entries(e))switch(n){case"username":case"name":t.name=r;break;case"displayName":t.display_name=r;break;case"image":case"picture":t.picture=r;break;case"bio":case"about":t.about=r;break;default:t[n]=r;break}return JSON.stringify(t)}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(e,t,n=fetch,r={}){return await e.queuesNip05.add({id:t,func:async()=>{if(e.cacheAdapter&&e.cacheAdapter.loadNip05){const l=await e.cacheAdapter.loadNip05(t);if(l!=="missing"){if(l){const u=new NDKUser({pubkey:l.pubkey,relayUrls:l.relays,nip46Urls:l.nip46});return u.ndk=e,u}else if(r.cache!=="no-cache")return null}}const s=t.match(NIP05_REGEX);if(!s)return null;const[o,a="_",c]=s;try{const l=await n(`https://${c}/.well-known/nostr.json?name=${a}`,r),{names:u,relays:f,nip46:h}=parseNIP05Result(await l.json()),p=u[a.toLowerCase()];let b=null;return p&&(b={pubkey:p,relays:f==null?void 0:f[p],nip46:h==null?void 0:h[p]}),e!=null&&e.cacheAdapter&&e.cacheAdapter.saveNip05&&e.cacheAdapter.saveNip05(t,b),b}catch(l){return e!=null&&e.cacheAdapter&&e.cacheAdapter.saveNip05&&(e==null||e.cacheAdapter.saveNip05(t,null)),console.error("Failed to fetch NIP05 for",t,l),null}}})}function parseNIP05Result(e){const t={names:{}};for(const[n,r]of Object.entries(e.names))typeof n=="string"&&typeof r=="string"&&(t.names[n.toLowerCase()]=r);if(e.relays){t.relays={};for(const[n,r]of Object.entries(e.relays))typeof n=="string"&&Array.isArray(r)&&(t.relays[n]=r.filter(s=>typeof s=="string"))}if(e.nip46){t.nip46={};for(const[n,r]of Object.entries(e.nip46))typeof n=="string"&&Array.isArray(r)&&(t.nip46[n]=r.filter(s=>typeof s=="string"))}return t}var te,NDKCashuMintList=(te=class extends NDKEvent{constructor(n,r){super(n,r);m(this,"_p2pk");this.kind??(this.kind=10019)}static from(n){return new te(n.ndk,n)}set relays(n){this.tags=this.tags.filter(r=>r[0]!=="relay");for(const r of n)this.tags.push(["relay",r])}get relays(){const n=[];for(const r of this.tags)r[0]==="relay"&&n.push(r[1]);return n}set mints(n){this.tags=this.tags.filter(r=>r[0]!=="mint");for(const r of n)this.tags.push(["mint",r])}get mints(){const n=[];for(const r of this.tags)r[0]==="mint"&&n.push(r[1]);return Array.from(new Set(n))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(n){this._p2pk=n,this.removeTag("pubkey"),n&&this.tags.push(["pubkey",n])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}},m(te,"kind",10019),m(te,"kinds",[10019]),te),d2=debug7("ndk:zapper:ln");async function getNip57ZapSpecFromLud({lud06:e,lud16:t},n){let r;if(t&&!t.startsWith("LNURL")){const[s,o]=t.split("@");r=`https://${o}/.well-known/lnurlp/${s}`}else if(e){const{words:s}=bech32.decode(e,1e3),o=bech32.fromWords(s);r=new TextDecoder("utf-8").decode(o)}if(!r)throw d2("No zap endpoint found %o",{lud06:e,lud16:t}),new Error("No zap endpoint found");try{const o=await(n.httpFetch||fetch)(r);if(o.status!==200){const a=await o.text();throw new Error(`Unable to fetch zap endpoint ${r}: ${a}`)}return await o.json()}catch(s){throw new Error(`Unable to fetch zap endpoint ${r}: ${s}`)}}var NDKUser=class ce{constructor(t){m(this,"ndk");m(this,"profile");m(this,"_npub");m(this,"_pubkey");m(this,"relayUrls",[]);m(this,"nip46Urls",[]);m(this,"follows",follows.bind(this));t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls)}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports.npubEncode(this.pubkey)}return this._npub}set npub(t){this._npub=t}get hexpubkey(){return this.pubkey}set hexpubkey(t){this._pubkey=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}async getZapInfo(t=!0,n=["nip61","nip57"]){if(!this.ndk)throw new Error("No NDK instance found");const r=[];if(n.includes("nip61")&&r.push(10019),n.includes("nip57")&&r.push(0),r.length===0)return[];let s=await this.ndk.fetchEvents({kinds:r,authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",groupable:!1});s.size<n.length&&(s=await this.ndk.fetchEvents({kinds:r,authors:[this.pubkey]},{cacheUsage:"ONLY_RELAY"}));const o=[],a=Array.from(s).find(l=>l.kind===10019),c=Array.from(s).find(l=>l.kind===0);if(a){const l=NDKCashuMintList.from(a);if(l.mints.length>0&&o.push({type:"nip61",data:{mints:l.mints,relays:l.relays,p2pk:l.p2pk}}),!t)return o}if(c){const l=profileFromEvent(c),{lud06:u,lud16:f}=l;try{const h=await getNip57ZapSpecFromLud({lud06:u,lud16:f},this.ndk);h&&o.push({type:"nip57",data:h})}catch(h){console.error("Error getting NIP-57 zap spec",h)}}return o}async getZapConfiguration(t){if(t??(t=this.ndk),!t)throw new Error("No NDK instance found");const n=async()=>{var s,o,a,c;if((o=(s=this.ndk)==null?void 0:s.cacheAdapter)!=null&&o.loadUsersLNURLDoc){const l=await this.ndk.cacheAdapter.loadUsersLNURLDoc(this.pubkey);if(l!=="missing"){if(l===null)return;if(l)return l}}let r;try{if(await this.fetchProfile({groupable:!1}),this.profile){const{lud06:l,lud16:u}=this.profile;r=await getNip57ZapSpecFromLud({lud06:l,lud16:u},t)}}catch{}if((c=(a=this.ndk)==null?void 0:a.cacheAdapter)!=null&&c.saveUsersLNURLDoc&&this.ndk.cacheAdapter.saveUsersLNURLDoc(this.pubkey,r||null),!!r)return r};return await t.queuesZapConfig.add({id:this.pubkey,func:n})}async getZapperPubkey(){const t=await this.getZapConfiguration();return t==null?void 0:t.nostrPubkey}static async fromNip05(t,n,r=!1){if(!n)throw new Error("No NDK instance found");const s={};r&&(s.cache="no-cache");const o=await getNip05For(n,t,n==null?void 0:n.httpFetch,s);if(o){const a=new ce({pubkey:o.pubkey,relayUrls:o.relays,nip46Urls:o.nip46});return a.ndk=n,a}}async fetchProfile(t,n=!1){if(!this.ndk)throw new Error("NDK not set");this.profile||(this.profile={});let r=null;if(this.ndk.cacheAdapter&&this.ndk.cacheAdapter.fetchProfile&&(t==null?void 0:t.cacheUsage)!=="ONLY_RELAY"){const a=await this.ndk.cacheAdapter.fetchProfile(this.pubkey);if(a)return this.profile=a,a}!t&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.locking&&(r=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},{cacheUsage:"ONLY_CACHE",closeOnEose:!0,groupable:!1}),t={cacheUsage:"ONLY_RELAY",closeOnEose:!0,groupable:!0,groupableDelay:250}),(!r||r.size===0)&&(r=await this.ndk.fetchEvents({kinds:[0],authors:[this.pubkey]},t));const s=Array.from(r).sort((a,c)=>a.created_at-c.created_at);if(s.length===0)return null;const o=s[0];return this.profile=profileFromEvent(o),n&&(this.profile.profileEvent=JSON.stringify(o)),this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile}tagReference(){return["p",this.pubkey]}referenceTags(t){const n=[["p",this.pubkey]];return t&&n[0].push("",t),n}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(t,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r)),n.has(t))return!1;n.add(t);const s=new NDKEvent(this.ndk,{kind:r});for(const o of n)s.tag(o);return await s.publish(),!0}async unfollow(t,n,r=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),n||(n=await this.follows(void 0,void 0,r));const s=new Set;let o=!1;for(const c of n)c.pubkey!==t.pubkey?s.add(c):o=!0;if(!o)return!1;const a=new NDKEvent(this.ndk,{kind:r});for(const c of s)a.tag(c);return await a.publish()}async validateNip05(t){if(!this.ndk)throw new Error("No NDK instance found");const n=await getNip05For(this.ndk,t);return n===null?null:n.pubkey===this.pubkey}async zap(t,n,r,s){return new Promise((o,a)=>{var u;if(!this.ndk){a("No NDK instance found");return}let c=(u=this.ndk.walletConfig)==null?void 0:u.onLnPay;c??(c=async({pr:f})=>{o(f)}),this.ndk.zap(this,t,{comment:n,tags:r,signer:s,onLnPay:c}).zap().then(o).catch(a)})}},NDKList=class le extends NDKEvent{constructor(n,r){super(n,r);m(this,"_encryptedTags");m(this,"encryptedTagsLength");this.kind??(this.kind=30001)}static from(n){return new le(n.ndk,n)}get title(){const n=this.tagValue("title")||this.tagValue("name");return n||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(n){this.removeTag(["title","name"]),n&&this.tags.push(["title",n])}get name(){return this.title}set name(n){this.title=n}get description(){return this.tagValue("description")}set description(n){this.removeTag("description"),n&&this.tags.push(["description",n])}get image(){return this.tagValue("image")}set image(n){this.removeTag("image"),n&&this.tags.push(["image",n])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(n=!0){if(n&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const r=await this.ndk.signer.user();try{if(this.content.length>0)try{const s=await this.ndk.signer.decrypt(r,this.content),o=JSON.parse(s);return o&&o[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=o):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{console.log(`error decrypting ${this.content}`)}}catch{}return[]}validateTag(n){return!0}getItems(n){return this.tags.filter(r=>r[0]===n)}get items(){return this.tags.filter(n=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(n[0]))}async addItem(n,r=void 0,s=!1,o="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let a;if(n instanceof NDKEvent)a=[n.tagReference(r)];else if(n instanceof NDKUser)a=n.referenceTags();else if(n instanceof NDKRelay)a=n.referenceTags();else if(Array.isArray(n))a=[n];else throw new Error("Invalid object type");if(r&&a[0].push(r),s){const c=await this.ndk.signer.user(),l=await this.encryptedTags();o==="top"?l.unshift(...a):l.push(...a),this._encryptedTags=l,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(l),await this.encrypt(c)}else o==="top"?this.tags.unshift(...a):this.tags.push(...a);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(n,r=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=this.tags.findIndex(l=>l[1]===n);s>=0&&this.tags.splice(s,1);const o=await this.ndk.signer.user(),a=await this.encryptedTags(),c=a.findIndex(l=>l[1]===n);if(c>=0&&(a.splice(c,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(o)),r)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(n,r){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(r){const s=await this.ndk.signer.user(),o=await this.encryptedTags();o.splice(n,1),this._encryptedTags=o,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(o),await this.encrypt(s)}else this.tags.splice(n,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(n){return this.items.some(r=>r[1]===n)}filterForItems(){const n=new Set,r=new Map,s=[];for(const o of this.items)if(o[0]==="e"&&o[1])n.add(o[1]);else if(o[0]==="a"&&o[1]){const[a,c,l]=o[1].split(":");if(!a||!c)continue;const u=`${a}:${c}`,f=r.get(u)||[];f.push(l||""),r.set(u,f)}if(n.size>0&&s.push({ids:Array.from(n)}),r.size>0)for(const[o,a]of r.entries()){const[c,l]=o.split(":");s.push({kinds:[parseInt(c)],authors:[l],"#d":a})}return s}},lists_default=NDKList,READ_MARKER="read",WRITE_MARKER="write",NDKRelayList=class ue extends NDKEvent{constructor(t,n){super(t,n),this.kind??(this.kind=10002)}static from(t){return new ue(t.ndk,t.rawEvent())}get readRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===READ_MARKER).map(t=>tryNormalizeRelayUrl(t[1])).filter(t=>!!t)}set readRelayUrls(t){for(const n of t)this.tags.push(["r",n,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===WRITE_MARKER).map(t=>tryNormalizeRelayUrl(t[1])).filter(t=>!!t)}set writeRelayUrls(t){for(const n of t)this.tags.push(["r",n,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]).map(t=>t[1])}set bothRelayUrls(t){for(const n of t)this.tags.push(["r",n])}get relays(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").map(t=>t[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet(new Set(this.relays.map(t=>this.ndk.pool.getRelay(t))),this.ndk)}};function relayListFromKind3(e,t){try{const n=JSON.parse(t.content),r=new NDKRelayList(e),s=new Set,o=new Set;for(let[a,c]of Object.entries(n)){try{a=normalizeRelayUrl(a)}catch{continue}if(!c)s.add(a),o.add(a);else{const l=c;l.write&&o.add(a),l.read&&s.add(a)}}return r.readRelayUrls=Array.from(s),r.writeRelayUrls=Array.from(o),r}catch{}}var NDKRepost=class he extends NDKEvent{constructor(n,r){super(n,r);m(this,"_repostedEvents")}static from(n){return new he(n.ndk,n.rawEvent())}async repostedEvents(n,r){const s=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const o of this.repostedEventIds()){const a=filterForId(o),c=await this.ndk.fetchEvent(a,r);c&&s.push(n?n.from(c):c)}return s}repostedEventIds(){return this.tags.filter(n=>n[0]==="e"||n[0]==="a").map(n=>n[1])}};function filterForId(e){if(e.match(/:/)){const[t,n,r]=e.split(":");return{kinds:[parseInt(t)],authors:[n],"#d":[r]}}else return{ids:[e]}}var ne,NDKNutzap=(ne=class extends NDKEvent{constructor(n,r){super(n,r);m(this,"debug");m(this,"_proofs",[]);m(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(n==null?void 0:n.debug.extend("nutzap"))??debug7("ndk:nutzap"),this.alt||(this.alt="This is a nutzap")}static from(n){const r=new this(n.ndk,n);try{const s=r.getMatchingTags("proof");s.length?r._proofs=s.map(o=>JSON.parse(o[1])):r._proofs=JSON.parse(r.content)}catch{return}if(!(!r._proofs||!r._proofs.length))return r}set comment(n){this.content=n??""}get comment(){const n=this.tagValue("comment");return n||this.content}set proofs(n){this._proofs=n,this.tags=this.tags.filter(r=>r[0]!=="proof");for(const r of n)this.tags.push(["proof",JSON.stringify(r)]);this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()])}get proofs(){return this._proofs}get p2pk(){var r;const n=this.proofs[0];try{const s=JSON.parse(n.secret);let o={};if(typeof s=="string"?(o=JSON.parse(s),this.debug("stringified payload",n.secret)):typeof s=="object"&&(o=s),o[0]==="P2PK"&&((r=o[1])==null?void 0:r.data)){const l=o[1].data.slice(2,-1);if(l)return l}}catch(s){this.debug("error parsing p2pk pubkey",s,this.proofs[0])}}get mint(){return this.tagValue("u")}set mint(n){this.removeTag("u"),this.tag(["u",n])}get unit(){return this.tagValue("unit")??"msat"}set unit(n){this.removeTag("unit"),n&&this.tag(["unit",n])}get amount(){return this.proofs.reduce((r,s)=>r+s.amount,0)*1e3}set target(n){this.tags=this.tags.filter(r=>r[0]!=="p"),n instanceof NDKEvent&&this.tags.push()}set recipientPubkey(n){this.removeTag("p"),this.tag(["p",n])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const n=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:n}):new NDKUser({pubkey:n})}get isValid(){let n=0,r=0;for(const s of this.tags)s[0]==="p"&&n++,s[0]==="u"&&r++;return n===1&&r===1&&this.proofs.length>0}},m(ne,"kind",9321),m(ne,"kinds",[ne.kind]),ne);async function payInvoice(e){return await this.sendReq("pay_invoice",{invoice:e})}var NDKPrivateKeySigner=class de{constructor(t){m(this,"_user");m(this,"_privateKey");if(t){if(typeof t=="string")if(t.startsWith("nsec1")){const{type:n,data:r}=nip19_exports.decode(t);n==="nsec"&&(this._privateKey=r)}else if(t.length===64)this._privateKey=hexToBytes$1(t);else throw new Error("Invalid private key provided.");else this._privateKey=t;this._privateKey&&(this._user=new NDKUser({pubkey:getPublicKey(this._privateKey)}))}}get privateKey(){if(this._privateKey)return bytesToHex$1(this._privateKey)}static generate(){const t=generateSecretKey();return new de(t)}async blockUntilReady(){if(!this._user)throw new Error("NDKUser not initialized");return this._user}async user(){return await this.blockUntilReady(),this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(t,this._privateKey).sig}getConversationKey(t){if(!this._privateKey)throw Error("Attempted to get conversation key without a private key");const n=t.pubkey;return nip44_exports.getConversationKey(this._privateKey,n)}async nip44Encrypt(t,n){const r=this.getConversationKey(t);return await nip44_exports.encrypt(n,r)}async nip44Decrypt(t,n){const r=this.getConversationKey(t);return await nip44_exports.decrypt(n,r)}async encrypt(t,n,r=DEFAULT_ENCRYPTION_SCHEME){return r==="nip44"?this.nip44Encrypt(t,n):this.nip04Encrypt(t,n)}async decrypt(t,n,r=DEFAULT_ENCRYPTION_SCHEME){return r==="nip44"?this.nip44Decrypt(t,n):this.nip04Decrypt(t,n)}async nip04Encrypt(t,n){if(!this._privateKey)throw Error("Attempted to encrypt without a private key");const r=t.pubkey;return await nip04_exports.encrypt(this._privateKey,r,n)}async nip04Decrypt(t,n){if(!this._privateKey)throw Error("Attempted to decrypt without a private key");const r=t.pubkey;return await nip04_exports.decrypt(this._privateKey,r,n)}};async function sendReq(e,t){const n=new NDKEvent(this.ndk,{kind:23194,tags:[["p",this.walletService.pubkey]],content:JSON.stringify({method:e,params:t})});return this.debug("Sending request",n.content),await n.encrypt(this.walletService,this.signer),await n.sign(this.signer),this.debug("Request encrypted and signed"),new Promise(async(r,s)=>{try{const o=n.tagId();if(!o)throw new Error("Failed to get e-tag");const a=l=>{this.off(o,a),this.off("event",a),this.debug("Received response",l);try{const u=JSON.parse(l);u.error&&s(u),r(u)}catch(u){this.debug("Failed to parse response",u),s({result_type:"error",error:{code:"failed_to_parse_response",message:u.message}})}},c=this.ndk.subscribe({kinds:[23195],"#e":[o],limit:1},{groupable:!1,subId:`nwc-${e}`},this.relaySet);c.on("event",async l=>{await l.decrypt(l.author,this.signer),a(l.content),c.stop()}),this.once(o,a),this.once("event",a),this.debug("Sending request to relay",n.rawEvent()),await n.publish(this.relaySet)}catch(o){this.debug("Failed to send request",o,o.relayErrors),s({result_type:"error",error:{code:"failed_to_send_request",message:o.message}})}})}async function getBalance(){return await this.sendReq("get_balance",{})}async function getInfo(){return await this.sendReq("get_info",{})}var NDKNwc=class pe extends lib$1.EventEmitter{constructor({ndk:n,pubkey:r,relayUrls:s,secret:o}){super();m(this,"ndk");m(this,"debug");m(this,"walletService");m(this,"relaySet");m(this,"signer");m(this,"active",!1);m(this,"getBalance",getBalance.bind(this));this.ndk=n,this.walletService=n.getUser({pubkey:r}),this.relaySet=new NDKRelaySet(new Set(s.map(a=>n.pool.getRelay(a))),n),this.signer=new NDKPrivateKeySigner(o instanceof Uint8Array?o:hexToBytes$1(o)),this.debug=n.debug.extend("nwc"),this.debug(`Starting with wallet service ${this.walletService.npub}`)}static async fromURI(n,r){const s=new URL(r);if(s.protocol!=="nostr+walletconnect:")throw new Error("Invalid protocol");return new pe({ndk:n,pubkey:s.host??s.pathname,relayUrls:s.searchParams.getAll("relay")??[""],secret:s.searchParams.get("secret")??""})}async blockUntilReady(n){const r=await this.signer.user(),s=new Promise((c,l)=>{setTimeout(()=>{l(new Error("Timeout"))},n)}),a=[new Promise(c=>{const l=this.ndk.subscribe({kinds:[23195],"#p":[r.pubkey],limit:1},{groupable:!1,subId:"nwc"},this.relaySet);l.on("event",async u=>{this.debug("received response",u.rawEvent());const f=u.tagValue("e");if(!f){this.debug("Received an event without an e-tag");return}this.debug("received an event",f);try{await u.decrypt(u.author,this.signer),this.emit(f,u.content)}catch(h){this.debug("Failed to decrypt event",h);return}}),l.on("eose",()=>{this.debug("Subscription ready"),this.active=!0,c()}),l.on("close",()=>{this.debug("Subscription closed"),this.active=!1})})];return n&&a.push(s),await Promise.race(a)}async sendReq(n,r){return await sendReq.call(this,n,r)}async payInvoice(n){return await payInvoice.call(this,n)}async getInfo(){return await getInfo.call(this)}},NDKNip07Signer=class{constructor(e=1e3){m(this,"_userPromise");m(this,"nip04Queue",[]);m(this,"nip04Processing",!1);m(this,"debug");m(this,"waitTimeout");this.debug=debug7("ndk:nip07"),this.waitTimeout=e}async blockUntilReady(){await this.waitForExtension();const e=await window.nostr.getPublicKey();if(!e)throw new Error("User rejected access");return new NDKUser({pubkey:e})}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}async sign(e){return await this.waitForExtension(),(await window.nostr.signEvent(e)).sig}async relays(e){var r,s;await this.waitForExtension();const t=await((s=(r=window.nostr).getRelays)==null?void 0:s.call(r))||{},n=[];for(const o of Object.keys(t))t[o].read&&t[o].write&&n.push(o);return n.map(o=>new NDKRelay(o,e==null?void 0:e.relayAuthDefaultPolicy,e))}async encrypt(e,t,n=DEFAULT_ENCRYPTION_SCHEME){return n==="nip44"?this.nip44Encrypt(e,t):this.nip04Encrypt(e,t)}async decrypt(e,t,n=DEFAULT_ENCRYPTION_SCHEME){return n==="nip44"?this.nip44Decrypt(e,t):this.nip04Decrypt(e,t)}async nip44Encrypt(e,t){return await this.waitForExtension(),await window.nostr.nip44.encrypt(e.pubkey,t)}async nip44Decrypt(e,t){return await this.waitForExtension(),await window.nostr.nip44.decrypt(e.pubkey,t)}async nip04Encrypt(e,t){await this.waitForExtension();const n=e.pubkey;return this.queueNip04("encrypt",n,t)}async nip04Decrypt(e,t){await this.waitForExtension();const n=e.pubkey;return this.queueNip04("decrypt",n,t)}async queueNip04(e,t,n){return new Promise((r,s)=>{this.nip04Queue.push({type:e,counterpartyHexpubkey:t,value:n,resolve:r,reject:s}),this.nip04Processing||this.processNip04Queue()})}async processNip04Queue(e,t=0){if(!e&&this.nip04Queue.length===0){this.nip04Processing=!1;return}this.nip04Processing=!0;const{type:n,counterpartyHexpubkey:r,value:s,resolve:o,reject:a}=e||this.nip04Queue.shift();try{let c;n==="encrypt"?c=await window.nostr.nip04.encrypt(r,s):c=await window.nostr.nip04.decrypt(r,s),o(c)}catch(c){if(c.message&&c.message.includes("call already executing")&&t<5){this.debug("Retrying encryption queue item",{type:n,counterpartyHexpubkey:r,value:s,retries:t}),setTimeout(()=>{this.processNip04Queue(e,t+1)},50*t);return}a(c)}this.processNip04Queue()}waitForExtension(){return new Promise((e,t)=>{if(window.nostr){e();return}let n;const r=setInterval(()=>{window.nostr&&(clearTimeout(n),clearInterval(r),e())},100);n=setTimeout(()=>{clearInterval(r),t(new Error("NIP-07 extension not available"))},this.waitTimeout)})}};function dedup(e,t){return e.created_at>t.created_at?e:t}async function getRelayListForUser(e,t){return(await getRelayListForUsers([e],t)).get(e)}async function getRelayListForUsers(e,t,n=!1){var f;const r=t.outboxPool||t.pool,s=new Set;for(const h of r.relays.values())s.add(h);const o=new Map,a=new Map,c=new NDKRelaySet(s,t);if((f=t.cacheAdapter)!=null&&f.locking&&!n){const h=await t.fetchEvents({kinds:[3,10002],authors:e},{cacheUsage:"ONLY_CACHE"});for(const p of h)p.kind===10002&&o.set(p.pubkey,NDKRelayList.from(p));for(const p of h)if(p.kind===3){if(o.has(p.pubkey))continue;const b=relayListFromKind3(t,p);b&&a.set(p.pubkey,b)}e=e.filter(p=>!o.has(p)&&!a.has(p))}if(e.length===0)return o;const l=new Map,u=new Map;return new Promise(async h=>{const p=t.subscribe({kinds:[3,10002],authors:e},{closeOnEose:!0,pool:r,groupable:!0,cacheUsage:"ONLY_RELAY",subId:"ndk-relay-list-fetch"},c,!1);p.on("event",b=>{if(b.kind===10002){const _=l.get(b.pubkey);if(_&&_.created_at>b.created_at)return;l.set(b.pubkey,b)}else if(b.kind===3){const _=u.get(b.pubkey);if(_&&_.created_at>b.created_at)return;u.set(b.pubkey,b)}}),p.on("eose",()=>{for(const b of l.values())o.set(b.pubkey,NDKRelayList.from(b));for(const b of e){if(o.has(b))continue;const _=u.get(b);if(!_)continue;const g=relayListFromKind3(t,_);g&&o.set(b,g)}h(o)}),p.start()})}var OutboxItem=class{constructor(e){m(this,"type");m(this,"relayUrlScores");m(this,"readRelays");m(this,"writeRelays");this.type=e,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends lib$1.EventEmitter{constructor(t){super();m(this,"data");m(this,"ndk");m(this,"debug");this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new dist.LRUCache({maxSize:1e5,entryExpirationTimeInMS:2*60*1e3})}async trackUsers(t,n=!1){const r=[];for(let s=0;s<t.length;s+=400){const a=t.slice(s,s+400).map(c=>getKeyFromItem(c)).filter(c=>!this.data.has(c));if(a.length!==0){for(const c of a)this.data.set(c,new OutboxItem("user"));r.push(new Promise(c=>{getRelayListForUsers(a,this.ndk,n).then(l=>{for(const[u,f]of l){let h=this.data.get(u);if(h??(h=new OutboxItem("user")),f){h.readRelays=new Set(normalize(f.readRelayUrls)),h.writeRelays=new Set(normalize(f.writeRelayUrls));for(const p of h.readRelays)this.ndk.pool.blacklistRelayUrls.has(p)&&h.readRelays.delete(p);for(const p of h.writeRelays)this.ndk.pool.blacklistRelayUrls.has(p)&&h.writeRelays.delete(p);this.data.set(u,h)}}}).finally(c)}))}}return Promise.all(r)}track(t,n,r=!0){const s=getKeyFromItem(t);n??(n=getTypeFromItem(t));let o=this.data.get(s);return o||(o=new OutboxItem(n),t instanceof NDKUser&&this.trackUsers([t])),o}};function getKeyFromItem(e){return e instanceof NDKUser?e.pubkey:e}function getTypeFromItem(e){return e instanceof NDKUser?"user":"kind"}var NDKPool=class extends lib$1.EventEmitter{constructor(t=[],n=[],r,s){super();m(this,"_relays",new Map);m(this,"autoConnectRelays",new Set);m(this,"blacklistRelayUrls");m(this,"debug");m(this,"temporaryRelayTimers",new Map);m(this,"flappingRelays",new Set);m(this,"backoffTimes",new Map);m(this,"ndk");this.debug=s??r.debug.extend("pool"),this.ndk=r,this.relayUrls=t,this.blacklistRelayUrls=new Set(n)}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const n of t){const r=new NDKRelay(n,void 0,this.ndk);this.addRelay(r,!1)}}set name(t){this.debug=this.debug.extend(t)}useTemporaryRelay(t,n=3e4,r){const s=this.relays.has(t.url);s||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,r));const o=this.temporaryRelayTimers.get(t.url);if(o&&clearTimeout(o),!s||o){const a=setTimeout(()=>{var c;(c=this.ndk.explicitRelayUrls)!=null&&c.includes(t.url)||this.removeRelay(t.url)},n);this.temporaryRelayTimers.set(t.url,a)}}addRelay(t,n=!0){var g,y;const r=this.relays.has(t.url),s=(g=this.blacklistRelayUrls)==null?void 0:g.has(t.url),o=t.url.includes("/npub1");let a=!0;const c=t.url;if(r)return;if(s){this.debug(`Refusing to add relay ${c}: blacklisted`);return}if(o){this.debug(`Refusing to add relay ${c}: is a filter relay`);return}if((y=this.ndk.cacheAdapter)!=null&&y.getRelayStatus){const w=this.ndk.cacheAdapter.getRelayStatus(c);if(w&&w.dontConnectBefore)if(w.dontConnectBefore>Date.now()){const R=w.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${c}: delayed connect for ${R}ms`),setTimeout(()=>{this.addRelay(t,n)},R);return}else a=!1}const l=w=>this.emit("notice",t,w),u=()=>this.handleRelayConnect(c),f=()=>this.handleRelayReady(t),h=()=>this.emit("relay:disconnect",t),p=()=>this.handleFlapping(t),b=w=>this.emit("relay:auth",t,w),_=()=>this.emit("relay:authed",t);t.off("notice",l),t.off("connect",u),t.off("ready",f),t.off("disconnect",h),t.off("flapping",p),t.off("auth",b),t.off("authed",_),t.on("notice",l),t.on("connect",u),t.on("ready",f),t.on("disconnect",h),t.on("flapping",p),t.on("auth",b),t.on("authed",_),t.on("delayed-connect",w=>{var R;(R=this.ndk.cacheAdapter)!=null&&R.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+w})}),this.relays.set(c,t),n&&this.autoConnectRelays.add(c),n&&(this.emit("relay:connecting",t),t.connect(void 0,a).catch(w=>{this.debug(`Failed to connect to relay ${c}`,w)}))}removeRelay(t){const n=this.relays.get(t);if(n)return n.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",n),!0;const r=this.temporaryRelayTimers.get(t);return r&&(clearTimeout(r),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const n=normalizeRelayUrl(t),r=this.relays.get(n);return r?r.status===5:!1}getRelay(t,n=!0,r=!1,s){let o=this.relays.get(normalizeRelayUrl(t));return o||(o=new NDKRelay(t,void 0,this.ndk),r?this.useTemporaryRelay(o,3e4,s):this.addRelay(o,n)),o}handleRelayConnect(t){this.emit("relay:connect",this.relays.get(t)),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){var s;const n=[];this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}...`:""}`);const r=new Set(this.autoConnectRelays.keys());(s=this.ndk.explicitRelayUrls)==null||s.forEach(o=>{const a=normalizeRelayUrl(o);r.add(a)});for(const o of r){const a=this.relays.get(o);if(!a)continue;const c=new Promise((l,u)=>(this.emit("relay:connecting",a),a.connect(t).then(l).catch(u)));if(t){const l=new Promise((u,f)=>{setTimeout(()=>f(`Timed out after ${t}ms`),t)});n.push(Promise.race([c,l]).catch(u=>{this.debug(`Failed to connect to relay ${a.url}: ${u??"No reason specified"}`)}))}else n.push(c)}t&&setTimeout(()=>{const o=this.stats().connected===this.relays.size,a=this.stats().connected>0;!o&&a&&this.emit("connect")},t),await Promise.all(n)}checkOnFlappingRelays(){const t=this.flappingRelays.size,n=this.relays.size;if(t/n>=.8)for(const r of this.flappingRelays)this.backoffTimes.set(r,0)}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let n=this.backoffTimes.get(t.url)||5e3;n=n*2,this.backoffTimes.set(t.url,n),this.debug(`Backoff time for ${t.url} is ${n}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},n),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const n of this.relays.values())t.total++,n.status===5?t.connected++:n.status===1?t.disconnected++:n.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status===5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}};function correctRelaySet(e,t){const n=t.connectedRelays();if(!Array.from(e.relays).some(s=>n.map(o=>o.url).includes(s.url)))for(const s of n)e.addRelay(s);if(n.length===0)for(const s of t.relays.values())e.addRelay(s);return e}function isValidHint(e){if(!e||e==="")return!1;try{return new URL(e),!0}catch{return!1}}async function fetchEventFromTag(e,t,n,r={type:"timeout"}){const s=this.debug.extend("fetch-event-from-tag"),[o,a,c]=e;n={},s("fetching event from tag",e,n,r);const l=getRelaysForSync(this,t.pubkey);if(l&&l.size>0){s("fetching event from author relays %o",Array.from(l));const g=NDKRelaySet.fromRelayUrls(Array.from(l),this),y=await this.fetchEvent(a,n,g);if(y)return y}else s("no author relays found for %s",t.pubkey,t);const u=calculateRelaySetsFromFilters(this,[{ids:[a]}],this.pool);s("fetching event without relay hint",u);const f=await this.fetchEvent(a,n);if(f)return f;if(c&&c!==""){const g=await this.fetchEvent(a,n,this.pool.getRelay(c,!0,!0,[{ids:[a]}]));if(g)return g}let h;const p=isValidHint(c)?this.pool.getRelay(c,!1,!0,[{ids:[a]}]):void 0,b=new Promise(g=>{this.fetchEvent(a,n,p).then(g)});if(!isValidHint(c)||r.type==="none")return b;const _=new Promise(async g=>{const y=r.relaySet,w=r.timeout??1500,R=new Promise(S=>setTimeout(S,w));if(r.type==="timeout"&&await R,h)g(h);else{s("fallback fetch triggered");const S=await this.fetchEvent(a,n,y);g(S)}});switch(r.type){case"timeout":return Promise.race([b,_]);case"eose":return h=await b,h||_}}var SPEC_PATH="/.well-known/nostr/nip96.json",Nip96=class{constructor(e,t){m(this,"ndk");m(this,"spec");m(this,"url");m(this,"nip98Required",!1);this.url=`https://${e}${SPEC_PATH}`,this.ndk=t}async prepareUpload(e,t="POST"){if(this.validateHttpFetch(),this.spec||await this.fetchSpec(),!this.spec)throw new Error("Failed to fetch NIP96 spec");let n={};return this.nip98Required&&(n={Authorization:await this.generateNip98Header(this.spec.api_url,t,e)}),{url:this.spec.api_url,headers:n}}async xhrUpload(e,t){const n="POST",{url:r,headers:s}=await this.prepareUpload(t,n);e.open(n,r,!0),s.Authorization&&e.setRequestHeader("Authorization",s.Authorization);const o=new FormData;return o.append("file",t),new Promise((a,c)=>{e.onload=function(){e.status>=200&&e.status<300?a(JSON.parse(e.responseText)):c(new Error(e.statusText))},e.onerror=function(){c(new Error("Network Error"))},e.send(o)})}async upload(e){const t="POST",{url:n,headers:r}=await this.prepareUpload(e,t),s=new FormData;s.append("file",e);const o=await this.ndk.httpFetch(this.spec.api_url,{method:t,headers:r,body:s});if(o.status!==200)throw new Error(`Failed to upload file to ${n}`);const a=await o.json();if(a.status!=="success")throw new Error(a.message);return a}validateHttpFetch(){if(!this.ndk)throw new Error("NDK is required to fetch NIP96 spec");if(!this.ndk.httpFetch)throw new Error("NDK must have an httpFetch method to fetch NIP96 spec")}async fetchSpec(){this.validateHttpFetch();const e=await this.ndk.httpFetch(this.url);if(e.status!==200)throw new Error(`Failed to fetch NIP96 spec from ${this.url}`);const t=await e.json();if(!t)throw new Error(`Failed to parse NIP96 spec from ${this.url}`);this.spec=t,this.nip98Required=this.spec.plans.free.is_nip98_required}async generateNip98Header(e,t,n){const r=new NDKEvent(this.ndk,{kind:27235,tags:[["u",e],["method",t]]});if(["POST","PUT","PATCH"].includes(t)){const o=await this.calculateSha256(n);r.tags.push(["payload",o])}return await r.sign(),`Nostr ${btoa(JSON.stringify(r.rawEvent()))}`}async calculateSha256(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(o=>o.toString(16).padStart(2,"0")).join("")}},Queue=class{constructor(e,t){m(this,"queue",[]);m(this,"maxConcurrency");m(this,"processing",new Set);m(this,"promises",new Map);this.maxConcurrency=t}add(e){if(this.promises.has(e.id))return this.promises.get(e.id);const t=new Promise((n,r)=>{this.queue.push({...e,func:()=>e.func().then(s=>(n(s),s),s=>{throw r(s),s})}),this.process()});return this.promises.set(e.id,t),t.finally(()=>{this.promises.delete(e.id),this.processing.delete(e.id),this.process()}),t}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const e=this.queue.shift();!e||this.processing.has(e.id)||(this.processing.add(e.id),e.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},NDKSubscriptionManager=class{constructor(e){m(this,"subscriptions");m(this,"seenEvents",new Map);m(this,"debug");this.subscriptions=new Map,this.debug=e.extend("sub-manager")}add(e){this.subscriptions.set(e.internalId,e),e.on("close",()=>{this.subscriptions.delete(e.internalId)})}seenEvent(e,t){const n=this.seenEvents.get(e)||[];n.push(t),this.seenEvents.set(e,n)}},debug6=debug7("ndk:active-user");async function getUserRelayList(e){if(!this.autoConnectUserRelays)return;const t=await getRelayListForUser(e.pubkey,this);if(t){for(const n of t.relays){let r=this.pool.relays.get(n);r||(r=new NDKRelay(n,this.relayAuthDefaultPolicy,this),this.pool.addRelay(r))}return t}}async function setActiveUser(e){const t=this.outboxPool||this.pool;t.connectedRelays.length>0?setActiveUserConnected.call(this,e):t.once("connect",()=>{setActiveUserConnected.call(this,e)})}async function setActiveUserConnected(e){const t=await getUserRelayList.call(this,e),n=[{kinds:[10006],authors:[e.pubkey]}];this.autoFetchUserMutelist&&n[0].kinds.push(1e4);const r=t?t.relaySet:void 0,s=this.subscribe(n,{subId:"active-user-settings",closeOnEose:!0},r,!1),o=new Map;s.on("event",a=>{const c=o.get(a.kind);c&&c.created_at>=a.created_at||o.set(a.kind,a)}),s.on("eose",()=>{for(const a of o.values())processEvent.call(this,a)}),s.start()}async function processEvent(e){e.kind===10006?processBlockRelayList.call(this,e):e.kind===1e4&&processMuteList.call(this,e)}function processBlockRelayList(e){const t=lists_default.from(e);for(const n of t.items)this.pool.blacklistRelayUrls.add(n[0]);debug6("Added %d relays to relay blacklist",t.items.length)}function processMuteList(e){const t=lists_default.from(e);for(const n of t.items)this.mutedIds.set(n[1],n[0]);debug6("Added %d users to mute list",t.items.length)}async function generateZapRequest(e,t,n,r,s,o,a,c,l){const u=n.callback,f=nip57_exports.makeZapRequest({profile:r,event:null,amount:s,comment:a||"",relays:o.slice(0,4)});if(e instanceof NDKEvent){const b=e.referenceTags().filter(_=>_[0]!=="p");f.tags.push(...b)}f.tags.push(["lnurl",u]);const h=new NDKEvent(t,f);return c&&(h.tags=h.tags.concat(c)),h.tags=h.tags.filter(p=>p[0]!=="p"),h.tags.push(["p",r]),await h.sign(l),h}var d3=debug7("ndk:zapper"),NDKZapper=class extends lib$1.EventEmitter{constructor(t,n,r="msat",s,o,a,c){super();m(this,"target");m(this,"ndk");m(this,"comment");m(this,"amount");m(this,"unit");m(this,"tags");m(this,"signer");m(this,"zapMethod");m(this,"onLnPay");m(this,"onCashuPay");m(this,"onComplete");m(this,"maxRelays",3);if(this.target=t,this.ndk=o||t.ndk,!this.ndk)throw new Error("No NDK instance provided");this.amount=n,this.comment=s,this.unit=r,this.tags=a,this.signer=c}async zap(){const t=this.getZapSplits(),n=new Map;return await Promise.all(t.map(async r=>{let s;try{s=await this.zapSplit(r)}catch(o){s=o}this.emit("split:complete",r,s),n.set(r,s)})),this.emit("complete",n),this.onComplete&&this.onComplete(n),n}async zapSplit(t){let n=await this.getZapMethods(this.ndk,t.pubkey),r;if(n.length===0)throw new Error("No zap method available for recipient");n=n.sort((o,a)=>o.type==="nip61"?-1:a.type==="nip61"?1:0);const s=await this.relays(t.pubkey);for(const o of n){d3("Zapping to %s with %d %s using %s",t.pubkey,t.amount,this.unit,o.type);try{switch(o.type){case"nip61":{const a=o.data;let c;if(c=await this.onCashuPay({target:this.target,comment:this.comment,tags:this.tags,recipientPubkey:t.pubkey,amount:t.amount,unit:this.unit,...a}),d3("NIP-61 Zap result: %o",c),c instanceof Error)r=c;else if(c){const{proofs:l,mint:u}=c;if(!l||!u)throw new Error("Invalid zap confirmation: missing proofs or mint: "+c);const f=NDKRelaySet.fromRelayUrls(s,this.ndk),h=new NDKNutzap(this.ndk);return h.tags=[...h.tags,...this.tags||[]],h.proofs=l,h.mint=u,h.comment=this.comment,h.unit=this.unit,h.recipientPubkey=t.pubkey,await h.sign(this.signer),await h.publish(f),h}break}case"nip57":{const a=o.data,c=await generateZapRequest(this.target,this.ndk,a,t.pubkey,t.amount,s,this.comment,this.tags,this.signer);if(!c)throw d3("Unable to generate zap request"),new Error("Unable to generate zap request");const l=await this.getLnInvoice(c,t.amount,a);if(!l)throw d3("Unable to get payment request"),new Error("Unable to get payment request");r=await this.onLnPay({target:this.target,comment:this.comment,recipientPubkey:t.pubkey,amount:t.amount,unit:this.unit,pr:l});break}}}catch(a){a instanceof Error?r=a:r=new Error(a),d3("Error zapping to %s with %d %s using %s: %o",t.pubkey,t.amount,this.unit,o.type,a)}}if(r instanceof Error)throw r;return r}async getLnInvoice(t,n,r){const s=r.callback,o=JSON.stringify(t.rawEvent());d3(`Fetching invoice from ${s}?`+new URLSearchParams({amount:n.toString(),nostr:o}));const a=new URL(s);a.searchParams.append("amount",n.toString()),a.searchParams.append("nostr",o),d3(`Fetching invoice from ${a.toString()}`);const c=await fetch(a.toString());if(d3(`Got response from zap endpoint: ${s}`,{status:c.status}),c.status!==200){d3(`Received non-200 status from zap endpoint: ${s}`,{status:c.status,amount:n,nostr:o});const u=await c.text();throw new Error(`Unable to fetch zap endpoint ${s}: ${u}`)}return(await c.json()).pr}getZapSplits(){if(this.target instanceof NDKUser)return[{pubkey:this.target.pubkey,amount:this.amount}];const t=this.target.getMatchingTags("zap");if(t.length===0)return[{pubkey:this.target.pubkey,amount:this.amount}];const n=[],r=t.reduce((s,o)=>s+parseInt(o[2]),0);for(const s of t){const o=s[1],a=Math.floor(parseInt(s[2])/r*this.amount);n.push({pubkey:o,amount:a})}return n}async getZapMethods(t,n){const r=[];r.push("nip61"),r.push("nip57");const s=t.getUser({pubkey:n}),o=await s.getZapInfo(!1,r);return d3("Zap info for %s: %o",s.npub,o),o}async relays(t){var r,s,o;let n=[];if((r=this.ndk)!=null&&r.activeUser){const a=await getRelayListForUsers([this.ndk.activeUser.pubkey,t],this.ndk),c=new Map;for(const l of a.values())for(const u of l.readRelayUrls){const f=c.get(u)||0;c.set(u,f+1)}n=Array.from(c.entries()).sort((l,u)=>u[1]-l[1]).map(([l])=>l).slice(0,this.maxRelays)}return(o=(s=this.ndk)==null?void 0:s.pool)!=null&&o.permanentAndConnectedRelays().length&&(n=this.ndk.pool.permanentAndConnectedRelays().map(a=>a.url)),n.length||(n=[]),n}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],DEFAULT_BLACKLISTED_RELAYS=["wss://brb.io/","wss://nostr.mutinywallet.com/"],NDK=class extends lib$1.EventEmitter{constructor(t={}){super();m(this,"_explicitRelayUrls");m(this,"pool");m(this,"outboxPool");m(this,"_signer");m(this,"_activeUser");m(this,"cacheAdapter");m(this,"debug");m(this,"devWriteRelaySet");m(this,"outboxTracker");m(this,"mutedIds");m(this,"clientName");m(this,"clientNip89");m(this,"queuesZapConfig");m(this,"queuesNip05");m(this,"asyncSigVerification",!1);m(this,"initialValidationRatio",1);m(this,"lowestValidationRatio",1);m(this,"validationRatioFn");m(this,"subManager");m(this,"publishingFailureHandled",!1);m(this,"relayAuthDefaultPolicy");m(this,"httpFetch");m(this,"autoConnectUserRelays",!0);m(this,"autoFetchUserMutelist",!0);m(this,"walletConfig");m(this,"fetchEventFromTag",fetchEventFromTag.bind(this));this.debug=t.debug||debug7("ndk"),this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager(this.debug),this.pool=new NDKPool(t.explicitRelayUrls||[],t.blacklistRelayUrls||DEFAULT_BLACKLISTED_RELAYS,this),this.pool.name="main",this.pool.on("relay:auth",async(n,r)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(n,r)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.autoFetchUserMutelist=t.autoFetchUserMutelist??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel&&(this.outboxPool=new NDKPool(t.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,t.blacklistRelayUrls||DEFAULT_BLACKLISTED_RELAYS,this,this.debug.extend("outbox-pool")),this.outboxPool.name="outbox",this.outboxTracker=new OutboxTracker(this)),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.mutedIds=t.mutedIds||new Map,t.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),this.signatureVerificationWorker=t.signatureVerificationWorker,this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||1;try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t,this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this.asyncSigVerification=!!t,t&&signatureVerificationInit(t)}addExplicitRelay(t,n,r=!0){let s;return typeof t=="string"?s=new NDKRelay(t,n,this):s=t,this.pool.addRelay(s,r),this.explicitRelayUrls.push(s.url),s}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){var r;const n=((r=this._activeUser)==null?void 0:r.pubkey)!==(t==null?void 0:t.pubkey);this._activeUser=t,t&&n?setActiveUser.call(this,t):t||(this.mutedIds=new Map)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t==null||t.user().then(n=>{n.ndk=this,this.activeUser=n})}async connect(t){var r,s;this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await((s=(r=this._signer).relays)==null?void 0:s.call(r,this))),this._signer.relays&&(await this._signer.relays(this)).forEach(a=>this.pool.addRelay(a)));const n=[this.pool.connect(t)];return this.outboxPool&&n.push(this.outboxPool.connect(t)),this.debug("Connecting to relays %o",{timeoutMs:t}),Promise.allSettled(n).then(()=>{})}getUser(t){const n=new NDKUser(t);return n.ndk=this,n}async getUserFromNip05(t,n=!1){return NDKUser.fromNip05(t,this,n)}subscribe(t,n,r,s=!0){var a;const o=new NDKSubscription(this,t,n,r);if(this.subManager.add(o),r)for(const c of r.relays)this.pool.useTemporaryRelay(c,void 0,o.filters);if(this.outboxPool&&o.hasAuthorsFilter()){const c=o.filters.filter(l=>{var u;return l.authors&&((u=l.authors)==null?void 0:u.length)>0}).map(l=>l.authors).flat();(a=this.outboxTracker)==null||a.trackUsers(c)}return s&&setTimeout(()=>o.start(),0),o}async publish(t,n,r){return this.debug("Deprecated: Use `event.publish()` instead"),t.publish(n,r)}async fetchEvent(t,n,r){let s,o;if(r instanceof NDKRelay?o=new NDKRelaySet(new Set([r]),this):r instanceof NDKRelaySet&&(o=r),!r&&typeof t=="string"&&!isNip33AValue(t)){const a=relaysFromBech32(t,this);a.length>0&&(o=new NDKRelaySet(new Set(a),this),o=correctRelaySet(o,this.pool))}if(typeof t=="string"?s=[filterFromId(t)]:Array.isArray(t)?s=t:s=[t],s.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise(a=>{let c=null;const l=this.subscribe(s,{...n||{},closeOnEose:!0},o,!1),u=setTimeout(()=>{l.stop(),a(c)},1e4);l.on("event",f=>{f.ndk=this,f.isReplaceable()?(!c||c.created_at<f.created_at)&&(c=f):(clearTimeout(u),a(f))}),l.on("eose",()=>{clearTimeout(u),a(c)}),l.start()})}async fetchEvents(t,n,r){return new Promise(s=>{const o=new Map,a=this.subscribe(t,{...n||{},closeOnEose:!0},r,!1),c=l=>{l instanceof NDKEvent||(l=new NDKEvent(void 0,l));const u=l.deduplicationKey(),f=o.get(u);f&&(l=dedup(f,l)),l.ndk=this,o.set(u,l)};a.on("event",c),a.on("eose",()=>{s(new Set(o.values()))}),a.start()})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}getNip96(t){return new Nip96(t,this)}async nwc(t,n=2e3){const r=await NDKNwc.fromURI(this,t);return n!==!1&&await r.blockUntilReady(n),r}zap(t,n,{comment:r,unit:s,signer:o,tags:a,onLnPay:c,onCashuPay:l,onComplete:u}){var h,p,b;o||this.assertSigner();const f=new NDKZapper(t,n,s,r,this,a,o);return c!==!1&&(f.onLnPay=c??((h=this.walletConfig)==null?void 0:h.onLnPay)),l!==!1&&(f.onCashuPay=l??((p=this.walletConfig)==null?void 0:p.onCashuPay)),f.onComplete=u??((b=this.walletConfig)==null?void 0:b.onPaymentComplete),c&&f.zap(),f}},NDKSvelte=class extends NDK{constructor(e){super(e)}createEventStore(e){const t=writable([]);return{id:Math.random().toString(36).substring(7),refCount:0,filters:e,subscription:void 0,eosed:!1,set:t.set,update:t.update,subscribe:t.subscribe,unsubscribe:()=>{},onEose:n=>{},onEvent:n=>{},startSubscription:()=>{throw new Error("not implemented")},ref:()=>{throw new Error("not implemented")},unref:()=>{throw new Error("not implemented")},empty:()=>{throw new Error("not implemented")},changeFilters:n=>{throw new Error("not implemented")}}}eventIsRepost(e){return[NDKKind.Repost,NDKKind.GenericRepost].includes(e.kind)}eventIsLabel(e){return[NDKKind.Label].includes(e.kind)}storeSubscribe(e,t,n){let r=new Map;const s=this.createEventStore(Array.isArray(e)?e:[e]),o=(t==null?void 0:t.autoStart)??!0,a=t==null?void 0:t.relaySet,c=h=>{u(h)},l=()=>Array.from(r.values()),u=h=>{const p=NDKRepost.from(h);p.ndk=this;const b=_=>{_.repostedByEvents?_.repostedByEvents.push(h):_.repostedByEvents=[h],s.set(l())};for(const _ of p.repostedEventIds()){const g=r.get(_);g?b(g):p.repostedEvents(n,{subId:"reposted-event-fetch",groupable:!0,groupableDelay:1500,groupableDelayType:"at-least"}).then(y=>{for(const w of y)w instanceof NDKEvent&&f(w)})}},f=h=>{if(t!=null&&t.repostsFilters&&this.eventIsRepost(h)){u(h);return}if(this.eventIsLabel(h)){c(h);return}let p=h;if(n){const _=n.from(h);if(!_)return;p=_,p.relay=h.relay}p.ndk=this;const b=h.deduplicationKey();if(r.has(b)){let _=r.get(b);if(_.created_at>h.created_at)return;if(_.created_at===h.created_at){if(_.id===h.id)return;console.warn("Received event with same created_at but different id",{prevId:_.id,newId:h.id,prev:_.rawEvent(),new:h.rawEvent()})}}r.set(b,p),s.set(l())};return s.ref=()=>(s.refCount++,s.refCount===1&&s.startSubscription(),s.refCount),s.unref=()=>(--s.refCount>0||(t!=null&&t.unrefUnsubscribeTimeout?setTimeout(()=>{s.refCount===0&&s.unsubscribe()},t.unrefUnsubscribeTimeout):s.unsubscribe()),s.refCount),s.empty=()=>{s.set([]),r=new Map,s.unsubscribe()},s.changeFilters=h=>{s.filters=h,s.empty(),s.refCount>0&&s.startSubscription()},s.startSubscription=()=>{if(!s.filters)throw new Error("no filters");const h=s.filters;t!=null&&t.repostsFilters&&h.push(...t.repostsFilters),s.subscription=this.subscribe(h,t,a,!1),s.subscription.on("event",(p,b)=>{f(p),t!=null&&t.onEvent&&t.onEvent(p,b)}),s.subscription.start(),s.unsubscribe=()=>{var p;(p=s.subscription)==null||p.stop(),s.subscription=void 0},s.onEose=p=>{var b;(b=s.subscription)==null||b.on("eose",()=>{s.eosed=!0,p()})},t!=null&&t.onEose&&s.onEose(t.onEose)},o&&s.startSubscription(),s}},src_default=NDKSvelte;const base_relays=["wss://relay.damus.io","wss://nos.lol","wss://relay.nostr.band","wss://purplerelay.com"],ndk=new src_default({explicitRelayUrls:[...base_relays]});ndk.connect(5e3);function _isPlaceholder$1(e){return e!=null&&typeof e=="object"&&e["@@functional/placeholder"]===!0}var _isPlaceholder_1=_isPlaceholder$1,_isPlaceholder=_isPlaceholder_1;function _curry1$1(e){return function t(n){return arguments.length===0||_isPlaceholder(n)?t:e.apply(this,arguments)}}var _curry1_1=_curry1$1;function _isString$1(e){return Object.prototype.toString.call(e)==="[object String]"}var _isString_1=_isString$1,_isString=_isString_1;function _nth$1(e,t){var n=e<0?t.length+e:e;return _isString(t)?t.charAt(n):t[n]}var _nth_1=_nth$1,_curry1=_curry1_1,_nth=_nth_1,last=_curry1(function(e){return _nth(-1,e)}),last_1=last;const last$1=getDefaultExportFromCjs(last_1),first=e=>e?e[0]:void 0,fromNostrURI=e=>e.replace(/^[\w+]+:\/?\/?/,""),urlIsMedia=e=>{var t;return!e.match(/\.(apk|docx|xlsx|csv|dmg)/)&&((t=last$1(e.split("://")))==null?void 0:t.includes("/"))||!1},isImage=e=>e.match(/^.*\.(jpg|jpeg|png|webp|gif|avif|svg)/gi),NEWLINE="newline",LINK="link",NOSTR_NPUB="nostr:npub",NOSTR_NPROFILE="nostr:nprofile",NOSTR_NOTE="nostr:note",NOSTR_NEVENT="nostr:nevent",NOSTR_NADDR="nostr:naddr",TEXT="text",isParsedNewLine=e=>e.type==NEWLINE,isParsedLink=e=>e.type==LINK,isParsedNpub=e=>e.type==NOSTR_NPUB,isParsedNprofile=e=>e.type==NOSTR_NPROFILE,isParsedNevent=e=>e.type==NOSTR_NEVENT,isParsedNote=e=>e.type==NOSTR_NOTE,isParsedNaddr=e=>e.type==NOSTR_NADDR,isParsedText=e=>e.type==TEXT,parseContent=(e,t)=>{const n=[];let r=e.trim(),s="";const o=u=>{var p,b,_,g,y,w,R;const f=t.find(S=>S[0]==="imeta"&&S.some(I=>I.includes(u)));if(!f)return;const h=f.map(S=>[S.split(" ")[0],S.substring(S.indexOf(" ")+1)]);return{url:u,m:(p=h.find(S=>S[0]==="m"))==null?void 0:p[1],alt:(b=h.find(S=>S[0]==="alt"))==null?void 0:b[1],x:(_=h.find(S=>S[0]==="x"))==null?void 0:_[1],size:(g=h.find(S=>S[0]==="size"))==null?void 0:g[1],dim:(y=h.find(S=>S[0]==="dim"))==null?void 0:y[1],blurhash:(w=h.find(S=>S[0]==="blurhash"))==null?void 0:w[1],fallback:(R=h.filter(S=>S[0]==="fallback"))==null?void 0:R.map(S=>S[1])}},a=()=>{const u=first(r.match(/^\n+/));if(u)return[u,{type:NEWLINE,value:u}]},c=()=>{const u=first(r.match(/^([a-z\+:]{2,30}:\/\/)?[^<>\(\)\s]+\.[a-z]{2,6}[^\s]*[^<>"'\.!?,:\s\)\(]/gi));if(!u)return;const f=last$1(n);if((f==null?void 0:f.type)===TEXT&&f.value.endsWith("/"))return;let h=u;if(!h.match(/\.\./))return h.match("://")||(h="https://"+h),[u,{type:LINK,url:h,is_media:urlIsMedia(h),imeta:o(h)}]},l=()=>{const u=first(r.match(/^(web\+)?(nostr:)?\/?\/?n(event|ote|profile|pub|addr)1[\d\w]+/i));if(u)try{const f=fromNostrURI(u),h=nip19_exports.decode(f);if(h.type==="npub")return[u,{type:NOSTR_NPUB,hex:h.data}];if(h.type==="nprofile")return[u,{type:NOSTR_NPUB,hex:h.data.pubkey}];if(h.type==="note")return[u,{type:NOSTR_NOTE,data:{id:h.data}}];if(h.type==="nevent")return[u,{type:NOSTR_NEVENT,data:h.data}];if(h.type==="naddr")return[u,{type:NOSTR_NADDR,data:h.data}]}catch{}};for(;r;){const u=a()||c()||l();if(u){s&&(n.push({type:TEXT,value:s}),s="");const[f,h]=u;n.push(h),r=r.slice(f.length)}else{const f=first(r.match(/^[\w\d]+ ?/i))||r[0];s+=f,r=r.slice(f.length)}}return s&&n.push({type:TEXT,value:s}),n},isCoverLetter=e=>e.indexOf("PATCH 0/")>0;function extractTagContent(e,t){const n=t.find(r=>r[0]===e);return n?n[1]:void 0}const extractPatchMessage=e=>{try{if(isCoverLetter(e))return e.substring(e.indexOf("] ")+2);const t=e.split(`
Subject: [`)[1].split("] ")[1];return t.split(`

---
 `).length>1?t.split(`

---
 `)[0]:t.split(`

diff --git `)[0].split(`

 `).slice(0,-1).join("")}catch{return}},extractIssueTitle=e=>e.tagValue("subject")||e.content.split(`
`)[0]||"",extractIssueDescription=e=>{const t=e.split(`
`);return t.length===0?"":e.substring(t[0].length)||""},reply_kind=1,proposal_status_open=1630,proposal_status_applied=1631,proposal_status_closed=1632,proposal_status_draft=1633,proposal_status_kinds=[proposal_status_open,proposal_status_applied,proposal_status_closed,proposal_status_draft];function statusKindtoText(e,t){return e===proposal_status_open?"Open":t==="proposal"&&e===proposal_status_applied?"Applied":t==="issue"&&e===proposal_status_applied?"Resolved":e===proposal_status_closed?"Closed":"Draft"}const repo_kind=30617,patch_kind=1617,issue_kind=1621,event_defaults={event_id:"",naddr:"",author:"",identifier:"",unique_commit:"",name:"",description:"",clone:[],web:[],tags:[],maintainers:[],relays:[],referenced_by:[],most_recent_reference_timestamp:0,created_at:0,loading:!0},collection_defaults={selected_a:"",most_recent_index:-1,maintainers:[],events:[],loading:!0},summary_defaults$2={name:"",identifier:"",naddr:"",unique_commit:void 0,description:"",maintainers:[{...defaults}],loading:!1,created_at:0,most_recent_reference_timestamp:0},readme_defaults={md:"",loading:!0,failed:!1},selectRepoFromCollection=e=>e.events[e.most_recent_index],cloneArrayToReadMeUrls=e=>[...e.map(extractRepoAddress).flatMap(n=>{let r="raw/HEAD";return n.includes("sr.ht")&&(r="blob/HEAD"),(n.includes("git.launchpad.net")||n.includes("git.savannah.gnu.org"))&&(r="plain"),n.includes("github.com")&&(n=n.replace("github.com","raw.githubusercontent.com"),r="HEAD"),["README.md","readme.md"].map(s=>`https://${n}/${r}/${s}`)})],extractRepoAddress=e=>{let t=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),t.endsWith(".git")&&(t=t.substring(0,t.length-4)),t.includes("://")&&(t=t.split("://")[1]),t.includes("@")&&(t=t.split("@")[1]),t=t.replace(/\s|:[0-9]+/g,""),t=t.replace(":","/"),t},naddrToPointer=e=>{const t=nip19_exports.decode(e);if(!(typeof t.data=="string"||!Object.keys(t.data).includes("identifier")))return t.data},extractAReference=e=>{if(e.split(":").length!==3)return;const[t,n,r]=e.split(":");return{kind:Number(t),pubkey:n,identifier:r}},naddrToRepoA=e=>{const t=naddrToPointer(e);if(t&&t.kind===repo_kind)return`${repo_kind}:${t.pubkey}:${t.identifier}`},aToNaddr=e=>{const t=typeof e=="string"?extractAReference(e):e;if(t)return nip19_exports.naddrEncode(t)},neventOrNoteToHexId=e=>{try{const t=nip19_exports.decode(e);if(t.type==="note")return t.data;if(t.type==="nevent")return t.data.id}catch{}},ndkEventToNeventOrNaddr=e=>{let t=[];return e.onRelays.length>0?t=e.onRelays.map(n=>n.url):e.relay&&(t=[e.relay.url]),e.kind&&e.isParamReplaceable()?nip19_exports.naddrEncode({kind:e.kind,pubkey:e.pubkey,identifier:e.replaceableDTag(),relays:t}):t.length>0?nip19_exports.neventEncode({kind:e.kind,id:e.tagId(),relays:t,author:e.pubkey}):nip19_exports.noteEncode(e.tagId())},repos={},repo_collections={},ensureRepo=(e,t=void 0)=>{if(typeof e!="string"){const n=eventToRepoEvent(e);if(n){const r=repoEventToARef(n);return repos[r]=writable({...n,loading:!0}),fetchReferencedBy(n),repos[r]}return repos[""]}if(!repos[e]){const n={...event_defaults},r=extractAReference(e);if(!r)return writable(n);const{pubkey:s,identifier:o}=r;repos[e]=writable({...n,identifier:o,author:s,naddr:aToNaddr(r)||"",maintainers:[s]});const a=ndk.subscribe({kinds:[repo_kind],"#d":[o],authors:[s]},{groupable:!0,groupableDelay:200,closeOnEose:!1},NDKRelaySet.fromRelayUrls([...base_relays,...t||[]],ndk));a.on("event",c=>{const l=eventToRepoEvent(c);l&&(o===l.identifier&&s===l.author&&repos[e].update(()=>({...l})),fetchReferencedBy(l))}),a.on("eose",()=>{repos[e].update(c=>({...c,loading:!1}))})}return setTimeout(()=>{repos[e].update(n=>({...n,loading:!1}))},5e3),repos[e]},returnRepo=async(e,t=void 0)=>new Promise(n=>{const r=ensureRepo(e,t).subscribe(s=>{s.loading||(setTimeout(()=>{r&&r()},5),n(s))})}),ensureRepoCollection=(e,t=void 0)=>{if(!repo_collections[e]){const n={...collection_defaults,selected_a:e};repo_collections[e]=writable(n);const r=extractAReference(e);if(!r)return repo_collections[e];const{pubkey:s,identifier:o}=r;returnRepo(e,t).then(async a=>{if(get_store_value(repo_collections[e]).events.length>0)return;repo_collections[e].update(u=>({...u,events:[a],maintainers:a.maintainers,most_recent_index:0}));const c=[],l=async u=>{const f=await returnRepo(`${repo_kind}:${u}:${o}`);repo_collections[e].update(h=>{f.maintainers.forEach(_=>{[s,...h.maintainers,...c].includes(_)||c.push(_)});const p=[...h.events,f],b=p.sort((_,g)=>g.created_at-_.created_at)[0];return{...h,events:p,most_recent_index:p.findIndex(_=>_.author===b.author),maintainers:[...h.maintainers,...c]}})};for(await Promise.all(a.maintainers.filter(u=>u!==s).map(u=>l(u)));c.length>0;)await Promise.all(c.map(u=>l(u)));repo_collections[e].update(u=>({...u,loading:!1}))})}return setTimeout(()=>{repo_collections[e].update(n=>({...n,loading:!1}))},5e3),repo_collections[e]},returnRepoCollection=async e=>new Promise(t=>{const n=ensureRepoCollection(e).subscribe(r=>{r.loading||(setTimeout(()=>{n&&n()},5),t(r))})}),repoEventToARef=e=>`${repo_kind}:${e.author}:${e.identifier}`,fetchReferencedBy=e=>{const t=e.relays.length<3?e.relays:[...base_relays].concat(e.relays),n=ndk.subscribe({"#a":[repoEventToARef(e)],limit:10},{groupable:!0,groupableDelay:200,closeOnEose:!0},NDKRelaySet.fromRelayUrls(t,ndk));n.on("event",r=>{repos[repoEventToARef(e)].update(s=>({...s,referenced_by:s.referenced_by.includes(r.id)?[...s.referenced_by]:[...s.referenced_by,r.id],most_recent_reference_timestamp:r.created_at&&s.most_recent_reference_timestamp<r.created_at?r.created_at:s.most_recent_reference_timestamp}))}),n.on("eose",()=>{repos[repoEventToARef(e)].update(r=>({...r,loading:!1}))})},eventToRepoEvent=e=>{if(e.kind!==repo_kind)return;const t=[e.pubkey];e.getMatchingTags("maintainers").forEach(o=>{o.forEach((a,c)=>{if(c>0&&a!==t[0])try{nip19_exports.npubEncode(a),t.push(a)}catch{}})});const n=[];e.getMatchingTags("relays").forEach(o=>{o.forEach((a,c)=>{c>0&&n.push(a)})});const r=[];e.getMatchingTags("web").forEach(o=>{o.forEach((a,c)=>{c>0&&r.push(a)})});const s=[];return e.getMatchingTags("clone").forEach(o=>{o.forEach((a,c)=>{c>0&&s.push(a)})}),{event_id:e.id,naddr:e.encode(),author:e.pubkey,identifier:e.replaceableDTag(),unique_commit:e.tagValue("r")||void 0,name:e.tagValue("name")||"",description:e.tagValue("description")||"",clone:s,web:r,tags:e.getMatchingTags("t").map(o=>o[1])||[],maintainers:t,relays:n,referenced_by:[],most_recent_reference_timestamp:e.created_at||0,created_at:e.created_at||0,loading:!0}},repoCollectionToSummary=e=>{const t=selectRepoFromCollection(e);if(t)return{name:t.name,identifier:t.identifier,naddr:t.naddr,unique_commit:t.unique_commit,description:t.description,maintainers:t.maintainers,loading:e.loading,created_at:t.created_at,most_recent_reference_timestamp:Math.max.apply(0,e.events.map(n=>n.most_recent_reference_timestamp))}},repoEventToSummary=e=>({name:e.name,identifier:e.identifier,naddr:e.naddr,unique_commit:e.unique_commit,description:e.description,maintainers:e.maintainers,loading:e.loading,created_at:e.created_at,most_recent_reference_timestamp:e.most_recent_reference_timestamp}),selected_repo_collection=writable({...collection_defaults}),selected_repo_event=writable({...event_defaults});selected_repo_collection.subscribe(e=>{const t=selectRepoFromCollection(e);t&&selected_repo_event.set({...t})});let selected_repo_a="",selected_unsubscriber;const ensureSelectedRepoCollection=(e,t=void 0)=>{if(selected_repo_a!==e){let n=!0;selected_repo_a=e,selected_unsubscriber&&selected_unsubscriber(),selected_unsubscriber=ensureRepoCollection(e,t).subscribe(r=>{if(selected_repo_collection.set({...r}),n&&!r.loading){n=!1;const s=selectRepoFromCollection(r);s&&ensureRepoReadme(s.clone,r.selected_a)}})}return selected_repo_collection},awaitSelectedRepoCollection=async e=>new Promise(t=>{const n=ensureSelectedRepoCollection(e).subscribe(r=>{selected_repo_a===e&&!r.loading&&(setTimeout(()=>{n&&n()},5),t({...r}))})}),selected_repo_readme=writable({...readme_defaults}),ensureRepoReadme=async(e,t)=>{selected_repo_readme.set({...readme_defaults});const n=(s=void 0)=>{const o=get_store_value(selected_repo_collection);[o.selected_a,o.selected_a].includes(t)&&selected_repo_readme.set({md:s||"",loading:!1,failed:!s})};let r;try{let s=cloneArrayToReadMeUrls(e);s=[...s.filter(o=>o.includes("raw.githubusercontent.com")),...s.filter(o=>!o.includes("raw.githubusercontent.com"))];for(let o=0;o<s.length;o++)try{const a=await fetch(s[o]);if(a.ok){r=await a.text();break}else continue}catch{continue}}catch{}n(r)},summary_defaults$1={type:"proposal",title:"",descritpion:"",repo_a:"",id:"",comments:0,status:void 0,status_date:0,author:{...defaults},created_at:0,loading:!0},full_defaults$1={summary:{...summary_defaults$1},proposal_event:void 0,labels:[],events:[],loading:!0},ignore_kinds=[31234,9978],selected_proposal_full=writable({...full_defaults$1});let selected_proposal_id="";const selected_proposal_replies=writable([]);let selected_proposal_status_date=0,sub$1,sub_replies$1;const sub_replies_to_replies$1=[],ensureProposalFull=(e,t)=>{const n=typeof t=="string"?t:t.id;if(selected_proposal_id!=n){if(n==""){selected_proposal_full.set({...full_defaults$1}),selected_proposal_replies.set([]);return}sub$1&&sub$1.stop(),sub_replies$1&&sub_replies$1.stop(),sub_replies_to_replies$1.forEach(r=>r.stop()),selected_proposal_id=n,selected_proposal_status_date=0,selected_proposal_replies.set([]),selected_proposal_full.set({...full_defaults$1,summary:{...full_defaults$1.summary,id:n,repo_a:e,loading:!0},loading:!0}),new Promise(async r=>{const s=await awaitSelectedRepoCollection(e),o=selectRepoFromCollection(s),a=o&&o.relays.length>3?o.relays:[...base_relays].concat(o?o.relays:[]),c=u=>{try{selected_proposal_full.update(f=>({...f,proposal_event:u,summary:{...f.summary,title:(u.tagValue("name")||u.tagValue("description")||extractPatchMessage(u.content)||"").split(`
`)[0],descritpion:u.tagValue("description")||"",created_at:u.created_at,comments:0,author:u.pubkey,loading:!1}}))}catch{}};typeof t!="string"?c(t):(sub$1=ndk.subscribe({ids:[n],limit:100},{closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk)),sub$1.on("event",u=>{u.id==n&&c(u)}),sub$1.on("eose",()=>{selected_proposal_full.update(u=>{const f={...u,summary:{...u.summary,loading:!1}};return u.loading===!1&&r({...f}),f})})),sub_replies$1=ndk.subscribe({"#e":[n]},{closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk));const l=u=>{if(u.kind&&ignore_kinds.includes(u.kind))return!1;u.kind&&proposal_status_kinds.includes(u.kind)&&u.created_at&&selected_proposal_status_date<u.created_at&&(selected_proposal_status_date=u.created_at,selected_proposal_full.update(f=>({...f,summary:{...f.summary,status:u.kind,status_date:u.created_at||0}}))),selected_proposal_replies.update(f=>{if(!f.some(h=>h.id===u.id)){const h=ndk.subscribe({"#e":[u.id]},{groupable:!0,groupableDelay:300,closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk));return h.on("event",p=>{l(p)}),sub_replies_to_replies$1.push(h),[...f,u]}return[...f]})};sub_replies$1.on("event",u=>{l(u)}),sub_replies$1.on("eose",()=>{selected_proposal_full.update(u=>{const f={...u,summary:{...u.summary,status:u.summary.status||proposal_status_open},loading:!1};return u.summary.loading===!1&&r({...f}),f})})})}},summary_defaults={type:"issue",title:"",descritpion:"",repo_a:"",id:"",comments:0,status:void 0,status_date:0,author:{...defaults},created_at:0,loading:!0},full_defaults={summary:{...summary_defaults},issue_event:void 0,labels:[],events:[],loading:!0},selected_issue_full=writable({...full_defaults});let selected_issue_id="";const selected_issue_replies=writable([]);let selected_issue_status_date=0,sub,sub_replies;const sub_replies_to_replies=[],ensureIssueFull=(e,t)=>{const n=typeof t=="string"?t:t.id;if(selected_issue_id!=n){if(n==""){selected_issue_full.set({...full_defaults}),selected_issue_replies.set([]);return}sub&&sub.stop(),sub_replies&&sub_replies.stop(),sub_replies_to_replies.forEach(r=>r.stop()),selected_issue_id=n,selected_issue_status_date=0,selected_issue_replies.set([]),selected_issue_full.set({...full_defaults,summary:{...full_defaults.summary,id:n,repo_a:e,loading:!0},loading:!0}),new Promise(async r=>{const s=await awaitSelectedRepoCollection(e),o=selectRepoFromCollection(s),a=o&&o.relays.length>3?o.relays:[...base_relays].concat(o?o.relays:[]),c=u=>{try{selected_issue_full.update(f=>({...f,issue_event:u,summary:{...f.summary,title:extractIssueTitle(u),descritpion:extractIssueDescription(u.content),created_at:u.created_at,comments:0,author:u.pubkey,loading:!1}}))}catch{}};typeof t!="string"?c(t):(sub=ndk.subscribe({ids:[n],limit:100},{closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk)),sub.on("event",u=>{u.id==n&&c(u)}),sub.on("eose",()=>{selected_issue_full.update(u=>{const f={...u,summary:{...u.summary,loading:!1}};return u.loading===!1&&r({...f}),f})})),sub_replies=ndk.subscribe({"#e":[n]},{closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk));const l=u=>{if(u.kind&&ignore_kinds.includes(u.kind))return!1;u.kind&&proposal_status_kinds.includes(u.kind)&&u.created_at&&selected_issue_status_date<u.created_at&&(selected_issue_status_date=u.created_at,selected_issue_full.update(f=>({...f,summary:{...f.summary,status:u.kind,status_date:u.created_at||0}}))),selected_issue_replies.update(f=>{if(!f.some(h=>h.id===u.id)){const h=ndk.subscribe({"#e":[u.id]},{groupable:!0,groupableDelay:300,closeOnEose:!1},NDKRelaySet.fromRelayUrls(a,ndk));return h.on("event",p=>{l(p)}),sub_replies_to_replies.push(h),[...f,u]}return[...f]})};sub_replies.on("event",u=>{l(u)}),sub_replies.on("eose",()=>{selected_issue_full.update(u=>{const f={...u,summary:{...u.summary,status:u.summary.status||proposal_status_open},loading:!1};return u.summary.loading===!1&&r({...f}),f})})})}};export{extractTagContent as $,selected_proposal_full as A,selected_proposal_replies as B,commonjsGlobal as C,getDefaultExportFromCjs as D,eventToRepoEvent as E,ensureRepoCollection as F,extractAReference as G,repoCollectionToSummary as H,NDKEvent as I,selected_repo_collection as J,event_defaults as K,awaitSelectedRepoCollection as L,selectRepoFromCollection as M,NDKRelaySet as N,summary_defaults as O,extractIssueTitle as P,extractIssueDescription as Q,proposal_status_kinds as R,getName as S,defaults as T,full_defaults$1 as U,NDKNip07Signer as V,getRelayListForUser as W,reply_kind as X,ndkEventToNeventOrNaddr as Y,extractPatchMessage as Z,returnRepoCollection as _,repo_kind as a,isCoverLetter as a0,parseContent as a1,isParsedNewLine as a2,isParsedLink as a3,isParsedNpub as a4,isParsedNprofile as a5,isParsedNevent as a6,isParsedNote as a7,isParsedNaddr as a8,isParsedText as a9,isImage as aa,selected_repo_event as b,ensureSelectedRepoCollection as c,naddrToPointer as d,ensureRepo as e,nip19_exports as f,ndk as g,base_relays as h,issue_kind as i,ensureIssueFull as j,aToNaddr as k,ensureProposalFull as l,selected_repo_readme as m,naddrToRepoA as n,proposal_status_open as o,patch_kind as p,proposal_status_applied as q,repoEventToSummary as r,summary_defaults$2 as s,proposal_status_closed as t,statusKindtoText as u,neventOrNoteToHexId as v,selected_issue_full as w,selected_issue_replies as x,proposal_status_draft as y,summary_defaults$1 as z};
